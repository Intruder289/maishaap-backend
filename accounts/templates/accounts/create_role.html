{% extends 'accounts/base.html' %}

{% block title %}Create Role{% endblock %}

{% block page_title %}Create Role{% endblock %}

{% block header_title %}Create Role{% endblock %}

{% block content %}
<div class="role-form-container">
  <!-- Messages -->
  {% if messages %}
    <div class="messages">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Header -->
  <div class="form-header">
    <h1>Create New Role</h1>
    <a href="{% url 'accounts:role_list' %}" class="back-btn btn-primary">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Back to Roles
    </a>
  </div>

  <!-- Form -->
  <form method="post" class="role-form">
    {% csrf_token %}
    
    <!-- Basic Information -->
    <div class="form-group">
      <label for="name">Role Name *</label>
      <input type="text" id="name" name="name" required maxlength="100" 
             placeholder="Enter role name (e.g., Manager, Editor, Viewer)">
    </div>
    
    <div class="form-group">
      <label for="description">Description</label>
      <textarea id="description" name="description" 
                placeholder="Describe this role and its responsibilities..."></textarea>
    </div>

    <!-- Permissions Section -->
    <div class="permissions-section">
      <div class="permissions-header">
        <h3>Permissions</h3>
        <button type="button" class="select-all-btn btn-primary" id="selectAllBtn">Select All</button>
      </div>
      
      <div class="permissions-grid" id="permissionsGrid">
        {% for permission in permissions %}
          <div class="permission-item">
            <input type="checkbox" 
                   id="perm_{{ permission.id }}" 
                   name="permissions" 
                   value="{{ permission.id }}">
            <div class="permission-info">
              <div class="permission-name">{{ permission.codename|title }}</div>
              <div class="permission-app">{{ permission.content_type.app_label|title }}</div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Navigation Bar Access Section -->
    <div class="permissions-section">
      <div class="permissions-header">
        <h3>Navigation Bar Access</h3>
        <p>
          Select which navigation tabs will be available for users assigned to this role
        </p>
        <div class="permission-controls">
          <button type="button" class="select-all-btn btn-primary" id="selectAllNavBtn">Select All Tabs</button>
          <button type="button" class="select-all-btn btn-primary" id="clearAllNavBtn">Clear All Tabs</button>
        </div>
      </div>
      
      <div class="permissions-grid" id="navigationPermissionsGrid">
        {% for nav_item in navigation_items %}
          <div class="permission-item">
            <input type="checkbox" 
                   id="nav_{{ nav_item.id }}" 
                   name="navigation_permissions" 
                   value="{{ nav_item.id }}">
            <div class="permission-info">
              <div class="permission-name">
                {% if nav_item.parent %}
                  <i class="fas fa-level-up-alt"></i>
                {% endif %}
                {{ nav_item.display_name }}
              </div>
              <div class="permission-app">
                {% if nav_item.parent %}
                  {{ nav_item.parent.display_name }}
                {% else %}
                  Main Menu
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Form Actions -->
    <div class="form-actions">
      <a href="{% url 'accounts:role_list' %}" class="btn btn-primary-cancel">Cancel</a>
      <button type="submit" class="btn btn-primary-submit">Create Role</button>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const selectAllBtn = document.getElementById('selectAllBtn');
    const permissionsGrid = document.getElementById('permissionsGrid');
    const checkboxes = permissionsGrid.querySelectorAll('input[type="checkbox"]');
    
    // Navigation Bar Access elements
    const selectAllNavBtn = document.getElementById('selectAllNavBtn');
    const clearAllNavBtn = document.getElementById('clearAllNavBtn');
    const navigationPermissionsGrid = document.getElementById('navigationPermissionsGrid');
    const navCheckboxes = navigationPermissionsGrid.querySelectorAll('input[type="checkbox"]');
    
    let allSelected = false;
    
    // Select/Deselect all functionality
    selectAllBtn.addEventListener('click', function() {
      allSelected = !allSelected;
      checkboxes.forEach(checkbox => {
        checkbox.checked = allSelected;
      });
      
      selectAllBtn.textContent = allSelected ? 'Deselect All' : 'Select All';
    });
    
    // Update select all button when individual checkboxes are changed
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const checkedCount = permissionsGrid.querySelectorAll('input[type="checkbox"]:checked').length;
        const totalCount = checkboxes.length;
        
        if (checkedCount === totalCount) {
          allSelected = true;
          selectAllBtn.textContent = 'Deselect All';
        } else {
          allSelected = false;
          selectAllBtn.textContent = 'Select All';
        }
      });
    });
    
    // Navigation Bar Access functionality
    selectAllNavBtn.addEventListener('click', function() {
      navCheckboxes.forEach(checkbox => {
        checkbox.checked = true;
      });
    });
    
    clearAllNavBtn.addEventListener('click', function() {
      navCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
      });
    });
    
    // Form validation
    const form = document.querySelector('.role-form');
    form.addEventListener('submit', function(e) {
      const nameField = document.getElementById('name');
      if (!nameField.value.trim()) {
        e.preventDefault();
        alert('Role name is required.');
        nameField.focus();
        return false;
      }
    });
  });
</script>
{% endblock %}