{% extends 'accounts/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Payment Dashboard - Maisha{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Payment Dashboard</li>
{% endblock %}

{% block content %}
<!-- ============================================-->
<!--                Page Header-->
<!-- ============================================-->
<div class="row">
  <div class="col-12">
    <div class="mb-9">
      <h2 class="mb-2">Payment Dashboard</h2>
      <p class="text-body-emphasis">Complete overview of your payment operations and financial metrics</p>
    </div>
  </div>
</div>

<!-- ============================================-->
<!--                Stats Cards-->
<!-- ============================================-->
<div class="row g-3 mb-6">
  <div class="col-6 col-lg-3">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="mb-2 text-500">Total Revenue</h6>
            <h4 class="mb-0">Tsh{{ total_revenue|default:0|floatformat:2 }}</h4>
            <p class="fs--1 mb-0 text-success">
              <span class="me-1" data-feather="trending-up"></span>
              This month
            </p>
          </div>
          <div class="d-flex align-items-center">
            <div class="avatar avatar-lg">
              <div class="avatar-name rounded-circle bg-success-subtle text-success">
                <span data-feather="dollar-sign"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-6 col-lg-3">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="mb-2 text-500">Pending Payments</h6>
            <h4 class="mb-0">{{ pending_payments|default:0 }}</h4>
            <p class="fs--1 mb-0 text-warning">
              <span class="me-1" data-feather="clock"></span>
              Awaiting payment
            </p>
          </div>
          <div class="d-flex align-items-center">
            <div class="avatar avatar-lg">
              <div class="avatar-name rounded-circle bg-warning-subtle text-warning">
                <span data-feather="clock"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-6 col-lg-3">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="mb-2 text-500">Overdue Payments</h6>
            <h4 class="mb-0">{{ overdue_payments|default:0 }}</h4>
            <p class="fs--1 mb-0 text-danger">
              <span class="me-1" data-feather="alert-triangle"></span>
              Past due date
            </p>
          </div>
          <div class="d-flex align-items-center">
            <div class="avatar avatar-lg">
              <div class="avatar-name rounded-circle bg-danger-subtle text-danger">
                <span data-feather="alert-triangle"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-6 col-lg-3">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="mb-2 text-500">Payment Rate</h6>
            <h4 class="mb-0">{{ payment_rate|default:0 }}%</h4>
            <p class="fs--1 mb-0 text-info">
              <span class="me-1" data-feather="percent"></span>
              Success rate
            </p>
          </div>
          <div class="d-flex align-items-center">
            <div class="avatar avatar-lg">
              <div class="avatar-name rounded-circle bg-info-subtle text-info">
                <span data-feather="percent"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ============================================-->
<!--                Quick Actions-->
<!-- ============================================-->
<div class="card mb-6">
  <div class="card-header">
    <h5 class="mb-0">Quick Actions</h5>
  </div>
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-4">
        <div class="d-grid">
          <a href="{% url 'payments:invoice_list' %}" class="btn btn-primary">
            <span class="fas fa-file-invoice-dollar me-2"></span>
            Manage Invoices
          </a>
        </div>
      </div>
      <div class="col-md-4">
        <div class="d-grid">
          <a href="{% url 'payments:payment_list' %}" class="btn btn-info">
            <span class="fas fa-credit-card me-2"></span>
            View Payments
          </a>
        </div>
      </div>
      <div class="col-md-4">
        <div class="d-grid">
          <button class="btn btn-success" onclick="alert('Expense tracking coming soon!')">
            <span class="fas fa-receipt me-2"></span>
            Track Expenses
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ============================================-->
<!--                Payment Methods-->
<!-- ============================================-->
<div class="row g-3 mb-6">
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header">
        <h5 class="mb-0">Payment Methods</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-6">
            <div class="d-flex align-items-center">
              <div class="avatar avatar-sm me-3">
                <div class="avatar-name rounded-circle bg-primary-subtle text-primary">
                  <span class="fas fa-credit-card"></span>
                </div>
              </div>
              <div>
                <h6 class="mb-0">Credit Card</h6>
                <small class="text-600">Online payments</small>
              </div>
            </div>
          </div>
          <div class="col-6">
            <div class="d-flex align-items-center">
              <div class="avatar avatar-sm me-3">
                <div class="avatar-name rounded-circle bg-success-subtle text-success">
                <span class="fas fa-university"></span>
                </div>
              </div>
              <div>
                <h6 class="mb-0">Bank Transfer</h6>
                <small class="text-600">Direct deposit</small>
              </div>
            </div>
          </div>
          <div class="col-6">
            <div class="d-flex align-items-center">
              <div class="avatar avatar-sm me-3">
                <div class="avatar-name rounded-circle bg-info-subtle text-info">
                  <span class="fas fa-mobile-alt"></span>
                </div>
              </div>
              <div>
                <h6 class="mb-0">Mobile Money</h6>
                <small class="text-600">M-Pesa, Airtel</small>
              </div>
            </div>
          </div>
          <div class="col-6">
            <div class="d-flex align-items-center">
              <div class="avatar avatar-sm me-3">
                <div class="avatar-name rounded-circle bg-warning-subtle text-warning">
                  <span class="fas fa-money-bill"></span>
                </div>
              </div>
              <div>
                <h6 class="mb-0">Cash</h6>
                <small class="text-600">In-person</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header">
        <div class="row flex-between-center">
          <div class="col-auto">
            <h5 class="mb-0">Recent Payments</h5>
          </div>
          <div class="col-auto">
            <div class="search-box">
              <div class="position-relative">
                <input class="form-control form-control-sm search-input" type="search" 
                       id="recent-payments-search-input"
                       placeholder="Search..." 
                       value="{{ recent_payments_search|default:'' }}">
                <span class="fas fa-search search-box-icon"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        <div id="recent-payments-table-container">
          {% include 'payments/recent_payments_table.html' %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ============================================-->
<!--                Payment Records Table-->
<!-- ============================================-->
<div class="card mb-6">
  <div class="card-header">
    <div class="row flex-between-center">
      <div class="col-auto">
        <h5 class="mb-0">Payment Records</h5>
      </div>
      <div class="col-auto">
        <div class="d-flex gap-2">
          <!-- Search -->
          <div class="search-box">
            <div class="position-relative">
              <input class="form-control search-input" type="search" 
                     id="dashboard-search-input"
                     placeholder="Search payments..." 
                     value="{{ search_query|default:'' }}">
              <span class="fas fa-search search-box-icon"></span>
            </div>
          </div>
          <!-- Status Filter -->
          <select class="form-select form-select-sm" id="dashboard-status-filter">
            <option value="">All Status</option>
            {% for value, label in status_choices %}
            <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>
              {{ label }}
            </option>
            {% endfor %}
          </select>
          <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearDashboardFilters()">
            <i class="fas fa-times"></i> Clear
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="card-body p-0">
    <div id="dashboard-table-container">
      {% include 'payments/payment_dashboard_table.html' %}
    </div>
  </div>
</div>

<!-- ============================================-->
<!--                Invoice Records Table-->
<!-- ============================================-->
<div class="card">
  <div class="card-header">
    <div class="row flex-between-center">
      <div class="col-auto">
        <h5 class="mb-0">Invoice Records</h5>
      </div>
      <div class="col-auto">
        <div class="d-flex gap-2">
          <!-- Search -->
          <div class="search-box">
            <div class="position-relative">
              <input class="form-control form-control-sm search-input" type="search" 
                     id="invoice-search-input"
                     placeholder="Search invoices..." 
                     value="{{ invoice_search_query|default:'' }}">
              <span class="fas fa-search search-box-icon"></span>
            </div>
          </div>
          <!-- Status Filter -->
          <select class="form-select form-select-sm" id="invoice-status-filter">
            <option value="">All Status</option>
            {% for value, label in invoice_status_choices %}
            <option value="{{ value }}" {% if invoice_status_filter == value %}selected{% endif %}>
              {{ label }}
            </option>
            {% endfor %}
          </select>
          <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearInvoiceFilters()">
            <i class="fas fa-times"></i> Clear
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="card-body p-0">
    <div id="invoice-table-container">
      {% include 'payments/invoice_dashboard_table.html' %}
    </div>
  </div>
</div>

<script>
// Wait for jQuery
function waitForJQuery() {
    if (typeof $ !== 'undefined') {
        initializeDashboard();
    } else {
        setTimeout(waitForJQuery, 100);
    }
}

function initializeDashboard() {
    // AJAX function to load Payment Records table
    function loadDashboardTable(page = 1) {
        var search = $('#dashboard-search-input').val() || '';
        var status = $('#dashboard-status-filter').val() || '';
        
        $('#dashboard-table-container').html('<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading...</p></div>');
        
        $.ajax({
            url: '{% url "payments:payment_dashboard" %}',
            type: 'GET',
            data: {
                'search': search,
                'status': status,
                'page': page,
                'table_type': 'payments'
            },
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(data) {
                $('#dashboard-table-container').html(data);
            },
            error: function(xhr, status, error) {
                $('#dashboard-table-container').html('<div class="text-center py-5"><p class="text-danger">Error loading data: ' + error + '</p></div>');
            }
        });
    }
    
    // AJAX function to load Recent Payments table
    function loadRecentPaymentsTable(page = 1) {
        var search = $('#recent-payments-search-input').val() || '';
        
        $('#recent-payments-table-container').html('<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary" role="status"></div></div>');
        
        $.ajax({
            url: '{% url "payments:payment_dashboard" %}',
            type: 'GET',
            data: {
                'recent_payments_search': search,
                'recent_payments_page': page,
                'table_type': 'recent_payments'
            },
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(data) {
                $('#recent-payments-table-container').html(data);
            },
            error: function(xhr, status, error) {
                $('#recent-payments-table-container').html('<div class="text-center py-3"><p class="text-danger small">Error loading data</p></div>');
            }
        });
    }
    
    // AJAX function to load Invoice Records table
    function loadInvoiceTable(page = 1) {
        var search = $('#invoice-search-input').val() || '';
        var status = $('#invoice-status-filter').val() || '';
        
        $('#invoice-table-container').html('<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading...</p></div>');
        
        $.ajax({
            url: '{% url "payments:payment_dashboard" %}',
            type: 'GET',
            data: {
                'invoice_search': search,
                'invoice_status': status,
                'invoice_page': page,
                'table_type': 'invoices'
            },
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(data) {
                $('#invoice-table-container').html(data);
            },
            error: function(xhr, status, error) {
                $('#invoice-table-container').html('<div class="text-center py-5"><p class="text-danger">Error loading data: ' + error + '</p></div>');
            }
        });
    }
    
    // Payment Records Table - Search input handler
    var searchTimeout;
    $('#dashboard-search-input').on('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            loadDashboardTable(1);
        }, 500);
    });
    
    // Payment Records Table - Status filter handler
    $('#dashboard-status-filter').on('change', function() {
        loadDashboardTable(1);
    });
    
    // Recent Payments Table - Search input handler
    var recentPaymentsSearchTimeout;
    $('#recent-payments-search-input').on('input', function() {
        clearTimeout(recentPaymentsSearchTimeout);
        recentPaymentsSearchTimeout = setTimeout(function() {
            loadRecentPaymentsTable(1);
        }, 500);
    });
    
    // Invoice Records Table - Search input handler
    var invoiceSearchTimeout;
    $('#invoice-search-input').on('input', function() {
        clearTimeout(invoiceSearchTimeout);
        invoiceSearchTimeout = setTimeout(function() {
            loadInvoiceTable(1);
        }, 500);
    });
    
    // Invoice Records Table - Status filter handler
    $('#invoice-status-filter').on('change', function() {
        loadInvoiceTable(1);
    });
    
    // Global pagination functions
    window.loadDashboardPage = function(page) {
        loadDashboardTable(page);
    };
    
    window.loadRecentPaymentsPage = function(page) {
        loadRecentPaymentsTable(page);
    };
    
    window.loadInvoicePage = function(page) {
        loadInvoiceTable(page);
    };
    
    // Clear filters functions
    window.clearDashboardFilters = function() {
        $('#dashboard-search-input').val('');
        $('#dashboard-status-filter').val('');
        loadDashboardTable(1);
    };
    
    window.clearInvoiceFilters = function() {
        $('#invoice-search-input').val('');
        $('#invoice-status-filter').val('');
        loadInvoiceTable(1);
    };
}

// Payment Action Functions
function viewPayment(paymentId) {
    $.get('/payments/api/payment/' + paymentId + '/view-details/', function(data) {
        if ($('#paymentViewModal').length === 0) {
            $('body').append('<div class="modal fade" id="paymentViewModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Payment Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="paymentViewContent"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div></div>');
        }
        $('#paymentViewContent').html(data);
        $('#paymentViewModal').modal('show');
    }).fail(function() {
        alert('Failed to load payment details.');
    });
}


function deletePayment(paymentId) {
    $.get('/payments/api/payment/' + paymentId + '/delete/', function(data) {
        if ($('#paymentDeleteModal').length === 0) {
            $('body').append('<div class="modal fade" id="paymentDeleteModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Delete Payment</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="paymentDeleteContent"></div></div></div></div>');
        }
        $('#paymentDeleteContent').html(data);
        $('#paymentDeleteModal').modal('show');
    }).fail(function() {
        alert('Failed to load delete confirmation.');
    });
}

function generateReceipt(paymentId) {
    $.get('/payments/api/payment/' + paymentId + '/generate-receipt/', function(data) {
        if ($('#paymentReceiptModal').length === 0) {
            $('body').append('<div class="modal fade" id="paymentReceiptModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Payment Receipt</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="paymentReceiptContent"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div></div>');
        }
        $('#paymentReceiptContent').html(data);
        $('#paymentReceiptModal').modal('show');
    }).fail(function() {
        alert('Failed to generate receipt.');
    });
}

function processPayment(paymentId) {
    if (confirm('Mark this payment as successful?')) {
        // TODO: Implement payment processing
        alert('Payment processing not yet implemented.');
    }
}

function viewInvoice(invoiceId) {
    window.location.href = '/payments/invoices/' + invoiceId + '/';
}

function createPayment(invoiceId) {
    window.location.href = '/payments/invoices/' + invoiceId + '/';
}

// Start initialization
waitForJQuery();
</script>
{% endblock %}