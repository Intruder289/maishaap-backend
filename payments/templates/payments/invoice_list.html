{% extends 'accounts/base.html' %}
{% load static %}
{% load humanize %}
{% load currency_filters %}

{% block title %}Invoice Management - Maisha{% endblock %}

{% block page_title %}Invoice Management{% endblock %}

{% block page_actions %}
<button class="btn btn-primary" type="button">
  <span class="fas fa-plus me-2"></span>
  Create Invoice
</button>
{% endblock %}

{% block content %}
<!-- Invoice Summary Cards -->
<div class="row g-3 mb-4">
  <div class="col-6 col-lg-3">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="mb-2 text-500">Total Invoices</h6>
            <h4 class="mb-0">{{ total_invoices|default:0 }}</h4>
            <p class="fs--1 mb-0 {% if invoices_change_percent >= 0 %}text-success{% else %}text-danger{% endif %}">
              <span class="me-1 fas fa-caret-{% if invoices_change_percent >= 0 %}up{% else %}down{% endif %}"></span>
              {% if invoices_change_percent >= 0 %}+{% endif %}{{ invoices_change_percent }}% this month
            </p>
          </div>
          <div class="d-flex align-items-center">
            <div class="avatar avatar-lg">
              <div class="avatar-name rounded-circle bg-primary-subtle text-primary">
                <span data-feather="file-text"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-6 col-lg-3">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="mb-2 text-500">Paid Invoices</h6>
            <h4 class="mb-0">{{ paid_invoices|default:0 }}</h4>
            <p class="fs--1 mb-0 text-success">
              <span class="me-1 fas fa-check-circle"></span>
              {{ payment_rate }}% payment rate
            </p>
          </div>
          <div class="d-flex align-items-center">
            <div class="avatar avatar-lg">
              <div class="avatar-name rounded-circle bg-success-subtle text-success">
                <span data-feather="check-circle"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-6 col-lg-3">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="mb-2 text-500">Unpaid Invoices</h6>
            <h4 class="mb-0">{{ unpaid_invoices|default:0 }}</h4>
            <p class="fs--1 mb-0 text-warning">
              <span class="me-1 fas fa-exclamation-triangle"></span>
              Requires follow-up
            </p>
          </div>
          <div class="d-flex align-items-center">
            <div class="avatar avatar-lg">
              <div class="avatar-name rounded-circle bg-warning-subtle text-warning">
                <span data-feather="clock"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-6 col-lg-3">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="mb-2 text-500">Outstanding Amount</h6>
            <h4 class="mb-0">{{ outstanding_amount|currency_tzs }}</h4>
            <p class="fs--1 mb-0 text-info">
              <span class="me-1 fas fa-dollar-sign"></span>
              Collection pending
            </p>
          </div>
          <div class="d-flex align-items-center">
            <div class="avatar avatar-lg">
              <div class="avatar-name rounded-circle bg-info-subtle text-info">
                <span data-feather="dollar-sign"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Invoices Table -->
<div class="card">
  <div class="card-header">
    <div class="row flex-between-center">
      <div class="col-auto">
        <h5 class="mb-0">Invoices</h5>
      </div>
      <div class="col-auto">
        <div class="d-flex align-items-center gap-2">
          <div class="input-group input-group-sm" style="width: 260px;">
            <input type="search" class="form-control" id="invoices-search-input" placeholder="Search invoices..." value="{{ search_query|default:'' }}">
            <button class="btn btn-outline-secondary" id="invoices-search-clear">Clear</button>
          </div>
          <select id="invoices-status-filter" class="form-select form-select-sm" style="width: auto;">
            <option value="">All Status</option>
            {% for value, label in status_choices %}
            <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
          <label class="form-label mb-0">Items per page:</label>
          <select class="form-select form-select-sm" id="pageSizeSelect" style="width: auto;">
            <option value="5" {% if current_page_size == 5 %}selected{% endif %}>5</option>
            <option value="10" {% if current_page_size == 10 %}selected{% endif %}>10</option>
            <option value="25" {% if current_page_size == 25 %}selected{% endif %}>25</option>
            <option value="50" {% if current_page_size == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if current_page_size == 100 %}selected{% endif %}>100</option>
          </select>
        </div>
      </div>
    </div>
  </div>
  <div class="card-body p-0">
    <div id="invoices-table-container">
      {% include 'payments/invoice_list_table.html' %}
    </div>
  </div>
</div>

<script>
// Wait for jQuery
function waitForJQuery() {
    if (typeof $ !== 'undefined') {
        initializeInvoices();
    } else {
        setTimeout(waitForJQuery, 100);
    }
}

function initializeInvoices() {
    // AJAX function to load invoices table
    function loadInvoicesTable(page = 1) {
        var search = $('#invoices-search-input').val() || '';
        var status = $('#invoices-status-filter').val() || '';
        var pageSize = $('#pageSizeSelect').val() || '5';
        
        $('#invoices-table-container').html('<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading...</p></div>');
        
        $.ajax({
            url: '{% url "payments:invoice_list" %}',
            type: 'GET',
            data: {
                'search': search,
                'status': status,
                'page': page,
                'page_size': pageSize
            },
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(data) {
                $('#invoices-table-container').html(data);
            },
            error: function(xhr, status, error) {
                $('#invoices-table-container').html('<div class="text-center py-5"><p class="text-danger">Error loading data: ' + error + '</p></div>');
            }
        });
    }
    
    // Debounced search
    var searchTimeout;
    $('#invoices-search-input').on('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            loadInvoicesTable(1);
        }, 400);
    });
    
    $('#invoices-search-clear').on('click', function() {
        $('#invoices-search-input').val('');
        loadInvoicesTable(1);
    });
    
    // Status filter handler
    $('#invoices-status-filter').on('change', function() {
        loadInvoicesTable(1);
    });
    
    // Page size change handler
    $('#pageSizeSelect').on('change', function() {
        loadInvoicesTable(1);
    });
    
    // Global pagination function
    window.loadInvoicesPage = function(page) {
        loadInvoicesTable(page);
    };
    
    // Clear filters function
    window.clearInvoicesFilters = function() {
        $('#invoices-search-input').val('');
        $('#invoices-status-filter').val('');
        $('#pageSizeSelect').val('5');
        loadInvoicesTable(1);
    };
}

// Invoice Delete Function
function deleteInvoice(invoiceId) {
    if (!confirm('Are you sure you want to delete this invoice?')) return;
    
    $.ajax({
        url: '/payments/invoices/' + invoiceId + '/delete/',
        type: 'POST',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || $('meta[name=csrf-token]').attr('content'),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            if (response.success) {
                alert(response.message || 'Invoice deleted successfully');
                location.reload();
            } else {
                alert(response.message || 'Failed to delete invoice');
            }
        },
        error: function() {
            // Try non-AJAX delete
            if (confirm('Delete this invoice?')) {
                window.location.href = '/payments/invoices/' + invoiceId + '/delete/';
            }
        }
    });
}

// Start initialization
waitForJQuery();
</script>

{% endblock %}
