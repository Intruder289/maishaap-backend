<div class="text-center">
  <div class="mb-4">
    <i class="fas fa-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
  </div>
  <h5 class="mb-3">Delete Transaction #{{ transaction.id }}?</h5>
  <p class="text-muted mb-4">
    Are you sure you want to delete this transaction? This action cannot be undone.
  </p>
  <div class="card bg-light mb-3">
    <div class="card-body text-start">
      <p class="mb-2"><strong>Transaction ID:</strong> #{{ transaction.id }}</p>
      <p class="mb-2"><strong>Payment ID:</strong> #{{ transaction.payment.id }}</p>
      <p class="mb-2"><strong>Amount:</strong> Tsh{{ transaction.payment.amount|floatformat:2 }}</p>
      <p class="mb-2"><strong>Tenant:</strong> {{ transaction.payment.tenant.get_full_name|default:transaction.payment.tenant.username }}</p>
      <p class="mb-2"><strong>Status:</strong> 
        {% if transaction.status == 'successful' %}
        <span class="badge bg-success">{{ transaction.status|title }}</span>
        {% elif transaction.status == 'pending' %}
        <span class="badge bg-warning">{{ transaction.status|title }}</span>
        {% elif transaction.status == 'failed' %}
        <span class="badge bg-danger">{{ transaction.status|title }}</span>
        {% else %}
        <span class="badge bg-secondary">{{ transaction.status|title }}</span>
        {% endif %}
      </p>
      {% if transaction.provider %}
      <p class="mb-0"><strong>Provider:</strong> {{ transaction.provider.name }}</p>
      {% endif %}
    </div>
  </div>
  <form id="transactionDeleteForm" onsubmit="confirmDeleteTransaction(event, {{ transaction.id }})">
    {% csrf_token %}
    <div class="d-flex justify-content-center gap-2">
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      <button type="submit" class="btn btn-danger">Delete Transaction</button>
    </div>
  </form>
</div>

<script>
function confirmDeleteTransaction(event, transactionId) {
    event.preventDefault();
    
    var submitBtn = $('#transactionDeleteForm button[type="submit"]');
    submitBtn.prop('disabled', true).text('Deleting...');
    
    $.ajax({
        url: '/payments/api/transaction/' + transactionId + '/delete/',
        method: 'POST',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || $('meta[name=csrf-token]').attr('content'),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            if (response.success) {
                if (typeof toastr !== 'undefined') {
                    toastr.success(response.message || 'Transaction deleted successfully');
                } else {
                    alert(response.message || 'Transaction deleted successfully');
                }
                $('#transactionDeleteModal').modal('hide');
                // Reload the transactions table
                if (typeof loadTransactionsTable === 'function') {
                    loadTransactionsTable(1);
                } else {
                    location.reload();
                }
            } else {
                var errorMsg = response.message || 'Failed to delete transaction';
                if (typeof toastr !== 'undefined') {
                    toastr.error(errorMsg);
                } else {
                    alert(errorMsg);
                }
                submitBtn.prop('disabled', false).text('Delete Transaction');
            }
        },
        error: function(xhr) {
            var errorMsg = 'Failed to delete transaction';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMsg = xhr.responseJSON.message;
            } else if (xhr.status === 403) {
                errorMsg = 'Permission denied. You do not have permission to delete transactions.';
            } else if (xhr.status === 404) {
                errorMsg = 'Transaction not found.';
            } else if (xhr.status === 500) {
                errorMsg = 'Server error. Please try again later.';
            }
            if (typeof toastr !== 'undefined') {
                toastr.error(errorMsg);
            } else {
                alert(errorMsg);
            }
            submitBtn.prop('disabled', false).text('Delete Transaction');
        }
    });
}
</script>
