{% extends 'accounts/base.html' %}
{% load static %}
{% load humanize %}
{% load currency_filters %}

{% block title %}Payments{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header">
    <div class="row flex-between-center">
      <div class="col">
        <h6 class="mb-2">Payments</h6>
        <h5 class="mb-0">Manage payment records and transactions</h5>
      </div>
      <div class="col-auto">
        <button type="button" class="btn btn-primary">
          <span class="fas fa-plus me-2"></span>Record Payment
        </button>
        <button type="button" class="btn btn-secondary ms-2" onclick="clearAllFilters()">
          <span class="fas fa-times me-2"></span>Clear All
        </button>
      </div>
    </div>
  </div>
  
  <!-- Search and Filters -->
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-4">
        <label for="search-input" class="form-label">Search</label>
        <input type="text" class="form-control" id="search-input" placeholder="Search payments...">
      </div>
      <div class="col-md-4">
        <label for="status-filter" class="form-label">Status</label>
        <select class="form-select" id="status-filter">
          <option value="">All Statuses</option>
          {% for value, display in status_choices %}
          <option value="{{ value }}">{{ display }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label for="method-filter" class="form-label">Payment Method</label>
        <select class="form-select" id="method-filter">
          <option value="">All Methods</option>
          {% for value, display in method_choices %}
          <option value="{{ value }}">{{ display }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>
  
  <div class="card-body p-0">
    <div id="table-container">
      <!-- Table will be loaded here via AJAX -->
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Payment</th>
              <th>Tenant</th>
              <th>Property</th>
              <th>Amount</th>
              <th>Method</th>
              <th>Status</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="payments-table-body">
            {% for payment in page_obj.object_list %}
            <tr data-payment-id="{{ payment.id }}">
              <td>
                <div class="d-flex align-items-center">
                  <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3 fw-bold">
                    #{{ payment.id }}
                  </div>
                  <div>
                    <strong>Payment #{{ payment.id }}</strong>
                    {% if use_rent_payments and payment.reference_number %}
                    <div class="text-muted small">Ref: {{ payment.reference_number }}</div>
                    {% elif not use_rent_payments and payment.transaction_ref %}
                    <div class="text-muted small">Ref: {{ payment.transaction_ref }}</div>
                    {% endif %}
                  </div>
                </div>
              </td>
              <td>
                <div class="d-flex align-items-center">
                  <i class="fas fa-user text-muted me-2"></i>
                  <div>
                    <div class="fw-bold">{{ payment.tenant.get_full_name|default:payment.tenant.username }}</div>
                    <div class="text-muted small">{{ payment.tenant.email }}</div>
                  </div>
                </div>
              </td>
              <td>
                <div class="d-flex align-items-center">
                  <i class="fas fa-home text-muted me-2"></i>
                  <div>
                    {% if use_rent_payments %}
                    <div class="fw-bold">{{ payment.lease.property.name }}</div>
                    <div class="text-muted small">{{ payment.lease.property.address|truncatechars:30 }}</div>
                    {% else %}
                    <div class="fw-bold">N/A</div>
                    <div class="text-muted small">Property info not available</div>
                    {% endif %}
                  </div>
                </div>
              </td>
              <td>
                <span class="fw-bold text-success">Tsh{{ payment.amount|floatformat:2 }}</span>
              </td>
              <td>
                {% if payment.payment_method == 'cash' %}
                <span class="badge bg-success">{{ payment.get_payment_method_display }}</span>
                {% elif payment.payment_method == 'online' %}
                <span class="badge bg-info">{{ payment.get_payment_method_display }}</span>
                {% elif payment.payment_method == 'mobile_money' %}
                <span class="badge bg-warning">{{ payment.get_payment_method_display }}</span>
                {% elif payment.payment_method == 'online' %}
                <span class="badge bg-primary">{{ payment.get_payment_method_display }}</span>
                {% else %}
                <span class="badge bg-secondary">{{ payment.get_payment_method_display }}</span>
                {% endif %}
              </td>
              <td>
                {% if payment.status == 'completed' %}
                <span class="badge bg-success">{{ payment.get_status_display }}</span>
                {% elif payment.status == 'pending' %}
                <span class="badge bg-warning">{{ payment.get_status_display }}</span>
                {% elif payment.status == 'failed' %}
                <span class="badge bg-danger">{{ payment.get_status_display }}</span>
                {% elif payment.status == 'cancelled' %}
                <span class="badge bg-secondary">{{ payment.get_status_display }}</span>
                {% else %}
                <span class="badge bg-info">{{ payment.get_status_display }}</span>
                {% endif %}
              </td>
              <td>
                <div class="text-muted small">
                  {% if use_rent_payments %}
                  {{ payment.payment_date|date:"M d, Y" }}<br>
                  {{ payment.created_at|time:"g:i A" }}
                  {% else %}
                  {{ payment.paid_date|date:"M d, Y"|default:"N/A" }}<br>
                  {{ payment.created_at|time:"g:i A" }}
                  {% endif %}
                </div>
              </td>
              <td>
                <div class="dropdown">
                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-ellipsis-v"></i>
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="openPaymentViewModal({{ payment.id }}); return false;">
                      <i class="fas fa-eye me-2"></i>View Details
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="openPaymentReceiptModal({{ payment.id }}); return false;">
                      <i class="fas fa-receipt me-2"></i>Generate Receipt
                    </a></li>
                    {% if payment.status == 'pending' %}
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="deletePaymentFromList({{ payment.id }}); return false;">
                      <i class="fas fa-trash me-2"></i>Delete Payment
                    </a></li>
                    {% endif %}
                  </ul>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" class="text-center py-4">
                <div class="text-muted">
                  <i class="fas fa-credit-card fa-2x mb-3"></i>
                  <p>No payments found.</p>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      <!-- Pagination -->
      {% if page_obj.has_other_pages %}
      <div class="card-footer bg-white border-0 py-3">
        <div class="row align-items-center">
          <div class="col-md-6">
            <div class="text-muted">
              Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} entries
            </div>
          </div>
          <div class="col-md-6">
            <nav aria-label="Page navigation" class="d-flex justify-content-end">
              <ul class="pagination pagination-sm mb-0">
                {% if page_obj.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="#" onclick="loadPage(1); return false;" title="First Page">
                    <i class="fas fa-angle-double-left"></i>
                  </a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="#" onclick="loadPage({{ page_obj.previous_page_number }}); return false;" title="Previous Page">
                    <i class="fas fa-angle-left"></i>
                  </a>
                </li>
                {% endif %}

                <!-- Page numbers -->
                {% for num in page_obj.paginator.page_range %}
                  {% if page_obj.number == num %}
                  <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                  </li>
                  {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                  <li class="page-item">
                    <a class="page-link" href="#" onclick="loadPage({{ num }}); return false;">{{ num }}</a>
                  </li>
                  {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <li class="page-item">
                  <a class="page-link" href="#" onclick="loadPage({{ page_obj.next_page_number }}); return false;" title="Next Page">
                    <i class="fas fa-angle-right"></i>
                  </a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="#" onclick="loadPage({{ page_obj.paginator.num_pages }}); return false;" title="Last Page">
                    <i class="fas fa-angle-double-right"></i>
                  </a>
                </li>
                {% endif %}
              </ul>
            </nav>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Payment Summary Cards -->
<div class="row g-3 mt-4">
  <div class="col-6 col-lg-3">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="mb-2 text-500">Total Payments</h6>
            <h4 class="mb-0">{{ total_payments }}</h4>
            <p class="fs--1 mb-0 {% if payments_change_percent >= 0 %}text-success{% else %}text-danger{% endif %}">
              <span class="me-1 fas fa-caret-{% if payments_change_percent >= 0 %}up{% else %}down{% endif %}"></span>
              {% if payments_change_percent >= 0 %}+{% endif %}{{ payments_change_percent }}%
            </p>
          </div>
          <div class="d-flex align-items-center">
            <div class="avatar avatar-lg">
              <div class="avatar-name rounded-circle bg-success-subtle text-success">
                <span class="fas fa-dollar-sign"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-6 col-lg-3">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="mb-2 text-500">Total Revenue</h6>
            <h4 class="mb-0">Tsh{{ total_revenue|floatformat:2 }}</h4>
            <p class="fs--1 mb-0 {% if revenue_change_percent >= 0 %}text-success{% else %}text-danger{% endif %}">
              <span class="me-1 fas fa-caret-{% if revenue_change_percent >= 0 %}up{% else %}down{% endif %}"></span>
              {% if revenue_change_percent >= 0 %}+{% endif %}{{ revenue_change_percent }}%
            </p>
          </div>
          <div class="d-flex align-items-center">
            <div class="avatar avatar-lg">
              <div class="avatar-name rounded-circle bg-primary-subtle text-primary">
                <span class="fas fa-chart-line"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-6 col-lg-3">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="mb-2 text-500">Pending</h6>
            <h4 class="mb-0">{{ pending_payments }}</h4>
            <p class="fs--1 mb-0 text-warning">
              <span class="me-1 fas fa-exclamation-triangle"></span>
              {{ pending_payments }} payments
            </p>
          </div>
          <div class="d-flex align-items-center">
            <div class="avatar avatar-lg">
              <div class="avatar-name rounded-circle bg-warning-subtle text-warning">
                <span class="fas fa-clock"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-6 col-lg-3">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="mb-2 text-500">Success Rate</h6>
            <h4 class="mb-0">{{ success_rate }}%</h4>
            <p class="fs--1 mb-0 {% if success_rate >= 90 %}text-success{% elif success_rate >= 70 %}text-info{% elif success_rate >= 50 %}text-warning{% else %}text-danger{% endif %}">
              <span class="me-1 fas fa-{% if success_rate >= 70 %}check-circle{% else %}exclamation-circle{% endif %}"></span>
              {{ success_status }}
            </p>
          </div>
          <div class="d-flex align-items-center">
            <div class="avatar avatar-lg">
              <div class="avatar-name rounded-circle bg-info-subtle text-info">
                <span class="fas fa-trending-up"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Wait for jQuery to be available
function waitForJQuery() {
    if (typeof $ !== 'undefined') {
        initializePaymentsPage();
    } else {
        setTimeout(waitForJQuery, 100);
    }
}

function initializePaymentsPage() {
    console.log('=== PAYMENTS PAGE LOADED ===');
    
    // AJAX function to load filtered table
    function loadTable(page = 1) {
        var search = $('#search-input').val() || '';
        var status = $('#status-filter').val() || '';
        var method = $('#method-filter').val() || '';
        
        console.log('=== LOADING PAYMENTS TABLE ===');
        console.log('Search:', search);
        console.log('Status:', status);
        console.log('Method:', method);
        console.log('Page:', page);
        
        // Show loading
        $('#table-container').html('<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading...</p></div>');
        
        $.ajax({
            url: '{% url "payments:payment_list" %}',
            type: 'GET',
            data: {
                'search': search,
                'status': status,
                'method': method,
                'page': page
            },
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(data) {
                console.log('=== AJAX SUCCESS ===');
                console.log('Data length:', data.length);
                console.log('Data preview:', data.substring(0, 200));
                
                // Replace the table container with the new HTML
                $('#table-container').html(data);
                
                console.log('Payments table updated successfully');
            },
            error: function(xhr, status, error) {
                console.log('=== AJAX ERROR ===');
                console.log('Error:', error);
                console.log('Status:', status);
                console.log('Response:', xhr.responseText);
                
                $('#table-container').html('<div class="text-center py-5"><p class="text-danger">Error loading data: ' + error + '</p><button class="btn btn-primary" onclick="location.reload()">Refresh Page</button></div>');
            }
        });
    }
    
    // Search input handler
    var searchTimeout;
    $('#search-input').on('input', function() {
        var searchValue = $(this).val();
        console.log('Search input changed:', searchValue);
        
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            console.log('Search timeout triggered');
            loadTable(1);
        }, 500);
    });
    
    // Filter change handlers
    $('#status-filter').on('change', function() {
        var statusValue = $(this).val();
        console.log('Status filter changed:', statusValue);
        loadTable(1);
    });
    
    $('#method-filter').on('change', function() {
        var methodValue = $(this).val();
        console.log('Method filter changed:', methodValue);
        loadTable(1);
    });
    
    // Handle search clear
    $('#search-input').on('keyup', function() {
        var searchValue = $(this).val();
        if (searchValue === '') {
            console.log('Search cleared - resetting filters');
            $('#status-filter').val('');
            $('#method-filter').val('');
            loadTable(1);
        }
    });
    
    // Global functions for pagination
    window.loadPage = function(page) {
        console.log('Loading page:', page);
        loadTable(page);
    };
    
    // Clear all filters function
    window.clearAllFilters = function() {
        console.log('=== CLEARING ALL FILTERS ===');
        $('#search-input').val('');
        $('#status-filter').val('');
        $('#method-filter').val('');
        loadTable(1);
    };
    
    console.log('=== JAVASCRIPT LOADED SUCCESSFULLY ===');
}

// Payment Modal Functions
window.openPaymentViewModal = function(paymentId) {
    viewPayment(paymentId);
};

window.openPaymentReceiptModal = function(paymentId) {
    generateReceipt(paymentId);
};

// Payment Action Functions
function viewPayment(paymentId) {
    $.get('/payments/api/payment/' + paymentId + '/view-details/', function(data) {
        if ($('#paymentViewModal').length === 0) {
            $('body').append('<div class="modal fade" id="paymentViewModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Payment Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="paymentViewContent"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div></div>');
        }
        $('#paymentViewContent').html(data);
        $('#paymentViewModal').modal('show');
    }).fail(function() {
        alert('Failed to load payment details.');
    });
}


function generateReceipt(paymentId) {
    $.get('/payments/api/payment/' + paymentId + '/generate-receipt/', function(data) {
        if ($('#paymentReceiptModal').length === 0) {
            $('body').append('<div class="modal fade" id="paymentReceiptModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Payment Receipt</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="paymentReceiptContent"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div></div>');
        }
        $('#paymentReceiptContent').html(data);
        $('#paymentReceiptModal').modal('show');
    }).fail(function() {
        alert('Failed to generate receipt.');
    });
}

// Delete payment function
function deletePaymentFromList(paymentId) {
    if (!confirm('Are you sure you want to delete this payment?')) return;
    
    $.get('/payments/api/payment/' + paymentId + '/delete/', function(data) {
        if ($('#paymentDeleteModal').length === 0) {
            $('body').append('<div class="modal fade" id="paymentDeleteModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Delete Payment</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="paymentDeleteContent"></div></div></div></div>');
        }
        $('#paymentDeleteContent').html(data);
        $('#paymentDeleteModal').modal('show');
    }).fail(function() {
        alert('Failed to load delete confirmation.');
    });
}

// Start the initialization
waitForJQuery();
</script>
{% endblock %}