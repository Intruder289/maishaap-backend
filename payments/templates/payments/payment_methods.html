{% extends "accounts/base.html" %}
{% load static %}
{% load humanize %}
{% load currency_filters %}

{% block title %}Payment Methods - Maisha{% endblock %}

{% block page_title %}Payment Methods{% endblock %}

{% block page_actions %}
<button class="btn btn-primary" type="button">
  <span class="fas fa-plus me-2"></span>
  Add Payment Method
</button>
{% endblock %}

{% block content %}
<!-- Payment Methods Stats Cards -->
<div class="row g-3 mb-6">
  <div class="col-6 col-lg-3">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="mb-2 text-500">Total Providers</h6>
            <h4 class="mb-0">{{ total_providers }}</h4>
            <p class="fs--1 mb-0 text-info">
              <span class="me-1 fas fa-credit-card"></span>
              Payment providers
            </p>
          </div>
          <div class="d-flex align-items-center">
            <div class="avatar avatar-lg">
              <div class="avatar-name rounded-circle bg-primary-subtle text-primary">
                <span data-feather="credit-card"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-6 col-lg-3">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="mb-2 text-500">Active Providers</h6>
            <h4 class="mb-0">{{ active_providers }}</h4>
            <p class="fs--1 mb-0 text-success">
              <span class="me-1 fas fa-check-circle"></span>
              Currently active
            </p>
          </div>
          <div class="d-flex align-items-center">
            <div class="avatar avatar-lg">
              <div class="avatar-name rounded-circle bg-success-subtle text-success">
                <span data-feather="check-circle"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-6 col-lg-3">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="mb-2 text-500">Inactive Providers</h6>
            <h4 class="mb-0">{{ inactive_providers }}</h4>
            <p class="fs--1 mb-0 text-warning">
              <span class="me-1 fas fa-pause-circle"></span>
              Temporarily disabled
            </p>
          </div>
          <div class="d-flex align-items-center">
            <div class="avatar avatar-lg">
              <div class="avatar-name rounded-circle bg-warning-subtle text-warning">
                <span data-feather="pause-circle"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-6 col-lg-3">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="mb-2 text-500">Success Rate</h6>
            <h4 class="mb-0">{{ success_rate }}%</h4>
            <p class="fs--1 mb-0 {% if success_rate >= 90 %}text-success{% elif success_rate >= 70 %}text-info{% elif success_rate >= 50 %}text-warning{% else %}text-danger{% endif %}">
              <span class="me-1 fas fa-trending-{% if success_rate >= 70 %}up{% else %}down{% endif %}"></span>
              {{ success_status }}
            </p>
          </div>
          <div class="d-flex align-items-center">
            <div class="avatar avatar-lg">
              <div class="avatar-name rounded-circle bg-info-subtle text-info">
                <span data-feather="trending-up"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Payment Providers Table -->
<div class="card">
  <div class="card-header">
    <div class="row flex-between-center">
      <div class="col-auto">
        <h5 class="mb-0">Payment Providers</h5>
      </div>
      <div class="col-auto">
        <div class="d-flex align-items-center gap-2">
          <div class="input-group input-group-sm" style="width: 260px;">
            <input type="search" class="form-control" id="providers-search-input" placeholder="Search providers..." value="{{ provider_search|default:'' }}">
            <button class="btn btn-outline-secondary" id="providers-search-clear">Clear</button>
          </div>
          <select id="providers-status-filter" class="form-select form-select-sm" style="width: auto;">
            <option value="">All Status</option>
            <option value="active" {% if provider_status == 'active' %}selected{% endif %}>Active</option>
            <option value="inactive" {% if provider_status == 'inactive' %}selected{% endif %}>Inactive</option>
          </select>
          <label class="form-label mb-0">Items per page:</label>
          <select class="form-select form-select-sm" id="providerPageSizeSelect" style="width: auto;">
            <option value="5" {% if provider_current_page_size == 5 %}selected{% endif %}>5</option>
            <option value="10" {% if provider_current_page_size == 10 %}selected{% endif %}>10</option>
            <option value="25" {% if provider_current_page_size == 25 %}selected{% endif %}>25</option>
            <option value="50" {% if provider_current_page_size == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if provider_current_page_size == 100 %}selected{% endif %}>100</option>
          </select>
        </div>
      </div>
    </div>
  </div>
  
  <div class="card-body p-0">
    <div id="providers-table-container">
      {% include 'payments/payment_methods_providers_table.html' %}
    </div>
  </div>
</div>

<!-- Transactions Table -->
<div class="row g-3 mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <div class="row flex-between-center">
          <div class="col-auto">
            <h5 class="mb-0">Transactions</h5>
          </div>
          <div class="col-auto">
            <div class="d-flex align-items-center gap-2">
              <div class="input-group input-group-sm" style="width: 260px;">
                <input type="search" class="form-control" id="methods-transactions-search" placeholder="Search transactions..." value="{{ search_query|default:'' }}">
                <button class="btn btn-outline-secondary" id="methods-transactions-search-clear">Clear</button>
              </div>
              <select id="methods-transactions-status" class="form-select form-select-sm" style="width: auto;">
                <option value="">All Status</option>
                {% for value, label in status_choices %}
                <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
              <select id="methods-transactions-provider" class="form-select form-select-sm" style="width: auto;">
                <option value="">All Providers</option>
                {% for provider in providers %}
                <option value="{{ provider.id }}" {% if provider_filter == provider.id|stringformat:"s" %}selected{% endif %}>{{ provider.name }}</option>
                {% endfor %}
              </select>
              <label class="form-label mb-0">Items per page:</label>
              <select class="form-select form-select-sm" id="transactionPageSizeSelect" style="width: auto;">
                <option value="5" {% if transaction_current_page_size == 5 %}selected{% endif %}>5</option>
                <option value="10" {% if transaction_current_page_size == 10 %}selected{% endif %}>10</option>
                <option value="25" {% if transaction_current_page_size == 25 %}selected{% endif %}>25</option>
                <option value="50" {% if transaction_current_page_size == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if transaction_current_page_size == 100 %}selected{% endif %}>100</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div id="methods-transactions-container">
          {% include 'payments/payment_methods_transactions_table.html' %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Wait for jQuery
function waitForJQuery() {
    if (typeof $ !== 'undefined') {
        initializeMethodsTransactions();
        initializeProviders();
    } else {
        setTimeout(waitForJQuery, 100);
    }
}

function initializeMethodsTransactions() {
    // AJAX function to load transactions table
    function loadMethodsTransactionsTable(page = 1) {
        var search = $('#methods-transactions-search').val() || '';
        var status = $('#methods-transactions-status').val() || '';
        var provider = $('#methods-transactions-provider').val() || '';
        var pageSize = $('#transactionPageSizeSelect').val() || '5';
        
        $('#methods-transactions-container').html('<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading...</p></div>');
        
        $.ajax({
            url: '{% url "payments:payment_methods" %}',
            type: 'GET',
            data: {
                'search': search,
                'status': status,
                'provider': provider,
                'page': page,
                'transaction_page_size': pageSize,
                'table': 'transactions'
            },
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(data) {
                $('#methods-transactions-container').html(data);
            },
            error: function(xhr, status, error) {
                $('#methods-transactions-container').html('<div class="text-center py-5"><p class="text-danger">Error loading data: ' + error + '</p></div>');
            }
        });
    }
    
    // Debounced search
    var searchTimeout;
    $('#methods-transactions-search').on('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            loadMethodsTransactionsTable(1);
        }, 400);
    });
    
    $('#methods-transactions-search-clear').on('click', function() {
        $('#methods-transactions-search').val('');
        loadMethodsTransactionsTable(1);
    });
    
    // Filter change handlers
    $('#methods-transactions-status').on('change', function() {
        loadMethodsTransactionsTable(1);
    });
    
    $('#methods-transactions-provider').on('change', function() {
        loadMethodsTransactionsTable(1);
    });
    
    // Page size change handler
    $('#transactionPageSizeSelect').on('change', function() {
        loadMethodsTransactionsTable(1);
    });
    
    // Global pagination function
    window.loadMethodsTransactionsPage = function(page) {
        loadMethodsTransactionsTable(page);
    };
    
    // Clear filters function
    window.clearMethodsFilters = function() {
        $('#methods-transactions-search').val('');
        $('#methods-transactions-status').val('');
        $('#methods-transactions-provider').val('');
        $('#transactionPageSizeSelect').val('5');
        loadMethodsTransactionsTable(1);
    };
}

// Transaction Action Functions
function viewTransaction(transactionId) {
    $.get('/payments/api/transaction/' + transactionId + '/view-details/', function(data) {
        if ($('#transactionViewModal').length === 0) {
            $('body').append('<div class="modal fade" id="transactionViewModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Transaction Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="transactionViewContent"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div></div>');
        }
        $('#transactionViewContent').html(data);
        $('#transactionViewModal').modal('show');
    }).fail(function() {
        alert('Failed to load transaction details.');
    });
}

// Payment Action Functions
function viewPayment(paymentId) {
    $.get('/payments/api/payment/' + paymentId + '/view-details/', function(data) {
        if ($('#paymentViewModal').length === 0) {
            $('body').append('<div class="modal fade" id="paymentViewModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Payment Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="paymentViewContent"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div></div>');
        }
        $('#paymentViewContent').html(data);
        $('#paymentViewModal').modal('show');
    }).fail(function() {
        alert('Failed to load payment details.');
    });
}

// Provider Action Functions
function viewProvider(providerId) {
    $.get('/payments/api/provider/' + providerId + '/view-details/', function(data) {
        if ($('#providerViewModal').length === 0) {
            $('body').append('<div class="modal fade" id="providerViewModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Provider Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="providerViewContent"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div></div>');
        }
        $('#providerViewContent').html(data);
        $('#providerViewModal').modal('show');
    }).fail(function() {
        alert('Failed to load provider details.');
    });
}

function editProvider(providerId) {
    $.get('/payments/api/provider/' + providerId + '/edit/', function(data) {
        if ($('#providerEditModal').length === 0) {
            $('body').append('<div class="modal fade" id="providerEditModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Edit Provider</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="providerEditContent"></div></div></div></div>');
        }
        $('#providerEditContent').html(data);
        $('#providerEditModal').modal('show');
    }).fail(function() {
        alert('Failed to load provider edit form.');
    });
}

function toggleProviderStatus(providerId) {
    var action = confirm('Are you sure you want to change this provider\'s status?');
    if (!action) return;
    
    $.ajax({
        url: '/payments/api/provider/' + providerId + '/toggle-status/',
        method: 'POST',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || $('meta[name=csrf-token]').attr('content') || getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            if (response.success) {
                alert(response.message);
                // Reload providers table
                if (typeof loadProvidersTable === 'function') {
                    loadProvidersTable(1);
                } else {
                    location.reload();
                }
            } else {
                alert('Failed: ' + (response.message || 'Unknown error'));
            }
        },
        error: function(xhr) {
            var errorMsg = 'Failed to update provider status';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMsg = xhr.responseJSON.message;
            }
            alert(errorMsg);
        }
    });
}

// Initialize Providers Table
function initializeProviders() {
    // AJAX function to load providers table
    function loadProvidersTable(page = 1) {
        var search = $('#providers-search-input').val() || '';
        var status = $('#providers-status-filter').val() || '';
        var pageSize = $('#providerPageSizeSelect').val() || '5';
        
        $('#providers-table-container').html('<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading...</p></div>');
        
        $.ajax({
            url: '{% url "payments:payment_methods" %}',
            type: 'GET',
            data: {
                'provider_search': search,
                'provider_status': status,
                'provider_page': page,
                'provider_page_size': pageSize,
                'table': 'providers'
            },
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(data) {
                $('#providers-table-container').html(data);
            },
            error: function(xhr, status, error) {
                $('#providers-table-container').html('<div class="text-center py-5"><p class="text-danger">Error loading data: ' + error + '</p></div>');
            }
        });
    }
    
    // Debounced search
    var searchTimeout;
    $('#providers-search-input').on('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            loadProvidersTable(1);
        }, 400);
    });
    
    $('#providers-search-clear').on('click', function() {
        $('#providers-search-input').val('');
        loadProvidersTable(1);
    });
    
    // Status filter handler
    $('#providers-status-filter').on('change', function() {
        loadProvidersTable(1);
    });
    
    // Page size change handler
    $('#providerPageSizeSelect').on('change', function() {
        loadProvidersTable(1);
    });
    
    // Global pagination function
    window.loadProvidersPage = function(page) {
        loadProvidersTable(page);
    };
    
    // Clear filters function
    window.clearProvidersFilters = function() {
        $('#providers-search-input').val('');
        $('#providers-status-filter').val('');
        $('#providerPageSizeSelect').val('5');
        loadProvidersTable(1);
    };
}

// Helper function to get CSRF token from cookies
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Start initialization
waitForJQuery();
</script>
{% endblock %}

