{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}Payment Transactions{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card mb-3">
        <div class="card-header">
          <div class="row flex-between-center">
            <div class="col-auto">
              <h5 class="mb-0">Payment Transactions</h5>
            </div>
            <div class="col-auto">
              <div class="d-flex align-items-center gap-2">
                <div class="input-group input-group-sm" style="width: 260px;">
                  <input type="search" class="form-control" id="transactions-search-input" placeholder="Search transactions..." value="{{ search_query|default:'' }}">
                  <button class="btn btn-outline-secondary" id="transactions-search-clear">Clear</button>
                </div>
                <select id="transactions-status-filter" class="form-select form-select-sm" style="width: auto;">
                  <option value="">All Status</option>
                  {% for value, label in status_choices %}
                  <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
                <select id="transactions-provider-filter" class="form-select form-select-sm" style="width: auto;">
                  <option value="">All Providers</option>
                  {% for provider in providers %}
                  <option value="{{ provider.id }}" {% if provider_filter == provider.id|stringformat:"s" %}selected{% endif %}>{{ provider.name }}</option>
                  {% endfor %}
                </select>
                <label class="form-label mb-0">Items per page:</label>
                <select class="form-select form-select-sm" id="pageSizeSelect" style="width: auto;">
                  <option value="5" {% if current_page_size == 5 %}selected{% endif %}>5</option>
                  <option value="10" {% if current_page_size == 10 %}selected{% endif %}>10</option>
                  <option value="25" {% if current_page_size == 25 %}selected{% endif %}>25</option>
                  <option value="50" {% if current_page_size == 50 %}selected{% endif %}>50</option>
                  <option value="100" {% if current_page_size == 100 %}selected{% endif %}>100</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="card-body p-0">

          <!-- Transactions Table -->
          <div id="transactions-table-container">
            {% include 'payments/payment_transactions_table.html' %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Wait for jQuery
function waitForJQuery() {
    if (typeof $ !== 'undefined') {
        initializeTransactions();
    } else {
        setTimeout(waitForJQuery, 100);
    }
}

function initializeTransactions() {
    // AJAX function to load transactions table
    function loadTransactionsTable(page = 1) {
        var search = $('#transactions-search-input').val() || '';
        var status = $('#transactions-status-filter').val() || '';
        var provider = $('#transactions-provider-filter').val() || '';
        var pageSize = $('#pageSizeSelect').val() || '5';
        
        $('#transactions-table-container').html('<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading...</p></div>');
        
        $.ajax({
            url: '{% url "payments:payment_transactions" %}',
            type: 'GET',
            data: {
                'search': search,
                'status': status,
                'provider': provider,
                'page': page,
                'page_size': pageSize
            },
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(data) {
                $('#transactions-table-container').html(data);
                // Initialize Bootstrap tooltips for truncated text
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
                // Initialize Bootstrap dropdowns
                var dropdownElementList = [].slice.call(document.querySelectorAll('#transactions-table-container .dropdown-toggle'));
                dropdownElementList.map(function (dropdownToggleEl) {
                    return new bootstrap.Dropdown(dropdownToggleEl);
                });
            },
            error: function(xhr, status, error) {
                $('#transactions-table-container').html('<div class="text-center py-5"><p class="text-danger">Error loading data: ' + error + '</p></div>');
            }
        });
    }
    
    // Debounced search
    var searchTimeout;
    $('#transactions-search-input').on('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            loadTransactionsTable(1);
        }, 400);
    });
    
    $('#transactions-search-clear').on('click', function() {
        $('#transactions-search-input').val('');
        loadTransactionsTable(1);
    });
    
    // Filter change handlers
    $('#transactions-status-filter').on('change', function() {
        loadTransactionsTable(1);
    });
    
    $('#transactions-provider-filter').on('change', function() {
        loadTransactionsTable(1);
    });
    
    // Page size change handler
    $('#pageSizeSelect').on('change', function() {
        loadTransactionsTable(1);
    });
    
    // Global pagination function
    window.loadTransactionsPage = function(page) {
        loadTransactionsTable(page);
    };
    
    // Clear filters function
    window.clearTransactionsFilters = function() {
        $('#transactions-search-input').val('');
        $('#transactions-status-filter').val('');
        $('#transactions-provider-filter').val('');
        $('#pageSizeSelect').val('5');
        loadTransactionsTable(1);
    };
}

// Transaction Action Functions
function viewTransaction(transactionId) {
    $.get('/payments/api/transaction/' + transactionId + '/view-details/', function(data) {
        if ($('#transactionViewModal').length === 0) {
            $('body').append('<div class="modal fade" id="transactionViewModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Transaction Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="transactionViewContent"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div></div>');
        }
        $('#transactionViewContent').html(data);
        var modal = new bootstrap.Modal(document.getElementById('transactionViewModal'));
        modal.show();
    }).fail(function() {
        if (typeof toastr !== 'undefined') {
            toastr.error('Failed to load transaction details.');
        } else {
            alert('Failed to load transaction details.');
        }
    });
}

function deleteTransaction(transactionId) {
    $.get('/payments/api/transaction/' + transactionId + '/delete/', function(data) {
        if ($('#transactionDeleteModal').length === 0) {
            $('body').append('<div class="modal fade" id="transactionDeleteModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Delete Transaction</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="transactionDeleteContent"></div></div></div></div>');
        }
        $('#transactionDeleteContent').html(data);
        var modal = new bootstrap.Modal(document.getElementById('transactionDeleteModal'));
        modal.show();
    }).fail(function() {
        if (typeof toastr !== 'undefined') {
            toastr.error('Failed to load delete confirmation.');
        } else {
            alert('Failed to load delete confirmation.');
        }
    });
}

function verifyTransaction(transactionId) {
    if (!confirm('Verify transaction status with payment gateway?')) return;
    
    // Find the button that was clicked
    var btn = null;
    var originalText = '';
    
    // Try to find the button from the event or by searching
    if (typeof event !== 'undefined' && event.target) {
        btn = $(event.target).closest('.dropdown-item')[0];
    }
    
    if (btn) {
        originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Verifying...';
        btn.style.pointerEvents = 'none';
    }
    
    // Show loading indicator
    var loadingMsg = $('<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Verifying transaction with payment gateway...</div>');
    if ($('#transactions-table-container').length) {
        $('#transactions-table-container').prepend(loadingMsg);
    }
    
    // Initialize Bootstrap tooltips for truncated text
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    $.ajax({
        url: '/payments/api/transaction/' + transactionId + '/verify/',
        method: 'POST',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || $('meta[name=csrf-token]').attr('content') || getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            loadingMsg.remove();
            if (response.success) {
                // Show success message with more details
                var message = 'Transaction verified successfully!\n\n';
                message += 'Transaction Status: ' + response.status + '\n';
                message += 'Payment Status: ' + response.payment_status + '\n';
                if (response.verification_result && response.verification_result.reference) {
                    message += 'Reference: ' + response.verification_result.reference;
                }
                
                // Use a better notification method if available
                if (typeof toastr !== 'undefined') {
                    toastr.success(message.replace(/\n/g, '<br>'));
                } else {
                    alert(message);
                }
                
                // Reload the table to show updated status
                if (typeof loadTransactionsTable === 'function') {
                    loadTransactionsTable(1);
                } else {
                    location.reload();
                }
            } else {
                var errorMsg = 'Verification failed: ' + (response.message || 'Unknown error');
                if (typeof toastr !== 'undefined') {
                    toastr.error(errorMsg);
                } else {
                    alert(errorMsg);
                }
            }
        },
        error: function(xhr) {
            loadingMsg.remove();
            var errorMsg = 'Failed to verify transaction';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMsg = xhr.responseJSON.message;
            } else if (xhr.status === 403) {
                errorMsg = 'Permission denied. Please ensure you have the correct permissions.';
            } else if (xhr.status === 404) {
                errorMsg = 'Transaction not found.';
            } else if (xhr.status === 500) {
                errorMsg = 'Server error. Please try again later.';
            }
            
            if (typeof toastr !== 'undefined') {
                toastr.error(errorMsg);
            } else {
                alert(errorMsg);
            }
        },
        complete: function() {
            if (btn) {
                btn.innerHTML = originalText;
                btn.style.pointerEvents = '';
            }
        }
    });
}

// Helper function to get CSRF token from cookies
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Payment Action Functions (reuse from dashboard)
function viewPayment(paymentId) {
    $.get('/payments/api/payment/' + paymentId + '/view-details/', function(data) {
        if ($('#paymentViewModal').length === 0) {
            $('body').append('<div class="modal fade" id="paymentViewModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Payment Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="paymentViewContent"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div></div>');
        }
        $('#paymentViewContent').html(data);
        $('#paymentViewModal').modal('show');
    }).fail(function() {
        alert('Failed to load payment details.');
    });
}

// Start initialization
waitForJQuery();

// Initialize Bootstrap tooltips on page load
function initializeTooltips() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
}

// Initialize Bootstrap dropdowns
function initializeDropdowns() {
    var dropdownElementList = [].slice.call(document.querySelectorAll('.dropdown-toggle'));
    dropdownElementList.map(function (dropdownToggleEl) {
        return new bootstrap.Dropdown(dropdownToggleEl);
    });
}

// Initialize tooltips and dropdowns when jQuery is ready
$(document).ready(function() {
    initializeTooltips();
    initializeDropdowns();
});
</script>
{% endblock %}
