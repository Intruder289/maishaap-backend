{% extends "accounts/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Rent Management Dashboard{% endblock %}

{% block page_title %}Rent Management Dashboard{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="row mb-4">
  <div class="welcome-section">
    <h1 id="pageTitle">Rent Management Dashboard</h1>
    <p class="welcome-text">Complete overview of rental payments and collections for <strong>{{ current_month }}</strong></p>
  </div>
  <div class="header-actions">
    <div class="date-display">{{ "now"|date:"F j, Y" }}</div>
  </div>
</div>

<!-- Dashboard Content -->
<div id="pageBody">

  <!-- Quick Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card" 
         data-trend="{% if collection_rate > 80 %}up{% elif collection_rate < 60 %}down{% else %}stable{% endif %}"
         data-card-type="collected"
         tabindex="0"
         role="button"
         aria-label="View collected payments details">
      <div class="stat-icon revenue">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
      </div>
      <div class="stat-info">
        <h3>Tsh {{ collected_this_month|floatformat:0|intcomma }}</h3>
        <p>Collected This Month</p>
        <span class="stat-change {% if collection_rate > 80 %}positive{% elif collection_rate < 60 %}negative{% else %}neutral{% endif %}">{{ collection_rate|floatformat:1 }}% rate</span>
      </div>
    </div>

    <div class="stat-card {% if unpaid_invoices > 10 %}critical{% elif unpaid_invoices > 5 %}warning{% endif %}" 
         data-trend="{% if unpaid_invoices > 10 %}up{% elif unpaid_invoices < 5 %}down{% else %}stable{% endif %}"
         data-card-type="outstanding"
         tabindex="0"
         role="button"
         aria-label="View outstanding amounts">
      <div class="stat-icon payment">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg>
      </div>
      <div class="stat-info">
        <h3>Tsh {{ outstanding_amount|floatformat:0|intcomma }}</h3>
        <p>Outstanding Amount</p>
        <span class="stat-change {% if unpaid_invoices > 10 %}negative{% elif unpaid_invoices < 5 %}positive{% else %}neutral{% endif %}">{{ unpaid_invoices }} invoices</span>
      </div>
    </div>

    <div class="stat-card {% if overdue_count > 5 %}critical{% elif overdue_count > 2 %}warning{% endif %}" 
         data-trend="{% if overdue_count > 5 %}up{% elif overdue_count == 0 %}down{% else %}stable{% endif %}"
         data-card-type="overdue"
         tabindex="0"
         role="button"
         aria-label="View overdue payments">
      <div class="stat-icon booking">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>
      </div>
      <div class="stat-info">
        <h3>Tsh {{ overdue_amount|floatformat:0|intcomma }}</h3>
        <p>Overdue Payments</p>
        <span class="stat-change {% if overdue_count > 5 %}negative{% elif overdue_count == 0 %}positive{% else %}neutral{% endif %}">{{ overdue_count }} overdue</span>
      </div>
    </div>

    <div class="stat-card" 
         data-trend="stable"
         data-card-type="leases"
         tabindex="0"
         role="button"
         aria-label="View active leases">
      <div class="stat-icon lease">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
      </div>
      <div class="stat-info">
        <h3>{{ active_leases_count }}</h3>
        <p>Active Leases</p>
        <span class="stat-change neutral">Tsh {{ total_monthly_rent|floatformat:0|intcomma }} monthly</span>
      </div>
    </div>
  </div>

  <!-- Quick Actions Section -->
  <div class="dashboard-grid">
    <div class="dashboard-card">
      <div class="card-header">
        <h3>Quick Actions</h3>
        <p>Fast access to rent management tasks</p>
      </div>
      <div class="row g-3">
          <a href="{% url 'rent:create_invoice' %}" class="btn btn-link text-600 btn btn-primary-sm dropdown-toggle dropdown-caret-none btn btn-primary-primary">
            <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
              <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </svg>
            Create Invoice
          </a>
        <a href="{% url 'rent:payment_list' %}" class="btn btn-link text-600 btn btn-primary-sm dropdown-toggle dropdown-caret-none btn btn-primary-primary secondary">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
          View Payments
        </a>
        <a href="{% url 'rent:invoice_list' %}" class="btn btn-link text-600 btn btn-primary-sm dropdown-toggle dropdown-caret-none btn btn-primary-primary secondary">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
          </svg>
          All Invoices
        </a>
        {% if user.is_staff %}
        <a href="#" class="btn btn-link text-600 btn btn-primary-sm dropdown-toggle dropdown-caret-none btn btn-primary-primary secondary" data-bs-toggle="modal" data-bs-target="#generateInvoicesModal">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/>
          </svg>
          Generate Monthly
        </a>
        {% endif %}
        <a href="{% url 'documents:lease_list' %}" class="btn btn-link text-600 btn btn-primary-sm dropdown-toggle dropdown-caret-none btn btn-primary-primary secondary">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
          </svg>
          View Leases
        </a>
        <a href="{% url 'reports:generate' %}" class="btn btn-link text-600 btn btn-primary-sm dropdown-toggle dropdown-caret-none btn btn-primary-primary secondary">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/>
          </svg>
          Rent Reports
        </a>
        <a href="{% url 'maintenance:request_list' %}" class="btn btn-link text-600 btn btn-primary-sm dropdown-toggle dropdown-caret-none btn btn-primary-primary secondary">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/>
          </svg>
          Maintenance
        </a>
        <a href="{% url 'accounts:system_logs' %}" class="btn btn-link text-600 btn btn-primary-sm dropdown-toggle dropdown-caret-none btn btn-primary-primary secondary">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c0-1.1-.9-2-2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
          </svg>
          System Logs
        </a>
      </div>
    </div>
  </div>

  <!-- Activity Sections -->
  <div class="dashboard-grid">
    <div class="dashboard-card">
      <div class="card-header">
        <h3>Recent Payments</h3>
        <a href="{% url 'rent:payment_list' %}" class="view-all">View All</a>
      </div>
      <div class="activity-list">
        {% if recent_payments %}
          {% for payment in recent_payments %}
          <div class="activity-item">
            <div class="activity-icon payment">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
            </div>
            <div class="activity-content">
              <p><strong>{{ payment.tenant.get_full_name|default:payment.tenant.username }}</strong> paid rent</p>
              <span>{{ payment.lease.property_ref.name }} • {{ payment.payment_date|date:"M d, Y" }} • Tsh {{ payment.amount|floatformat:0|intcomma }}</span>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="activity-item">
            <div class="activity-icon default">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h2v2h-2zm0-8h2v6h-2z"/>
              </svg>
            </div>
            <div class="activity-content">
              <p>No recent payments</p>
              <span>Payments will appear here when received</span>
            </div>
          </div>
        {% endif %}
      </div>
    </div>

    <div class="dashboard-card">
      <div class="card-header">
        <h3>Upcoming Due Dates</h3>
        <a href="{% url 'rent:invoice_list' %}" class="view-all">View All</a>
      </div>
      <div class="activity-list">
        {% if upcoming_due %}
          {% for invoice in upcoming_due %}
          <div class="activity-item">
            <div class="activity-icon {% if invoice.is_overdue %}warning{% elif invoice.status == 'sent' %}booking{% else %}lease{% endif %}">
              <svg viewBox="0 0 24 24" fill="currentColor">
                {% if invoice.is_overdue %}
                  <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                {% else %}
                  <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/>
                {% endif %}
              </svg>
            </div>
            <div class="activity-content">
              <p><strong>{{ invoice.tenant.get_full_name|default:invoice.tenant.username }}</strong>
                {% if invoice.is_overdue %} - Overdue payment{% else %} - Payment due{% endif %}</p>
              <span>{{ invoice.lease.property_ref.name }} • Due {{ invoice.due_date|date:"M d, Y" }} • Tsh {{ invoice.balance_due|floatformat:0|intcomma }}</span>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="activity-item">
            <div class="activity-icon default">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/>
              </svg>
            </div>
            <div class="activity-content">
              <p>No upcoming due dates</p>
              <span>All payments are up to date</span>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock content %}

<!-- Generate Invoices Modal -->
{% if user.is_staff %}
<div class="modal fade" id="generateInvoicesModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Generate Monthly Invoices</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="generateInvoicesForm">
          <div class="mb-3">
            <label for="invoiceMonth" class="form-label">Month</label>
            <select class="form-select" id="invoiceMonth" name="month">
              <option value="1">January</option>
              <option value="2">February</option>
              <option value="3">March</option>
              <option value="4">April</option>
              <option value="5">May</option>
              <option value="6">June</option>
              <option value="7">July</option>
              <option value="8">August</option>
              <option value="9">September</option>
              <option value="10" selected>October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="invoiceYear" class="form-label">Year</label>
            <select class="form-select" id="invoiceYear" name="year">
              <option value="2024">2024</option>
              <option value="2025" selected>2025</option>
              <option value="2026">2026</option>
            </select>
          </div>
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            This will generate invoices for all active leases for the selected month.
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="generateInvoices()">
          <i class="fas fa-cogs me-2"></i>Generate Invoices
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% block extra_css %}

{% endblock extra_css %}

{% block extra_js %}
<script>
// Rent dashboard specific JavaScript functionality
document.addEventListener('DOMContentLoaded', function() {
  console.log('Rent Management Dashboard loaded');
  
  // Set active rent dashboard navigation
  const rentNav = document.querySelector('[data-page="rent:dashboard"]');
  if(rentNav) {
    rentNav.classList.add('active');
  }
  
  // Update page title
  const pageTitle = document.getElementById('pageTitle');
  if(pageTitle) {
    pageTitle.textContent = 'Rent Management Dashboard';
  }
  
  // Add refresh functionality for activities
  const refreshBtn = document.querySelector('.view-all[href="#"]');
  if(refreshBtn) {
    refreshBtn.addEventListener('click', function(e) {
      e.preventDefault();
      location.reload();
    });
  }
  
  // Format all Tsh amounts with proper styling
  document.querySelectorAll('h3').forEach(function(element) {
    if(element.textContent.includes('Tsh')) {
      element.classList.add('tzs-amount');
    }
  });
});
</script>

{% if user.is_staff %}
<script>
// Invoice generation function (only available for staff)
function generateInvoices() {
  const month = document.getElementById('invoiceMonth').value;
  const year = document.getElementById('invoiceYear').value;
  
  fetch('/api/v1/rent/invoices/generate_monthly/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: JSON.stringify({month: parseInt(month), year: parseInt(year)})
  })
  .then(response => response.json())
  .then(data => {
    if (data.created_count) {
      alert(`Generated ${data.created_count} invoices successfully!`);
      location.reload();
    } else {
      alert(data.message || 'No new invoices were generated.');
    }
    bootstrap.Modal.getInstance(document.getElementById('generateInvoicesModal')).hide();
  })
  .catch(error => {
    console.error('Error:', error);
    alert('An error occurred while generating invoices.');
  });
}
</script>
{% endif %}
{% endblock extra_js %}