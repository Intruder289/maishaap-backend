{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}Maintenance Requests{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header">
    <div class="row flex-between-center">
      <div class="col">
        <h6 class="mb-2">Maintenance Requests</h6>
        <h5 class="mb-0">Manage maintenance requests and track their progress</h5>
      </div>
      <div class="col-auto">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newRequestModal">
          <span class="fas fa-plus me-2"></span>New Request
        </button>
        <button type="button" class="btn btn-secondary ms-2" onclick="clearAllFilters()">
          <span class="fas fa-times me-2"></span>Clear All
        </button>
      </div>
    </div>
  </div>
  
  <!-- Search and Filters -->
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-4">
        <label for="search-input" class="form-label">Search</label>
        <input type="text" class="form-control" id="search-input" placeholder="Search requests...">
      </div>
      <div class="col-md-4">
        <label for="status-filter" class="form-label">Status</label>
        <select class="form-select" id="status-filter">
          <option value="">All Statuses</option>
          {% for value, display in status_choices %}
          <option value="{{ value }}">{{ display }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label for="priority-filter" class="form-label">Priority</label>
        <select class="form-select" id="priority-filter">
          <option value="">All Priorities</option>
          {% for value, display in priority_choices %}
          <option value="{{ value }}">{{ display }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>
  
  <div class="card-body p-0">
    <div id="table-container">
      <!-- Table will be loaded here via AJAX -->
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Request</th>
              <th>Property</th>
              {% if user.is_staff %}
              <th>Tenant</th>
              {% endif %}
              <th>Priority</th>
              <th>Status</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="maintenance-table-body">
            {% for request in page_obj.object_list %}
            <tr data-request-id="{{ request.id }}">
              <td>
                <div class="d-flex align-items-center">
                  <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3 fw-bold">
                    {{ request.title|first|upper }}
                  </div>
                  <div>
                    <strong>
                      <a href="{% url 'maintenance:request_detail' request.id %}" class="text-decoration-none">
                        {{ request.title }}
                      </a>
                    </strong>
                    <div class="text-muted small">{{ request.description|truncatechars:50 }}</div>
                  </div>
                </div>
              </td>
              <td>
                <div class="d-flex align-items-center">
                  <i class="fas fa-home text-muted me-2"></i>
                  <div>
                    <div class="fw-bold">{{ request.property.title }}</div>
                    <div class="text-muted small">{{ request.property.address|truncatechars:30 }}</div>
                  </div>
                </div>
              </td>
              {% if user.is_staff %}
              <td>
                <div class="d-flex align-items-center">
                  <i class="fas fa-user text-muted me-2"></i>
                  <div>
                    <div class="fw-bold">{{ request.tenant.get_full_name|default:request.tenant.username }}</div>
                    <div class="text-muted small">{{ request.tenant.email }}</div>
                  </div>
                </div>
              </td>
              {% endif %}
              <td>
                {% if request.priority == 'urgent' %}
                <span class="badge bg-danger">{{ request.get_priority_display }}</span>
                {% elif request.priority == 'high' %}
                <span class="badge bg-warning">{{ request.get_priority_display }}</span>
                {% elif request.priority == 'medium' %}
                <span class="badge bg-info">{{ request.get_priority_display }}</span>
                {% else %}
                <span class="badge bg-success">{{ request.get_priority_display }}</span>
                {% endif %}
              </td>
              <td>
                {% if request.status == 'completed' %}
                <span class="badge bg-success">{{ request.get_status_display }}</span>
                {% elif request.status == 'in_progress' %}
                <span class="badge bg-primary">{{ request.get_status_display }}</span>
                {% elif request.status == 'pending' %}
                <span class="badge bg-warning">{{ request.get_status_display }}</span>
                {% else %}
                <span class="badge bg-secondary">{{ request.get_status_display }}</span>
                {% endif %}
              </td>
              <td>
                <div class="text-muted small">
                  {{ request.created_at|date:"M d, Y" }}<br>
                  {{ request.created_at|time:"g:i A" }}
                </div>
              </td>
              <td>
                <div class="dropdown">
                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-ellipsis-v"></i>
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="openViewModal({{ request.id }})">
                      <i class="fas fa-eye me-2"></i>View Details
                    </a></li>
                    {% if user.is_staff %}
                    <li><a class="dropdown-item" href="#" onclick="openStartWorkModal({{ request.id }})">
                      <i class="fas fa-play me-2"></i>Start Work
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="openMarkCompleteModal({{ request.id }})">
                      <i class="fas fa-check me-2"></i>Mark Complete
                    </a></li>
                    {% if request.status == 'completed' %}
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="openDeleteModal({{ request.id }})">
                      <i class="fas fa-trash me-2"></i>Delete
                    </a></li>
                    {% endif %}
                    {% endif %}
                  </ul>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center py-4">
                <div class="text-muted">
                  <i class="fas fa-inbox fa-2x mb-3"></i>
                  <p>No maintenance requests found.</p>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      <!-- Pagination -->
      {% if page_obj.has_other_pages %}
      <div class="card-footer bg-white border-0 py-3">
        <div class="row align-items-center">
          <div class="col-md-6">
            <div class="text-muted">
              Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} entries
            </div>
          </div>
          <div class="col-md-6">
            <nav aria-label="Page navigation" class="d-flex justify-content-end">
              <ul class="pagination pagination-sm mb-0">
                {% if page_obj.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="#" onclick="loadPage(1); return false;" title="First Page">
                    <i class="fas fa-angle-double-left"></i>
                  </a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="#" onclick="loadPage({{ page_obj.previous_page_number }}); return false;" title="Previous Page">
                    <i class="fas fa-angle-left"></i>
                  </a>
                </li>
                {% endif %}

                <!-- Page numbers -->
                {% for num in page_obj.paginator.page_range %}
                  {% if page_obj.number == num %}
                  <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                  </li>
                  {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                  <li class="page-item">
                    <a class="page-link" href="#" onclick="loadPage({{ num }}); return false;">{{ num }}</a>
                  </li>
                  {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <li class="page-item">
                  <a class="page-link" href="#" onclick="loadPage({{ page_obj.next_page_number }}); return false;" title="Next Page">
                    <i class="fas fa-angle-right"></i>
                  </a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="#" onclick="loadPage({{ page_obj.paginator.num_pages }}); return false;" title="Last Page">
                    <i class="fas fa-angle-double-right"></i>
                  </a>
                </li>
                {% endif %}
              </ul>
            </nav>
          </div>
        </div>
      </div>
      {% endif %}
                  </div>
                </div>
</div>

<!-- New Request Modal -->
<div class="modal fade" id="newRequestModal" tabindex="-1" aria-labelledby="newRequestModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newRequestModalLabel">New Maintenance Request</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'maintenance:request_create' %}">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-3">
            <label for="title" class="form-label">Title</label>
            <input type="text" class="form-control" id="title" name="title" required>
            </div>
          <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
            </div>
          <div class="mb-3">
            <label for="property" class="form-label">Property</label>
              <select class="form-select" id="property" name="property" required>
                <option value="">Select Property</option>
                {% for property in user_properties %}
              <option value="{{ property.id }}">{{ property.title }} - {{ property.address }}</option>
                {% endfor %}
              </select>
            </div>
          <div class="mb-3">
              <label for="priority" class="form-label">Priority</label>
              <select class="form-select" id="priority" name="priority">
                {% for value, display in priority_choices %}
                <option value="{{ value }}" {% if value == 'medium' %}selected{% endif %}>{{ display }}</option>
                {% endfor %}
              </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-paper-plane me-2"></i>Submit Request
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- View Details Modal -->
<div class="modal fade" id="viewModal" tabindex="-1" aria-labelledby="viewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewModalLabel">Request Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-4">
          <h6 id="viewModalTitle" class="fw-bold mb-2"></h6>
          <p id="viewModalDescription" class="text-muted"></p>
        </div>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label fw-bold text-muted small">Property:</label>
            <p id="viewModalProperty" class="mb-0"></p>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold text-muted small">Status:</label>
            <p id="viewModalStatus" class="mb-0"></p>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold text-muted small">Priority:</label>
            <p id="viewModalPriority" class="mb-0"></p>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold text-muted small">Created:</label>
            <p id="viewModalCreated" class="mb-0"></p>
          </div>
          <div class="col-md-12">
            <label class="form-label fw-bold text-muted small">Category:</label>
            <p id="viewModalCategory" class="mb-0"></p>
          </div>
          <div class="col-md-12" id="viewModalLocationDiv" style="display:none;">
            <label class="form-label fw-bold text-muted small">Location Details:</label>
            <p id="viewModalLocation" class="mb-0"></p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Start Work Modal -->
<div class="modal fade" id="startWorkModal" tabindex="-1" aria-labelledby="startWorkModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="startWorkModalLabel">Start Work</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="startWorkRequestId">
        <div class="mb-3">
          <label for="startWorkNotes" class="form-label">Work Notes (Optional)</label>
          <textarea class="form-control" id="startWorkNotes" rows="3" placeholder="Add any notes about starting this work..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="startWorkBtn">
          <i class="fas fa-play me-2"></i>Start Work
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Mark Complete Modal -->
<div class="modal fade" id="markCompleteModal" tabindex="-1" aria-labelledby="markCompleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="markCompleteModalLabel">Mark Complete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="markCompleteRequestId">
        <div class="mb-3">
          <label for="markCompleteNotes" class="form-label">Completion Notes (Optional)</label>
          <textarea class="form-control" id="markCompleteNotes" rows="3" placeholder="Add notes about the completed work..."></textarea>
        </div>
        <div class="mb-3">
          <label for="markCompleteCost" class="form-label">Actual Cost (Optional)</label>
          <input type="number" class="form-control" id="markCompleteCost" step="0.01" placeholder="0.00">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" id="markCompleteBtn">
          <i class="fas fa-check me-2"></i>Mark Complete
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Delete Request</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="deleteRequestId">
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Warning!</strong> This action cannot be undone. Are you sure you want to delete this maintenance request?
        </div>
        <p>This will permanently remove the request and all associated data.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="deleteBtn">
          <i class="fas fa-trash me-2"></i>Delete Request
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Wait for jQuery to be available
function waitForJQuery() {
    if (typeof $ !== 'undefined') {
        initializeMaintenancePage();
    } else {
        setTimeout(waitForJQuery, 100);
    }
}

function initializeMaintenancePage() {
    console.log('=== MAINTENANCE REQUESTS PAGE LOADED ===');
    
    // AJAX function to load filtered table
    function loadTable(page = 1) {
        var search = $('#search-input').val() || '';
        var status = $('#status-filter').val() || '';
        var priority = $('#priority-filter').val() || '';
        
        console.log('=== LOADING TABLE ===');
        console.log('Search:', search);
        console.log('Status:', status);
        console.log('Priority:', priority);
        console.log('Page:', page);
        
        // Show loading
        $('#table-container').html('<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading...</p></div>');
        
        $.ajax({
            url: '{% url "maintenance:test_ajax" %}',
            type: 'GET',
            data: {
                'search': search,
                'status': status,
                'priority': priority,
                'page': page
            },
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(data) {
                console.log('=== AJAX SUCCESS ===');
                console.log('Data length:', data.length);
                console.log('Data preview:', data.substring(0, 200));
                
                // Replace the table container with the new HTML
                $('#table-container').html(data);
                
                console.log('Table updated successfully');
            },
            error: function(xhr, status, error) {
                console.log('=== AJAX ERROR ===');
                console.log('Error:', error);
                console.log('Status:', status);
                console.log('Response:', xhr.responseText);
                
                $('#table-container').html('<div class="text-center py-5"><p class="text-danger">Error loading data: ' + error + '</p><button class="btn btn-primary" onclick="location.reload()">Refresh Page</button></div>');
            }
        });
    }
    
    // Search input handler
    var searchTimeout;
    $('#search-input').on('input', function() {
        var searchValue = $(this).val();
        console.log('Search input changed:', searchValue);
        
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            console.log('Search timeout triggered');
            loadTable(1);
        }, 500);
    });
    
    // Handle search clear
    $('#search-input').on('keyup', function() {
        var searchValue = $(this).val();
        if (searchValue === '') {
            console.log('Search cleared - resetting filters');
            $('#status-filter').val('');
            $('#priority-filter').val('');
            loadTable(1);
        }
    });
    
    // Filter change handlers
    $('#status-filter').on('change', function() {
        var statusValue = $(this).val();
        console.log('Status filter changed:', statusValue);
        loadTable(1);
    });
    
    $('#priority-filter').on('change', function() {
        var priorityValue = $(this).val();
        console.log('Priority filter changed:', priorityValue);
        loadTable(1);
    });
    
    // Global functions for pagination
    window.loadPage = function(page) {
        console.log('Loading page:', page);
        loadTable(page);
    };
    
    // Clear all filters function
    window.clearAllFilters = function() {
        console.log('=== CLEARING ALL FILTERS ===');
        $('#search-input').val('');
        $('#status-filter').val('');
        $('#priority-filter').val('');
        loadTable(1);
    };
    
    // Status update function
    window.updateStatus = function(requestId, newStatus) {
        console.log('Updating status for request:', requestId, 'to:', newStatus);
        
        $.ajax({
            url: '{% url "maintenance:request_list" %}',
            type: 'POST',
            data: {
                'request_id': requestId,
                'new_status': newStatus,
                'csrfmiddlewaretoken': getCookie('csrftoken')
            },
            success: function(response) {
                console.log('Status updated successfully');
                loadTable();
            },
            error: function(xhr, status, error) {
                console.log('Error updating status:', error);
                alert('Error updating status. Please try again.');
            }
        });
    };
    
    // Modal functions
    window.openViewModal = function(requestId) {
        // Load request details and show modal
        $.ajax({
            url: '{% url "maintenance:request_detail" 0 %}'.replace('0', requestId),
            type: 'GET',
            success: function(data) {
                // Extract request data from the response or make another call
                loadRequestDetails(requestId);
            },
            error: function(xhr, status, error) {
                console.log('Error loading request details:', error);
                alert('Error loading request details. Please try again.');
            }
        });
    };
    
    window.openStartWorkModal = function(requestId) {
        $('#startWorkRequestId').val(requestId);
        $('#startWorkModal').modal('show');
    };
    
    window.openMarkCompleteModal = function(requestId) {
        $('#markCompleteRequestId').val(requestId);
        $('#markCompleteModal').modal('show');
    };
    
    window.openDeleteModal = function(requestId) {
        $('#deleteRequestId').val(requestId);
        $('#deleteModal').modal('show');
    };
    
    // Load request details for view modal
    function loadRequestDetails(requestId) {
        $.ajax({
            url: '{% url "maintenance:request_list" %}',
            type: 'POST',
            data: {
                'action': 'get_details',
                'request_id': requestId,
                'csrfmiddlewaretoken': getCookie('csrftoken')
            },
            success: function(response) {
                console.log('Response:', response);
                // Update modal content with request details
                $('#viewModalTitle').text(response.title);
                $('#viewModalDescription').text(response.description);
                $('#viewModalProperty').text(response.property);
                $('#viewModalStatus').html(response.status);
                $('#viewModalPriority').html(response.priority);
                $('#viewModalCreated').text(response.created_at);
                $('#viewModalCategory').text(response.category || 'N/A');
                
                // Show location details if available
                if (response.location_details) {
                    $('#viewModalLocation').text(response.location_details);
                    $('#viewModalLocationDiv').show();
                } else {
                    $('#viewModalLocationDiv').hide();
                }
                
                $('#viewModal').modal('show');
            },
            error: function(xhr, status, error) {
                console.log('Error loading request details:', error);
                console.log('Response:', xhr.responseText);
                alert('Error loading request details. Please try again.');
            }
        });
    }
    
    // Action handlers
    $('#startWorkBtn').on('click', function() {
        var requestId = $('#startWorkRequestId').val();
        var notes = $('#startWorkNotes').val();
        
        $.ajax({
            url: '{% url "maintenance:request_list" %}',
            type: 'POST',
            data: {
                'action': 'start_work',
                'request_id': requestId,
                'notes': notes,
                'csrfmiddlewaretoken': getCookie('csrftoken')
            },
            success: function(response) {
                $('#startWorkModal').modal('hide');
                $('#startWorkNotes').val('');
                loadTable();
                alert('Work started successfully!');
            },
            error: function(xhr, status, error) {
                console.log('Error starting work:', error);
                alert('Error starting work. Please try again.');
            }
        });
    });
    
    $('#markCompleteBtn').on('click', function() {
        var requestId = $('#markCompleteRequestId').val();
        var notes = $('#markCompleteNotes').val();
        var actualCost = $('#markCompleteCost').val();
        
        $.ajax({
            url: '{% url "maintenance:request_list" %}',
            type: 'POST',
            data: {
                'action': 'mark_complete',
                'request_id': requestId,
                'notes': notes,
                'actual_cost': actualCost,
                'csrfmiddlewaretoken': getCookie('csrftoken')
            },
            success: function(response) {
                $('#markCompleteModal').modal('hide');
                $('#markCompleteNotes').val('');
                $('#markCompleteCost').val('');
                loadTable();
                alert('Request marked as complete!');
            },
            error: function(xhr, status, error) {
                console.log('Error marking complete:', error);
                alert('Error marking complete. Please try again.');
            }
        });
    });
    
    $('#deleteBtn').on('click', function() {
        var requestId = $('#deleteRequestId').val();
        
        $.ajax({
            url: '{% url "maintenance:request_list" %}',
            type: 'POST',
            data: {
                'action': 'delete',
                'request_id': requestId,
                'csrfmiddlewaretoken': getCookie('csrftoken')
            },
            success: function(response) {
                $('#deleteModal').modal('hide');
                loadTable();
                alert('Request deleted successfully!');
            },
            error: function(xhr, status, error) {
                console.log('Error deleting request:', error);
                alert('Error deleting request. Please try again.');
            }
        });
    });
    
    // CSRF token helper
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    console.log('=== JAVASCRIPT LOADED SUCCESSFULLY ===');
}

// Start the initialization
waitForJQuery();
</script>
{% endblock %}