{% extends 'accounts/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Property Approval Requests - Maisha{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header">
    <div class="row flex-between-center">
      <div class="col">
        <h6 class="mb-2">Property Approval Requests</h6>
        <h5 class="mb-0">Review and approve property uploads from owners</h5>
      </div>
      <div class="col-auto">
        <div class="d-flex gap-2">
          <span class="badge bg-warning">Pending: {{ pending_count }}</span>
          <span class="badge bg-danger">Rejected: {{ rejected_count }}</span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Search and Filters -->
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-4">
        <label for="approval-search-input" class="form-label">Search</label>
        <div class="input-group">
          <span class="input-group-text"><i class="fas fa-search"></i></span>
          <input type="text" class="form-control" id="approval-search-input" 
                 value="{{ search_query }}" placeholder="Search by title, owner, email, or address">
        </div>
      </div>
      <div class="col-md-4">
        <label for="approval-status-filter" class="form-label">Status</label>
        <select class="form-select" id="approval-status-filter">
          <option value="">All Statuses</option>
          {% for value, display in status_choices %}
          <option value="{{ value }}" {% if current_status == value %}selected{% endif %}>{{ display }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label for="approval-type-filter" class="form-label">Property Type</label>
        <select class="form-select" id="approval-type-filter">
          <option value="">All Types</option>
          {% for pt in property_types %}
          <option value="{{ pt.id }}" {% if current_property_type == pt.id|stringformat:"s" %}selected{% endif %}>{{ pt.name|title }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label for="approval-page-size-select" class="form-label">Items per page</label>
        <select class="form-select" id="approval-page-size-select" onchange="changeApprovalPageSize()">
          <option value="5" {% if current_page_size == 5 %}selected{% endif %}>5</option>
          <option value="10" {% if current_page_size == 10 or not current_page_size %}selected{% endif %}>10</option>
          <option value="25" {% if current_page_size == 25 %}selected{% endif %}>25</option>
          <option value="50" {% if current_page_size == 50 %}selected{% endif %}>50</option>
          <option value="100" {% if current_page_size == 100 %}selected{% endif %}>100</option>
        </select>
      </div>
    </div>
  </div>
  
  <div id="approval-table-container" class="card-body p-0">
    {% include 'properties/property_approval_table.html' %}
  </div>
</div>

<!-- Approve Modal -->
<div class="modal fade" id="approveModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Approve Property</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="" id="approveForm">
        {% csrf_token %}
        <div class="modal-body">
          <p>Are you sure you want to approve this property? It will become visible to the public.</p>
          <div class="mb-3">
            <label for="approve_admin_comments" class="form-label">Admin Comments (Optional)</label>
            <textarea class="form-control" id="approve_admin_comments" name="admin_comments" rows="3" 
                      placeholder="Add any comments or notes about this property..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Approve Property</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Reject Property</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="" id="rejectForm">
        {% csrf_token %}
        <div class="modal-body">
          <p>Please provide a reason for rejecting this property.</p>
          <div class="mb-3">
            <label for="rejection_reason" class="form-label">Rejection Reason <span class="text-danger">*</span></label>
            <textarea class="form-control" id="rejection_reason" name="rejection_reason" rows="3" 
                      placeholder="Explain why this property is being rejected..." required></textarea>
          </div>
          <div class="mb-3">
            <label for="reject_admin_comments" class="form-label">Admin Comments (Optional)</label>
            <textarea class="form-control" id="reject_admin_comments" name="admin_comments" rows="3" 
                      placeholder="Add any additional comments..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">Reject Property</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Property Request</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="" id="deleteForm">
        {% csrf_token %}
        <div class="modal-body">
          <p class="text-danger">Are you sure you want to delete this property approval request? This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Delete Request</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
.avatar-sm {
  width: 48px;
  height: 48px;
  font-size: 14px;
  font-weight: 600;
  object-fit: cover;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    waitForApprovalFilters();
});

function waitForApprovalFilters() {
    if (typeof window.jQuery !== 'undefined') {
        initializePropertyApprovalFilters();
    } else {
        setTimeout(waitForApprovalFilters, 100);
    }
}

function initializePropertyApprovalFilters() {
    const $searchInput = $('#approval-search-input');
    const $statusFilter = $('#approval-status-filter');
    const $typeFilter = $('#approval-type-filter');
    const $pageSizeSelect = $('#approval-page-size-select');
    const $tableContainer = $('#approval-table-container');
    let searchTimeout = null;
    
    function loadApprovalTable(page = 1) {
        const search = $searchInput.val() || '';
        const status = $statusFilter.val() || '';
        const propertyType = $typeFilter.val() || '';
        const pageSize = $pageSizeSelect.val() || '10';
        
        $tableContainer.html(
            '<div class="text-center py-5">' +
                '<div class="spinner-border text-primary mb-3" role="status"></div>' +
                '<p class="text-muted mb-0">Loading approval requests...</p>' +
            '</div>'
        );
        
        $.ajax({
            url: '{% url "properties:property_approval_list" %}',
            type: 'GET',
            data: {
                search: search,
                status: status,
                property_type: propertyType,
                page: page,
                page_size: pageSize
            },
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(html) {
                $tableContainer.html(html);
            },
            error: function(xhr, status, error) {
                console.error('Error loading property approvals table:', error, xhr.responseText);
                $tableContainer.html(
                    '<div class="text-center py-5">' +
                        '<p class="text-danger mb-3">Unable to load approval requests.</p>' +
                        '<button class="btn btn-outline-primary btn-sm" type="button" onclick="location.reload()">' +
                            '<i class="fas fa-sync-alt me-1"></i>Reload Page' +
                        '</button>' +
                    '</div>'
                );
            }
        });
    }
    
    $searchInput.on('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            loadApprovalTable(1);
        }, 400);
    });
    
    $statusFilter.on('change', function() {
        loadApprovalTable(1);
    });
    
    $typeFilter.on('change', function() {
        loadApprovalTable(1);
    });
    
    // Make loadApprovalTable available globally for pagination links
    window.loadApprovalPage = function(page) {
        loadApprovalTable(page);
    };
}

function changeApprovalPageSize() {
    const pageSize = document.getElementById('approval-page-size-select').value;
    // Reload table with new page size, reset to page 1
    if (typeof window.loadApprovalPage === 'function') {
        // Get current filter values
        const search = document.getElementById('approval-search-input')?.value || '';
        const status = document.getElementById('approval-status-filter')?.value || '';
        const propertyType = document.getElementById('approval-type-filter')?.value || '';
        
        // Update the page size in the select and reload
        const $searchInput = $('#approval-search-input');
        const $statusFilter = $('#approval-status-filter');
        const $typeFilter = $('#approval-type-filter');
        const $pageSizeSelect = $('#approval-page-size-select');
        const $tableContainer = $('#approval-table-container');
        
        $tableContainer.html(
            '<div class="text-center py-5">' +
                '<div class="spinner-border text-primary mb-3" role="status"></div>' +
                '<p class="text-muted mb-0">Loading approval requests...</p>' +
            '</div>'
        );
        
        $.ajax({
            url: '{% url "properties:property_approval_list" %}',
            type: 'GET',
            data: {
                search: $searchInput.val() || '',
                status: $statusFilter.val() || '',
                property_type: $typeFilter.val() || '',
                page: 1,
                page_size: pageSize
            },
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(html) {
                $tableContainer.html(html);
            },
            error: function(xhr, status, error) {
                console.error('Error loading property approvals table:', error, xhr.responseText);
                $tableContainer.html(
                    '<div class="text-center py-5">' +
                        '<p class="text-danger mb-3">Unable to load approval requests.</p>' +
                        '<button class="btn btn-outline-primary btn-sm" type="button" onclick="location.reload()">' +
                            '<i class="fas fa-sync-alt me-1"></i>Reload Page' +
                        '</button>' +
                    '</div>'
                );
            }
        });
    } else {
        // Fallback: reload page with new page size
        const url = new URL(window.location);
        url.searchParams.set('page_size', pageSize);
        url.searchParams.set('page', '1');
        window.location.href = url.toString();
    }
}

function openApproveModal(propertyId) {
    const form = document.getElementById('approveForm');
    form.action = '{% url "properties:approve_property" 0 %}'.replace('0', propertyId);
    const modal = new bootstrap.Modal(document.getElementById('approveModal'));
    modal.show();
}

function openRejectModal(propertyId) {
    const form = document.getElementById('rejectForm');
    form.action = '{% url "properties:reject_property" 0 %}'.replace('0', propertyId);
    const modal = new bootstrap.Modal(document.getElementById('rejectModal'));
    modal.show();
}

function openDeleteModal(propertyId) {
    const form = document.getElementById('deleteForm');
    form.action = '{% url "properties:delete_approval_request" 0 %}'.replace('0', propertyId);
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}
</script>
{% endblock %}

