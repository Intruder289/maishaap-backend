{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}Hotel Payments{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-money-bill-wave text-primary me-2"></i>Hotel Payments
                    </h2>
                    <p class="text-muted mb-0">Track payments, transactions, and financial records</p>
                </div>
            </div>
            
            <!-- Payment Stats -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">Tsh{{ total_amount|floatformat:0 }}</h4>
                                    <p class="mb-0">Total Revenue</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-dollar-sign fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">{{ total_payments }}</h4>
                                    <p class="mb-0">Total Payments</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-chart-line fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">{{ paid_bookings }}</h4>
                                    <p class="mb-0">Paid Bookings</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">{{ total_payments }}</h4>
                                    <p class="mb-0">Active Records</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-list fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filter Section -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Search</label>
                            <input type="text" class="form-control" id="paymentSearch" placeholder="Search payments...">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Payment Method</label>
                            <select class="form-select" id="methodFilter">
                                <option value="">All Methods</option>
                                <option value="cash">Cash</option>
                                <option value="mobile_money">Mobile Money (AZAM Pay)</option>
                                <option value="online">Online Payment (AZAM Pay)</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Payment Type</label>
                            <select class="form-select" id="typeFilter">
                                <option value="">All Types</option>
                                <option value="deposit">Deposit</option>
                                <option value="partial">Partial</option>
                                <option value="full">Full Payment</option>
                                <option value="refund">Refund</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Date Range</label>
                            <select class="form-select" id="dateFilter">
                                <option value="">All Time</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                    <i class="fas fa-times me-1"></i>Clear
                                </button>
                                <button class="btn btn-outline-primary" onclick="exportPayments()">
                                    <i class="fas fa-download me-1"></i>Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Payments Table -->
            <div class="card">
                <div class="card-header">
                    <div class="row flex-between-center">
                        <div class="col">
                            <h6 class="mb-2">Payment Records</h6>
                            <h5 class="mb-0">Manage hotel payments and track transactions</h5>
                        </div>
                        <div class="col-auto">
                            <div class="input-group">
                                <select class="form-select" id="quickBookingSelect" style="max-width: 300px;">
                                    <option value="">Select Booking to Pay...</option>
                                    {% for booking in bookings %}
                                        <option value="{{ booking.id }}">
                                            {{ booking.booking_reference }} - {{ booking.customer.full_name }}
                                        </option>
                                    {% empty %}
                                        <option value="" disabled>No bookings available</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-primary" onclick="redirectToBookingPayment()">
                                    <span class="fas fa-plus me-2"></span>Record Payment
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Booking</th>
                                    <th>Customer</th>
                                    <th class="d-none d-lg-table-cell">Property</th>
                                    <th>Total</th>
                                    <th class="d-none d-md-table-cell">Paid</th>
                                    <th>Balance</th>
                                    <th class="d-none d-lg-table-cell">Last Payment</th>
                                    <th>Status</th>
                                    <th class="text-end text-nowrap">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment_data in payments %}
                                <tr data-booking-id="{{ payment_data.booking.id }}">
                                    <td class="text-nowrap">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3 fw-bold">
                                                {{ payment_data.booking.booking_reference|slice:":2" }}
                                            </div>
                                            <div>
                                                <strong>
                                                    <a href="{% url 'properties:booking_detail' pk=payment_data.booking.id %}" class="text-decoration-none">
                                                        {{ payment_data.booking.booking_reference }}
                                                    </a>
                                                </strong>
                                                <div class="text-muted small">
                                                    {{ payment_data.booking.created_at|date:"M d, Y" }}
                                                </div>
                                                {% if payment_data.payment_count > 1 %}
                                                <div class="text-muted small">
                                                    <i class="fas fa-receipt me-1"></i>{{ payment_data.payment_count }} payments
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-nowrap">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-user text-muted me-2"></i>
                                            <div>
                                                <div class="fw-bold">{{ payment_data.booking.customer.full_name }}</div>
                                                <div class="text-muted small">{{ payment_data.booking.customer.email|default:"N/A" }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="d-none d-lg-table-cell">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-hotel text-muted me-2"></i>
                                            <div>
                                                <div class="fw-bold">{{ payment_data.booking.property_obj.title }}</div>
                                                <div class="text-muted small">{{ payment_data.booking.room_number|default:"Room N/A" }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-nowrap">
                                        <div class="fw-bold text-primary">Tsh{{ payment_data.total_required|floatformat:0 }}</div>
                                        <div class="text-muted small">Total Required</div>
                                    </td>
                                    <td class="d-none d-md-table-cell text-nowrap">
                                        <div class="fw-bold text-success">Tsh{{ payment_data.paid_so_far|floatformat:0 }}</div>
                                        <div class="text-muted small">Paid So Far</div>
                                    </td>
                                    <td class="text-nowrap">
                                        {% if payment_data.remaining > 0 %}
                                            <div class="fw-bold text-danger">Tsh{{ payment_data.remaining|floatformat:0 }}</div>
                                            <div class="text-muted small">Remaining</div>
                                        {% else %}
                                            <div class="fw-bold text-success">Tsh0</div>
                                            <div class="text-muted small">Fully Paid</div>
                                        {% endif %}
                                    </td>
                                    <td class="d-none d-lg-table-cell text-nowrap">
                                        {% if payment_data.last_payment_date %}
                                            <div class="fw-bold">{{ payment_data.last_payment_date|date:"M d, Y" }}</div>
                                            <div class="text-muted small">{{ payment_data.last_payment_date|timesince }} ago</div>
                                        {% else %}
                                            <div class="text-muted">No payments yet</div>
                                        {% endif %}
                                    </td>
                                    <td class="text-nowrap">
                                        {% if payment_data.booking.payment_status == 'paid' %}
                                            <span class="badge bg-success">Fully Paid</span>
                                        {% elif payment_data.booking.payment_status == 'partial' %}
                                            <span class="badge bg-warning">Partial Payment</span>
                                        {% elif payment_data.booking.payment_status == 'pending' %}
                                            <span class="badge bg-secondary">Pending</span>
                                        {% elif payment_data.booking.payment_status == 'refunded' %}
                                            <span class="badge bg-danger">Refunded</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ payment_data.booking.payment_status|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end text-nowrap">
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="{% url 'properties:booking_detail' pk=payment_data.booking.id %}">
                                                    <i class="fas fa-eye me-2"></i>View Booking Details
                                                </a></li>
                                                {% if payment_data.booking.payment_status != 'paid' %}
                                                <li><a class="dropdown-item" href="{% url 'properties:create_payment' payment_data.booking.id %}">
                                                    <i class="fas fa-credit-card me-2"></i>Record Payment
                                                </a></li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="text-center py-4">
                                        <div class="text-muted">
                                            <i class="fas fa-credit-card fa-2x mb-3"></i>
                                            <p>No payment records found.</p>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    {% if payments.has_other_pages %}
                    <div class="card-footer bg-white border-0 py-3">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="text-muted">
                                    Showing {{ payments.start_index }} to {{ payments.end_index }} of {{ payments.paginator.count }} entries
                                </div>
                            </div>
                            <div class="col-md-6">
                                <nav aria-label="Page navigation" class="d-flex justify-content-end">
                                    <ul class="pagination pagination-sm mb-0">
                                        {% if payments.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page=1{% if request.GET.page_size %}&page_size={{ request.GET.page_size }}{% endif %}" title="First Page">
                                                <i class="fas fa-angle-double-left"></i>
                                            </a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ payments.previous_page_number }}{% if request.GET.page_size %}&page_size={{ request.GET.page_size }}{% endif %}" title="Previous Page">
                                                <i class="fas fa-angle-left"></i>
                                            </a>
                                        </li>
                                        {% endif %}
                                        
                                        <!-- Page numbers -->
                                        {% for num in payments.paginator.page_range %}
                                            {% if payments.number == num %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ num }}</span>
                                        </li>
                                            {% elif num > payments.number|add:'-3' and num < payments.number|add:'3' %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ num }}{% if request.GET.page_size %}&page_size={{ request.GET.page_size }}{% endif %}">{{ num }}</a>
                                            </li>
                                            {% endif %}
                                        {% endfor %}
                                        
                                        {% if payments.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ payments.next_page_number }}{% if request.GET.page_size %}&page_size={{ request.GET.page_size }}{% endif %}" title="Next Page">
                                                <i class="fas fa-angle-right"></i>
                                            </a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ payments.paginator.num_pages }}{% if request.GET.page_size %}&page_size={{ request.GET.page_size }}{% endif %}" title="Last Page">
                                                <i class="fas fa-angle-double-right"></i>
                                            </a>
                                        </li>
                                        {% endif %}
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Payment Details Modal -->
<div class="modal fade" id="viewPaymentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Payment Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewPaymentModalBody">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="printReceipt()">Print Receipt</button>
            </div>
        </div>
    </div>
</div>

<!-- Print Receipt Modal -->
<div class="modal fade" id="printReceiptModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Print Receipt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="printReceiptModalBody">
                <!-- Receipt content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="window.print()">Print</button>
            </div>
        </div>
    </div>
</div>

<!-- Refund Payment Modal -->
<div class="modal fade" id="refundPaymentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Process Refund</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This action will process a refund for the selected payment. This action cannot be undone.
                </div>
                <form id="refundPaymentForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Refund Amount *</label>
                            <input type="number" class="form-control" id="refundAmount" step="0.01" min="0" required>
                            <small class="text-muted">Auto-filled for extra payments, manual entry for normal refunds</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Refund Method *</label>
                            <select class="form-control" id="refundMethod" required>
                                <option value="">Select Method</option>
                                <option value="cash">Cash</option>
                                <option value="online">Online Payment (AZAM Pay)</option>
                                <option value="mobile_money">Mobile Money</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Refund Reference</label>
                            <input type="text" class="form-control" id="refundReference" readonly placeholder="Auto-generated">
                            <small class="text-muted">Automatically generated</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Refund Date *</label>
                            <input type="datetime-local" class="form-control" id="refundDate" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Reason for Refund *</label>
                            <textarea class="form-control" id="refundReason" rows="3" placeholder="Please provide a reason for this refund..." required></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitRefund()">Process Refund</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPaymentId = null;

$(document).ready(function() {
    console.log('Hotel Payments page initialized');
    
    // Redirect to booking payment page
    window.redirectToBookingPayment = function() {
        const bookingSelect = document.getElementById('quickBookingSelect');
        if (bookingSelect && bookingSelect.value) {
            const bookingId = bookingSelect.value;
            window.location.href = `/properties/bookings/${bookingId}/payment/`;
        } else {
            alert('Please select a booking from the dropdown first.');
            bookingSelect.focus();
        }
    };
    
    // Allow Enter key on booking select to trigger payment
    document.getElementById('quickBookingSelect')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && this.value) {
            redirectToBookingPayment();
        }
    });
    
    // Set current date/time for modals
    const now = new Date();
    const dateTimeString = now.toISOString().slice(0, 16);
    $('#refundDate').val(dateTimeString);
    
    // Filter functionality
    $('#paymentSearch, #methodFilter, #typeFilter, #dateFilter').on('change keyup', function() {
        filterPayments();
    });
    
    function filterPayments() {
        const searchTerm = $('#paymentSearch').val().toLowerCase();
        const methodFilter = $('#methodFilter').val();
        const typeFilter = $('#typeFilter').val();
        const dateFilter = $('#dateFilter').val();
        
        $('#paymentsTable tbody tr').each(function() {
            let showRow = true;
            const row = $(this);
            
            // Search filter
            if (searchTerm && !row.text().toLowerCase().includes(searchTerm)) {
                showRow = false;
            }
            
            // Method filter
            if (methodFilter && !row.find('td:nth-child(5)').text().toLowerCase().includes(methodFilter)) {
                showRow = false;
            }
            
            // Type filter
            if (typeFilter && !row.find('td:nth-child(6)').text().toLowerCase().includes(typeFilter)) {
                showRow = false;
            }
            
            row.toggle(showRow);
        });
    }
    
    // Clear filters
    window.clearFilters = function() {
        $('#paymentSearch, #methodFilter, #typeFilter, #dateFilter').val('');
        $('#paymentsTable tbody tr').show();
    };
    
    // Export payments
    window.exportPayments = function() {
        alert('Export functionality will be implemented');
    };
});

// Modal functions
function openViewModal(paymentId) {
    currentPaymentId = paymentId;
    
    // Fetch payment details via AJAX
    $.ajax({
        url: '/properties/api/payment-details/' + paymentId + '/',
        method: 'GET',
        success: function(data) {
            const modalBody = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Payment Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Payment ID:</strong></td><td>#${data.id}</td></tr>
                            <tr><td><strong>Amount:</strong></td><td>Tsh${data.amount}</td></tr>
                            <tr><td><strong>Method:</strong></td><td>${data.payment_method_display}</td></tr>
                            <tr><td><strong>Type:</strong></td><td>${data.payment_type_display}</td></tr>
                            <tr><td><strong>Date:</strong></td><td>${data.payment_date}</td></tr>
                            <tr><td><strong>Reference:</strong></td><td>${data.transaction_reference || 'N/A'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Booking Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Booking:</strong></td><td>${data.booking.booking_reference}</td></tr>
                            <tr><td><strong>Room:</strong></td><td>${data.booking.room_number || 'N/A'}</td></tr>
                            <tr><td><strong>Check-in:</strong></td><td>${data.booking.check_in_date}</td></tr>
                            <tr><td><strong>Check-out:</strong></td><td>${data.booking.check_out_date}</td></tr>
                            <tr><td><strong>Total Amount:</strong></td><td>Tsh${data.booking.total_amount}</td></tr>
                        </table>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6>Customer Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Name:</strong></td><td>${data.booking.customer.full_name || data.booking.customer.username}</td></tr>
                            <tr><td><strong>Email:</strong></td><td>${data.booking.customer.email}</td></tr>
                            <tr><td><strong>Phone:</strong></td><td>${data.booking.customer.phone || 'N/A'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Staff Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Recorded By:</strong></td><td>${data.recorded_by}</td></tr>
                            <tr><td><strong>Created:</strong></td><td>${data.created_at}</td></tr>
                        </table>
                    </div>
                </div>
                ${data.notes ? `<div class="mt-3"><h6>Notes</h6><p class="text-muted">${data.notes}</p></div>` : ''}
            `;
            $('#viewPaymentModalBody').html(modalBody);
            $('#viewPaymentModal').modal('show');
        },
        error: function() {
            alert('Error loading payment details');
        }
    });
}

function openPrintModal(paymentId) {
    currentPaymentId = paymentId;
    
    // Fetch payment details for receipt
    $.ajax({
        url: '/properties/api/payment-details/' + paymentId + '/',
        method: 'GET',
        success: function(data) {
            // Calculate remaining balance and payment status
            const totalAmount = data.booking.total_amount;
            const paidAmount = data.booking.paid_amount;
            const remainingBalance = totalAmount - paidAmount;
            const isFullyPaid = remainingBalance <= 0;
            
            // Determine payment status message
            let paymentStatusMessage = '';
            if (isFullyPaid) {
                paymentStatusMessage = '<div class="alert alert-success text-center mt-3"><strong>✓ PAYMENT COMPLETE</strong><br>You have paid the full amount for this booking.</div>';
            } else {
                paymentStatusMessage = `<div class="alert alert-warning text-center mt-3"><strong>⚠ PARTIAL PAYMENT</strong><br>Amount remaining: <strong>Tsh${remainingBalance.toFixed(2)}</strong></div>`;
            }
            
            const receiptContent = `
                <div class="receipt-content" style="font-family: monospace;">
                    <div class="text-center mb-4">
                        <h4>PAYMENT RECEIPT</h4>
                        <hr>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Receipt #:</strong></div>
                        <div class="col-6">${data.id}</div>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Date:</strong></div>
                        <div class="col-6">${data.payment_date}</div>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Booking:</strong></div>
                        <div class="col-6">${data.booking.booking_reference}</div>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Customer:</strong></div>
                        <div class="col-6">${data.booking.customer.full_name || data.booking.customer.username}</div>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Room:</strong></div>
                        <div class="col-6">${data.booking.room_number || 'N/A'}</div>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Check-in:</strong></div>
                        <div class="col-6">${data.booking.check_in_date}</div>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Check-out:</strong></div>
                        <div class="col-6">${data.booking.check_out_date}</div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-6"><strong>Total Booking Amount:</strong></div>
                        <div class="col-6"><strong>Tsh${totalAmount.toFixed(2)}</strong></div>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Amount Paid This Time:</strong></div>
                        <div class="col-6"><strong>Tsh${data.amount}</strong></div>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Total Paid So Far:</strong></div>
                        <div class="col-6"><strong>Tsh${paidAmount.toFixed(2)}</strong></div>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Remaining Balance:</strong></div>
                        <div class="col-6"><strong>Tsh${remainingBalance.toFixed(2)}</strong></div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-6"><strong>Payment Method:</strong></div>
                        <div class="col-6">${data.payment_method_display}</div>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Payment Type:</strong></div>
                        <div class="col-6">${data.payment_type_display}</div>
                    </div>
                    ${data.transaction_reference ? `
                    <div class="row">
                        <div class="col-6"><strong>Reference:</strong></div>
                        <div class="col-6">${data.transaction_reference}</div>
                    </div>
                    ` : ''}
                    <hr>
                    <div class="row">
                        <div class="col-6"><strong>Recorded By:</strong></div>
                        <div class="col-6">${data.recorded_by}</div>
                    </div>
                    ${paymentStatusMessage}
                    <div class="text-center mt-4">
                        <small>Thank you for your payment!</small>
                    </div>
                </div>
            `;
            $('#printReceiptModalBody').html(receiptContent);
            $('#printReceiptModal').modal('show');
        },
        error: function() {
            alert('Error loading receipt data');
        }
    });
}


function openRefundModal(paymentId) {
    currentPaymentId = paymentId;
    
    // Get payment details to extract booking info
    $.ajax({
        url: '/properties/api/payment-details/' + paymentId + '/',
        method: 'GET',
        success: function(data) {
            // Calculate amounts
            const totalAmount = parseFloat(data.booking.total_amount);
            const paidAmount = parseFloat(data.booking.paid_amount);
            const currentPaymentAmount = parseFloat(data.amount);
            
            // Check if there's an extra payment (overpayment)
            const extraPayment = paidAmount - totalAmount;
            const hasExtraPayment = extraPayment > 0;
            
            // Clear form and remove any previous info text
            $('#refundPaymentForm')[0].reset();
            $('.text-info').remove(); // Remove any previous info text
            const now = new Date();
            const dateTimeString = now.toISOString().slice(0, 16);
            $('#refundDate').val(dateTimeString);
            
            // Auto-generate refund reference
            generateRefundReference();
            
            if (hasExtraPayment) {
                // Auto-fill with extra payment amount
                $('#refundAmount').val(extraPayment.toFixed(2));
                $('#refundAmount').attr('readonly', true);
                $('#refundAmount').attr('max', extraPayment);
                $('#refundAmount').attr('placeholder', `Extra payment: Tsh${extraPayment.toFixed(2)}`);
                
                // Show info about extra payment
                $('#refundAmount').after('<small class="text-info d-block mt-1">Auto-filled: Extra payment detected (Tsh' + extraPayment.toFixed(2) + ')</small>');
            } else {
                // Allow manual entry up to paid amount
                $('#refundAmount').attr('max', paidAmount);
                $('#refundAmount').attr('placeholder', `Max refund: Tsh${paidAmount.toFixed(2)}`);
                $('#refundAmount').val(''); // Clear for manual entry
                $('#refundAmount').attr('readonly', false);
            }
            
            $('#refundPaymentModal').modal('show');
        },
        error: function() {
            alert('Error loading payment details');
        }
    });
}

function generateRefundReference() {
    // Generate refund reference using current timestamp for uniqueness
    const now = new Date();
    const timestamp = now.getTime().toString().slice(-6); // Last 6 digits of timestamp
    const refundRef = 'REF-' + timestamp;
    $('#refundReference').val(refundRef);
}


function submitRefund() {
    const formData = {
        amount: $('#refundAmount').val(),
        refund_method: $('#refundMethod').val(),
        refund_reference: $('#refundReference').val(),
        refund_date: $('#refundDate').val(),
        reason: $('#refundReason').val(),
        payment_id: currentPaymentId
    };
    
    if (!formData.amount || !formData.refund_method || !formData.refund_date || !formData.reason) {
        alert('Please fill in all required fields');
        return;
    }
    
    if (!confirm('Are you sure you want to process this refund? This action cannot be undone.')) {
        return;
    }
    
    $.ajax({
        url: '/properties/api/process-refund/',
        method: 'POST',
        data: formData,
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            alert('Refund processed successfully!');
            $('#refundPaymentModal').modal('hide');
            location.reload(); // Refresh to show updated data
        },
        error: function() {
            alert('Error processing refund');
        }
    });
}

function printReceipt() {
    $('#viewPaymentModal').modal('hide');
    setTimeout(function() {
        $('#printReceiptModal').modal('show');
    }, 300);
}

</script>
{% endblock %}
