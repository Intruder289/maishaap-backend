{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}Hotel Payments{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-money-bill-wave text-primary me-2"></i>Hotel Payments
                    </h2>
                    <p class="text-muted mb-0">Track payments, transactions, and financial records</p>
                </div>
                <div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#recordPaymentModal">
                        <i class="fas fa-plus me-2"></i>Record Payment
                    </button>
                </div>
            </div>
            
            <!-- Payment Stats -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">Tsh{{ total_amount|floatformat:0 }}</h4>
                                    <p class="mb-0">Total Revenue</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-dollar-sign fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">{{ total_payments }}</h4>
                                    <p class="mb-0">Total Payments</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-chart-line fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">{{ paid_bookings }}</h4>
                                    <p class="mb-0">Paid Bookings</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">{{ payments|length }}</h4>
                                    <p class="mb-0">Active Records</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-list fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filter Section -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Search</label>
                            <input type="text" class="form-control" id="paymentSearch" placeholder="Search payments...">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Payment Method</label>
                            <select class="form-select" id="methodFilter">
                                <option value="">All Methods</option>
                                <option value="cash">Cash</option>
                                <option value="card">Card</option>
                                <option value="mobile_money">Mobile Money</option>
                                <option value="bank_transfer">Bank Transfer</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Payment Type</label>
                            <select class="form-select" id="typeFilter">
                                <option value="">All Types</option>
                                <option value="deposit">Deposit</option>
                                <option value="partial">Partial</option>
                                <option value="full">Full Payment</option>
                                <option value="refund">Refund</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Date Range</label>
                            <select class="form-select" id="dateFilter">
                                <option value="">All Time</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                    <i class="fas fa-times me-1"></i>Clear
                                </button>
                                <button class="btn btn-outline-primary" onclick="exportPayments()">
                                    <i class="fas fa-download me-1"></i>Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Payments Table -->
            <div class="card">
                <div class="card-header">
                    <div class="row flex-between-center">
                        <div class="col">
                            <h6 class="mb-2">Payment Records</h6>
                            <h5 class="mb-0">Manage hotel payments and track transactions</h5>
                        </div>
                        <div class="col-auto">
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#recordPaymentModal">
                                <span class="fas fa-plus me-2"></span>Record Payment
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="paymentsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Payment</th>
                                    <th>Booking</th>
                                    <th>Customer</th>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Recorded By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in payments %}
                                <tr data-payment-id="{{ payment.id }}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3 fw-bold">
                                                {{ payment.id }}
                                            </div>
                                            <div>
                                                <strong>
                                                    <a href="#" class="text-decoration-none" onclick="openViewModal({{ payment.id }})">
                                                        Payment #{{ payment.id }}
                                                    </a>
                                                </strong>
                                                <div class="text-muted small">{{ payment.transaction_reference|default:"No reference" }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-bed text-muted me-2"></i>
                                            <div>
                                                <div class="fw-bold">{{ payment.booking.booking_reference }}</div>
                                                <div class="text-muted small">{{ payment.booking.room_number|default:"Room N/A" }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-user text-muted me-2"></i>
                                            <div>
                                                <div class="fw-bold">{{ payment.booking.customer.full_name }}</div>
                                                <div class="text-muted small">{{ payment.booking.customer.email }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <strong>Tsh{{ payment.amount|floatformat:2 }}</strong>
                                    </td>
                                    <td>
                                        {% if payment.payment_method == 'cash' %}
                                        <span class="badge bg-success">{{ payment.get_payment_method_display }}</span>
                                        {% elif payment.payment_method == 'card' %}
                                        <span class="badge bg-info">{{ payment.get_payment_method_display }}</span>
                                        {% elif payment.payment_method == 'mobile_money' %}
                                        <span class="badge bg-warning">{{ payment.get_payment_method_display }}</span>
                                        {% elif payment.payment_method == 'bank_transfer' %}
                                        <span class="badge bg-primary">{{ payment.get_payment_method_display }}</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ payment.get_payment_method_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if payment.payment_type == 'full' %}
                                        <span class="badge bg-success">{{ payment.get_payment_type_display }}</span>
                                        {% elif payment.payment_type == 'partial' %}
                                        <span class="badge bg-warning">{{ payment.get_payment_type_display }}</span>
                                        {% elif payment.payment_type == 'deposit' %}
                                        <span class="badge bg-info">{{ payment.get_payment_type_display }}</span>
                                        {% elif payment.payment_type == 'refund' %}
                                        <span class="badge bg-danger">{{ payment.get_payment_type_display }}</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ payment.get_payment_type_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if payment.status == 'active' %}
                                        <span class="badge bg-success">Active</span>
                                        {% elif payment.status == 'refunded' %}
                                        <span class="badge bg-danger">Refunded</span>
                                        {% elif payment.status == 'cancelled' %}
                                        <span class="badge bg-secondary">Cancelled</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ payment.get_status_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="text-muted small">
                                            {{ payment.payment_date|date:"M d, Y" }}<br>
                                            {{ payment.payment_date|time:"g:i A" }}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="text-muted small">
                                            {{ payment.recorded_by.get_full_name|default:payment.recorded_by.username }}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="openViewModal({{ payment.id }})">
                                                    <i class="fas fa-eye me-2"></i>View Details
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="openPrintModal({{ payment.id }})">
                                                    <i class="fas fa-receipt me-2"></i>Print Receipt
                                                </a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item text-danger" href="#" onclick="openRefundModal({{ payment.id }})">
                                                    <i class="fas fa-undo me-2"></i>Refund
                                                </a></li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="text-center py-4">
                                        <div class="text-muted">
                                            <i class="fas fa-inbox fa-2x mb-3"></i>
                                            <p>No payment records found matching your criteria.</p>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Record Payment Modal -->
<div class="modal fade" id="recordPaymentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Record Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="recordPaymentForm">
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Booking Reference *</label>
                            <select class="form-control" id="bookingReference" required>
                                <option value="">Select Booking</option>
                                {% for booking in bookings %}
                                <option value="{{ booking.id }}" data-reference="{{ booking.booking_reference }}" data-customer="{{ booking.customer.full_name }}" data-room="{{ booking.room_number|default:'N/A' }}" data-total-amount="{{ booking.total_amount }}" data-paid-amount="{{ booking.paid_amount }}">
                                    {{ booking.booking_reference }} - {{ booking.customer.full_name }} ({{ booking.room_number|default:"Room N/A" }}) - Tsh{{ booking.total_amount }}
                                </option>
                                {% empty %}
                                <option value="" disabled>No bookings available</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Amount *</label>
                            <input type="number" class="form-control" id="paymentAmount" step="0.01" min="0" required readonly>
                            <small class="text-muted">Auto-calculated remaining amount (non-editable)</small>
                            <div id="balanceInfo" class="mt-2" style="display: none;">
                                <div class="alert alert-info py-2">
                                    <small>
                                        <strong>Total:</strong> <span id="totalAmountDisplay"></span><br>
                                        <strong>Paid:</strong> <span id="paidAmountDisplay"></span><br>
                                        <strong>Remaining:</strong> <span id="remainingAmountDisplay"></span>
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Payment Method *</label>
                            <select class="form-control" id="paymentMethod" required>
                                <option value="">Select Method</option>
                                <option value="cash">Cash</option>
                                <option value="card">Card</option>
                                <option value="mobile_money">Mobile Money</option>
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="check">Check</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Payment Type *</label>
                            <select class="form-control" id="paymentType" required>
                                <option value="full" selected>Full Payment</option>
                                <option value="partial">Partial Payment</option>
                                <option value="deposit">Deposit</option>
                                <option value="refund">Refund</option>
                            </select>
                        </div>
                        <div class="col-md-6" id="partialAmountDiv" style="display: none;">
                            <label class="form-label">Partial Amount *</label>
                            <input type="number" class="form-control" id="partialAmount" step="0.01" min="0" placeholder="Enter partial amount">
                            <small class="text-muted">Enter the amount customer wants to pay now</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Transaction Reference</label>
                            <input type="text" class="form-control" id="transactionReference" placeholder="Transaction ID or reference" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Payment Date *</label>
                            <input type="datetime-local" class="form-control" id="paymentDate" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" id="paymentNotes" rows="3" placeholder="Additional notes about this payment..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitRecordPayment()">Record Payment</button>
            </div>
        </div>
    </div>
</div>

<!-- View Payment Details Modal -->
<div class="modal fade" id="viewPaymentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Payment Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewPaymentModalBody">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="printReceipt()">Print Receipt</button>
            </div>
        </div>
    </div>
</div>

<!-- Print Receipt Modal -->
<div class="modal fade" id="printReceiptModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Print Receipt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="printReceiptModalBody">
                <!-- Receipt content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="window.print()">Print</button>
            </div>
        </div>
    </div>
</div>

<!-- Refund Payment Modal -->
<div class="modal fade" id="refundPaymentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Process Refund</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This action will process a refund for the selected payment. This action cannot be undone.
                </div>
                <form id="refundPaymentForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Refund Amount *</label>
                            <input type="number" class="form-control" id="refundAmount" step="0.01" min="0" required>
                            <small class="text-muted">Auto-filled for extra payments, manual entry for normal refunds</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Refund Method *</label>
                            <select class="form-control" id="refundMethod" required>
                                <option value="">Select Method</option>
                                <option value="cash">Cash</option>
                                <option value="card">Card Refund</option>
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="mobile_money">Mobile Money</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Refund Reference</label>
                            <input type="text" class="form-control" id="refundReference" readonly placeholder="Auto-generated">
                            <small class="text-muted">Automatically generated</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Refund Date *</label>
                            <input type="datetime-local" class="form-control" id="refundDate" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Reason for Refund *</label>
                            <textarea class="form-control" id="refundReason" rows="3" placeholder="Please provide a reason for this refund..." required></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitRefund()">Process Refund</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPaymentId = null;

$(document).ready(function() {
    console.log('Hotel Payments page initialized');
    
    // Set current date/time for modals
    const now = new Date();
    const dateTimeString = now.toISOString().slice(0, 16);
    $('#refundDate, #paymentDate').val(dateTimeString);
    
    // Reset payment form when modal is opened
    $('#recordPaymentModal').on('show.bs.modal', function() {
        // Clear form and reset state
        $('#recordPaymentForm')[0].reset();
        $('.fully-paid-warning').remove();
        $('.form-control').removeClass('is-invalid').prop('disabled', false);
        $('button[onclick="submitRecordPayment()"]').prop('disabled', false).text('Record Payment');
        $('#balanceInfo').hide();
        
        // Set current date/time
        $('#paymentDate').val(dateTimeString);
    });
    
    // Auto-fill Transaction Reference and Amount when booking is selected
    $('#bookingReference').on('change', function() {
        const selectedOption = $(this).find('option:selected');
        const bookingReference = selectedOption.data('reference');
        const totalAmount = parseFloat(selectedOption.data('total-amount')) || 0;
        const paidAmount = parseFloat(selectedOption.data('paid-amount')) || 0;
        
        // Remove any existing fully paid warnings
        $('.fully-paid-warning').remove();
        $('.form-control').removeClass('is-invalid');
        
        if (bookingReference) {
            $('#transactionReference').val(bookingReference);
            
            // Calculate remaining amount
            const remainingAmount = totalAmount - paidAmount;
            
            // Check if booking is fully paid
            if (remainingAmount <= 0) {
                // Show fully paid warning
                const warningHtml = `
                    <div class="alert alert-warning fully-paid-warning mt-2" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Booking ${bookingReference} is already fully paid!</strong><br>
                        Total: Tsh ${totalAmount.toFixed(2)} | Paid: Tsh ${paidAmount.toFixed(2)} | Remaining: Tsh 0.00<br>
                        <small>Please start a new booking for additional payments.</small>
                    </div>
                `;
                $('#bookingReference').after(warningHtml);
                
                // Disable form fields
                $('#paymentAmount, #paymentMethod, #paymentType, #partialAmount').prop('disabled', true).addClass('is-invalid');
                $('button[onclick="submitRecordPayment()"]').prop('disabled', true).text('Booking Fully Paid');
                
                // Set values to show the fully paid status
                $('#paymentAmount').val(totalAmount);
                $('#partialAmount').val(0);
                
                // Show balance information
                $('#totalAmountDisplay').text(`Tsh${totalAmount.toFixed(2)}`);
                $('#paidAmountDisplay').text(`Tsh${paidAmount.toFixed(2)}`);
                $('#remainingAmountDisplay').text(`Tsh0.00`);
                $('#balanceInfo').show();
                
                return; // Exit early for fully paid bookings
            }
            
            // For bookings with remaining balance
            $('#paymentAmount').val(remainingAmount);
            $('#partialAmount').attr('max', remainingAmount);
            $('#partialAmount').attr('placeholder', `Max: Tsh${remainingAmount.toFixed(2)}`);
            
            // Show balance information
            $('#totalAmountDisplay').text(`Tsh${totalAmount.toFixed(2)}`);
            $('#paidAmountDisplay').text(`Tsh${paidAmount.toFixed(2)}`);
            $('#remainingAmountDisplay').text(`Tsh${remainingAmount.toFixed(2)}`);
            $('#balanceInfo').show();
            
            // Enable form fields
            $('#paymentAmount, #paymentMethod, #paymentType, #partialAmount').prop('disabled', false).removeClass('is-invalid');
            $('button[onclick="submitRecordPayment()"]').prop('disabled', false).text('Record Payment');
            
        } else {
            $('#transactionReference').val('');
            $('#paymentAmount').val('');
            $('#partialAmount').val('');
            $('#balanceInfo').hide();
            
            // Enable form fields
            $('#paymentAmount, #paymentMethod, #paymentType, #partialAmount').prop('disabled', false).removeClass('is-invalid');
            $('button[onclick="submitRecordPayment()"]').prop('disabled', false).text('Record Payment');
        }
    });
    
    // Show/hide partial amount input based on payment type
    $('#paymentType').on('change', function() {
        const paymentType = $(this).val();
        if (paymentType === 'partial') {
            $('#partialAmountDiv').show();
            $('#partialAmount').prop('required', true);
            
            // Set max amount to remaining balance
            const selectedOption = $('#bookingReference').find('option:selected');
            const totalAmount = parseFloat(selectedOption.data('total-amount')) || 0;
            const paidAmount = parseFloat(selectedOption.data('paid-amount')) || 0;
            const remainingAmount = totalAmount - paidAmount;
            
            $('#partialAmount').attr('max', remainingAmount);
            $('#partialAmount').attr('placeholder', `Max: Tsh${remainingAmount.toFixed(2)}`);
        } else {
            $('#partialAmountDiv').hide();
            $('#partialAmount').prop('required', false);
            $('#partialAmount').val('');
        }
    });
    
    // Filter functionality
    $('#paymentSearch, #methodFilter, #typeFilter, #dateFilter').on('change keyup', function() {
        filterPayments();
    });
    
    function filterPayments() {
        const searchTerm = $('#paymentSearch').val().toLowerCase();
        const methodFilter = $('#methodFilter').val();
        const typeFilter = $('#typeFilter').val();
        const dateFilter = $('#dateFilter').val();
        
        $('#paymentsTable tbody tr').each(function() {
            let showRow = true;
            const row = $(this);
            
            // Search filter
            if (searchTerm && !row.text().toLowerCase().includes(searchTerm)) {
                showRow = false;
            }
            
            // Method filter
            if (methodFilter && !row.find('td:nth-child(5)').text().toLowerCase().includes(methodFilter)) {
                showRow = false;
            }
            
            // Type filter
            if (typeFilter && !row.find('td:nth-child(6)').text().toLowerCase().includes(typeFilter)) {
                showRow = false;
            }
            
            row.toggle(showRow);
        });
    }
    
    // Clear filters
    window.clearFilters = function() {
        $('#paymentSearch, #methodFilter, #typeFilter, #dateFilter').val('');
        $('#paymentsTable tbody tr').show();
    };
    
    // Export payments
    window.exportPayments = function() {
        alert('Export functionality will be implemented');
    };
});

// Modal functions
function openViewModal(paymentId) {
    currentPaymentId = paymentId;
    
    // Fetch payment details via AJAX
    $.ajax({
        url: '/properties/api/payment-details/' + paymentId + '/',
        method: 'GET',
        success: function(data) {
            const modalBody = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Payment Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Payment ID:</strong></td><td>#${data.id}</td></tr>
                            <tr><td><strong>Amount:</strong></td><td>Tsh${data.amount}</td></tr>
                            <tr><td><strong>Method:</strong></td><td>${data.payment_method_display}</td></tr>
                            <tr><td><strong>Type:</strong></td><td>${data.payment_type_display}</td></tr>
                            <tr><td><strong>Date:</strong></td><td>${data.payment_date}</td></tr>
                            <tr><td><strong>Reference:</strong></td><td>${data.transaction_reference || 'N/A'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Booking Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Booking:</strong></td><td>${data.booking.booking_reference}</td></tr>
                            <tr><td><strong>Room:</strong></td><td>${data.booking.room_number || 'N/A'}</td></tr>
                            <tr><td><strong>Check-in:</strong></td><td>${data.booking.check_in_date}</td></tr>
                            <tr><td><strong>Check-out:</strong></td><td>${data.booking.check_out_date}</td></tr>
                            <tr><td><strong>Total Amount:</strong></td><td>Tsh${data.booking.total_amount}</td></tr>
                        </table>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6>Customer Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Name:</strong></td><td>${data.booking.customer.full_name || data.booking.customer.username}</td></tr>
                            <tr><td><strong>Email:</strong></td><td>${data.booking.customer.email}</td></tr>
                            <tr><td><strong>Phone:</strong></td><td>${data.booking.customer.phone || 'N/A'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Staff Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Recorded By:</strong></td><td>${data.recorded_by}</td></tr>
                            <tr><td><strong>Created:</strong></td><td>${data.created_at}</td></tr>
                        </table>
                    </div>
                </div>
                ${data.notes ? `<div class="mt-3"><h6>Notes</h6><p class="text-muted">${data.notes}</p></div>` : ''}
            `;
            $('#viewPaymentModalBody').html(modalBody);
            $('#viewPaymentModal').modal('show');
        },
        error: function() {
            alert('Error loading payment details');
        }
    });
}

function openPrintModal(paymentId) {
    currentPaymentId = paymentId;
    
    // Fetch payment details for receipt
    $.ajax({
        url: '/properties/api/payment-details/' + paymentId + '/',
        method: 'GET',
        success: function(data) {
            // Calculate remaining balance and payment status
            const totalAmount = data.booking.total_amount;
            const paidAmount = data.booking.paid_amount;
            const remainingBalance = totalAmount - paidAmount;
            const isFullyPaid = remainingBalance <= 0;
            
            // Determine payment status message
            let paymentStatusMessage = '';
            if (isFullyPaid) {
                paymentStatusMessage = '<div class="alert alert-success text-center mt-3"><strong>✓ PAYMENT COMPLETE</strong><br>You have paid the full amount for this booking.</div>';
            } else {
                paymentStatusMessage = `<div class="alert alert-warning text-center mt-3"><strong>⚠ PARTIAL PAYMENT</strong><br>Amount remaining: <strong>Tsh${remainingBalance.toFixed(2)}</strong></div>`;
            }
            
            const receiptContent = `
                <div class="receipt-content" style="font-family: monospace;">
                    <div class="text-center mb-4">
                        <h4>PAYMENT RECEIPT</h4>
                        <hr>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Receipt #:</strong></div>
                        <div class="col-6">${data.id}</div>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Date:</strong></div>
                        <div class="col-6">${data.payment_date}</div>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Booking:</strong></div>
                        <div class="col-6">${data.booking.booking_reference}</div>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Customer:</strong></div>
                        <div class="col-6">${data.booking.customer.full_name || data.booking.customer.username}</div>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Room:</strong></div>
                        <div class="col-6">${data.booking.room_number || 'N/A'}</div>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Check-in:</strong></div>
                        <div class="col-6">${data.booking.check_in_date}</div>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Check-out:</strong></div>
                        <div class="col-6">${data.booking.check_out_date}</div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-6"><strong>Total Booking Amount:</strong></div>
                        <div class="col-6"><strong>Tsh${totalAmount.toFixed(2)}</strong></div>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Amount Paid This Time:</strong></div>
                        <div class="col-6"><strong>Tsh${data.amount}</strong></div>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Total Paid So Far:</strong></div>
                        <div class="col-6"><strong>Tsh${paidAmount.toFixed(2)}</strong></div>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Remaining Balance:</strong></div>
                        <div class="col-6"><strong>Tsh${remainingBalance.toFixed(2)}</strong></div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-6"><strong>Payment Method:</strong></div>
                        <div class="col-6">${data.payment_method_display}</div>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Payment Type:</strong></div>
                        <div class="col-6">${data.payment_type_display}</div>
                    </div>
                    ${data.transaction_reference ? `
                    <div class="row">
                        <div class="col-6"><strong>Reference:</strong></div>
                        <div class="col-6">${data.transaction_reference}</div>
                    </div>
                    ` : ''}
                    <hr>
                    <div class="row">
                        <div class="col-6"><strong>Recorded By:</strong></div>
                        <div class="col-6">${data.recorded_by}</div>
                    </div>
                    ${paymentStatusMessage}
                    <div class="text-center mt-4">
                        <small>Thank you for your payment!</small>
                    </div>
                </div>
            `;
            $('#printReceiptModalBody').html(receiptContent);
            $('#printReceiptModal').modal('show');
        },
        error: function() {
            alert('Error loading receipt data');
        }
    });
}


function openRefundModal(paymentId) {
    currentPaymentId = paymentId;
    
    // Get payment details to extract booking info
    $.ajax({
        url: '/properties/api/payment-details/' + paymentId + '/',
        method: 'GET',
        success: function(data) {
            // Calculate amounts
            const totalAmount = parseFloat(data.booking.total_amount);
            const paidAmount = parseFloat(data.booking.paid_amount);
            const currentPaymentAmount = parseFloat(data.amount);
            
            // Check if there's an extra payment (overpayment)
            const extraPayment = paidAmount - totalAmount;
            const hasExtraPayment = extraPayment > 0;
            
            // Clear form and remove any previous info text
            $('#refundPaymentForm')[0].reset();
            $('.text-info').remove(); // Remove any previous info text
            const now = new Date();
            const dateTimeString = now.toISOString().slice(0, 16);
            $('#refundDate').val(dateTimeString);
            
            // Auto-generate refund reference
            generateRefundReference();
            
            if (hasExtraPayment) {
                // Auto-fill with extra payment amount
                $('#refundAmount').val(extraPayment.toFixed(2));
                $('#refundAmount').attr('readonly', true);
                $('#refundAmount').attr('max', extraPayment);
                $('#refundAmount').attr('placeholder', `Extra payment: Tsh${extraPayment.toFixed(2)}`);
                
                // Show info about extra payment
                $('#refundAmount').after('<small class="text-info d-block mt-1">Auto-filled: Extra payment detected (Tsh' + extraPayment.toFixed(2) + ')</small>');
            } else {
                // Allow manual entry up to paid amount
                $('#refundAmount').attr('max', paidAmount);
                $('#refundAmount').attr('placeholder', `Max refund: Tsh${paidAmount.toFixed(2)}`);
                $('#refundAmount').val(''); // Clear for manual entry
                $('#refundAmount').attr('readonly', false);
            }
            
            $('#refundPaymentModal').modal('show');
        },
        error: function() {
            alert('Error loading payment details');
        }
    });
}

function generateRefundReference() {
    // Generate refund reference using current timestamp for uniqueness
    const now = new Date();
    const timestamp = now.getTime().toString().slice(-6); // Last 6 digits of timestamp
    const refundRef = 'REF-' + timestamp;
    $('#refundReference').val(refundRef);
}


function submitRefund() {
    const formData = {
        amount: $('#refundAmount').val(),
        refund_method: $('#refundMethod').val(),
        refund_reference: $('#refundReference').val(),
        refund_date: $('#refundDate').val(),
        reason: $('#refundReason').val(),
        payment_id: currentPaymentId
    };
    
    if (!formData.amount || !formData.refund_method || !formData.refund_date || !formData.reason) {
        alert('Please fill in all required fields');
        return;
    }
    
    if (!confirm('Are you sure you want to process this refund? This action cannot be undone.')) {
        return;
    }
    
    $.ajax({
        url: '/properties/api/process-refund/',
        method: 'POST',
        data: formData,
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            alert('Refund processed successfully!');
            $('#refundPaymentModal').modal('hide');
            location.reload(); // Refresh to show updated data
        },
        error: function() {
            alert('Error processing refund');
        }
    });
}

function printReceipt() {
    $('#viewPaymentModal').modal('hide');
    setTimeout(function() {
        $('#printReceiptModal').modal('show');
    }, 300);
}

function submitRecordPayment() {
    // Prevent double submission
    const submitBtn = $('button[onclick="submitRecordPayment()"]');
    if (submitBtn.prop('disabled')) {
        return;
    }
    submitBtn.prop('disabled', true).text('Processing...');
    
    const paymentType = $('#paymentType').val();
    let amount = $('#paymentAmount').val();
    
    // If partial payment, use the partial amount instead
    if (paymentType === 'partial') {
        const partialAmount = $('#partialAmount').val();
        if (!partialAmount || parseFloat(partialAmount) <= 0) {
            alert('Please enter a valid partial amount');
            submitBtn.prop('disabled', false).text('Record Payment');
            return;
        }
        amount = partialAmount;
    }
    
    const formData = {
        booking_id: $('#bookingReference').val(),
        amount: amount,
        payment_method: $('#paymentMethod').val(),
        payment_type: paymentType,
        transaction_reference: $('#transactionReference').val(),
        payment_date: $('#paymentDate').val(),
        notes: $('#paymentNotes').val()
    };
    
    // Debug: Log form data to console
    console.log('Form Data:', formData);
    
    // Check each required field individually
    const missingFields = [];
    if (!formData.booking_id) missingFields.push('Booking Reference');
    if (!formData.amount || parseFloat(formData.amount) <= 0) missingFields.push('Amount');
    if (!formData.payment_method) missingFields.push('Payment Method');
    if (!formData.payment_type) missingFields.push('Payment Type');
    if (!formData.payment_date) missingFields.push('Payment Date');
    
    if (missingFields.length > 0) {
        alert('Please fill in the following required fields:\n' + missingFields.join('\n'));
        submitBtn.prop('disabled', false).text('Record Payment');
        return;
    }
    
    // Check if booking is already fully paid before submitting
    const bookingId = formData.booking_id;
    if (bookingId) {
        // Get booking details to check payment status
        $.ajax({
            url: `/properties/api/booking-status/${bookingId}/`,
            method: 'GET',
            success: function(response) {
                if (response.payment_status === 'paid') {
                    alert(`Booking ${response.booking_reference} is already fully paid (Tsh${response.total_amount}). Please start a new booking for additional payments.`);
                    submitBtn.prop('disabled', false).text('Record Payment');
                    return;
                }
                // If not fully paid, proceed with payment submission
                proceedWithPaymentSubmission(formData, submitBtn);
            },
            error: function() {
                // If we can't check status, proceed anyway (backend will validate)
                proceedWithPaymentSubmission(formData, submitBtn);
            }
        });
    } else {
        // If no booking ID, proceed with payment submission
        proceedWithPaymentSubmission(formData, submitBtn);
    }
}

function proceedWithPaymentSubmission(formData, submitBtn) {
    $.ajax({
        url: '/properties/api/collect-payment/',
        method: 'POST',
        data: formData,
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            alert('Payment recorded successfully!');
            $('#recordPaymentModal').modal('hide');
            location.reload(); // Refresh to show new payment
        },
        error: function(xhr, status, error) {
            let errorMessage = 'Error recording payment';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMessage = xhr.responseJSON.error;
            }
            alert(errorMessage);
            console.error('Payment error:', xhr.responseText);
            submitBtn.prop('disabled', false).text('Record Payment');
        }
    });
}
</script>
{% endblock %}
