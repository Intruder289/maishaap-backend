{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}Lodge Bookings Management{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header">
    <div class="row flex-between-center">
      <div class="col">
        <h6 class="mb-2">Lodge Bookings Management</h6>
        <h5 class="mb-0">Manage lodge bookings, check-ins, check-outs, and outdoor activities</h5>
      </div>
      <div class="col-auto">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newBookingModal">
          <span class="fas fa-plus me-2"></span>New Booking
        </button>
      </div>
    </div>
  </div>
  
  <!-- Search and Filters -->
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-3">
        <label for="bookingSearch" class="form-label">Search</label>
        <input type="text" class="form-control" id="bookingSearch" placeholder="Search bookings...">
      </div>
      <div class="col-md-3">
        <label for="statusFilter" class="form-label">Status</label>
        <select class="form-select" id="statusFilter">
          <option value="">All Status</option>
          <option value="pending">Pending</option>
          <option value="confirmed">Confirmed</option>
          <option value="checked_in">Checked In</option>
          <option value="checked_out">Checked Out</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="checkinFilter" class="form-label">Check-in Date</label>
        <input type="date" class="form-control" id="checkinFilter">
      </div>
      <div class="col-md-2">
        <label for="paymentFilter" class="form-label">Payment Status</label>
        <select class="form-select" id="paymentFilter">
          <option value="">All Payments</option>
          <option value="pending">Pending</option>
          <option value="partial">Partial</option>
          <option value="paid">Paid</option>
        </select>
      </div>
      <div class="col-md-1">
        <label class="form-label">&nbsp;</label>
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" id="showDeletedFilter" {% if show_deleted %}checked{% endif %}>
          <label class="form-check-label" for="showDeletedFilter" title="Check this to view soft-deleted bookings">
            Show Deleted
          </label>
        </div>
        {% if show_deleted %}
        <small class="text-muted d-block mt-1">
          <i class="fas fa-info-circle"></i> Showing deleted bookings
        </small>
        {% endif %}
      </div>
    </div>
  </div>
  
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Booking Ref</th>
            <th>Customer</th>
            <th>Property</th>
            <th>Check-in</th>
            <th>Check-out</th>
            <th>Guests</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Payment</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for booking in bookings %}
          <tr data-booking-id="{{ booking.id }}" {% if booking.is_deleted %}class="table-secondary opacity-75"{% endif %}>
            <td>
              <div class="d-flex align-items-center">
                <span class="badge bg-primary me-2">{{ booking.booking_reference }}</span>
                {% if booking.is_deleted %}
                <span class="badge bg-danger ms-1" title="This booking has been soft deleted">
                  <i class="fas fa-trash"></i> Deleted
                </span>
                {% endif %}
              </div>
            </td>
            <td>
              <div class="d-flex align-items-center">
                <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3 fw-bold">
                  {{ booking.customer.full_name|first|upper }}
                </div>
                <div>
                  <strong>{{ booking.customer.full_name }}</strong>
                  <div class="text-muted small">{{ booking.customer.email|default:booking.customer.phone }}</div>
                </div>
              </div>
            </td>
            <td>
              {% if booking.property_obj %}
              <div class="d-flex align-items-center">
                <i class="fas fa-home text-muted me-2"></i>
                <div>
                  <div class="fw-bold">{{ booking.property_obj.title }}</div>
                  <div class="text-muted small">{{ booking.property_obj.address|truncatechars:30 }}</div>
                </div>
              </div>
              {% else %}
              <span class="text-muted">No property</span>
              {% endif %}
            </td>
            <td>{{ booking.check_in_date|date:"M d, Y" }}</td>
            <td>{{ booking.check_out_date|date:"M d, Y" }}</td>
            <td>
              <div class="text-muted small">
                <i class="fas fa-users me-1"></i>{{ booking.number_of_guests }} {{ booking.number_of_guests|pluralize:"guest,guests" }}
              </div>
            </td>
            <td>
              {% if booking.calculated_total_amount and booking.calculated_total_amount > 0 %}
                <div class="fw-bold">Tsh{{ booking.calculated_total_amount|floatformat:2 }}</div>
              {% else %}
                <div class="fw-bold">Tsh{{ booking.total_amount|floatformat:2 }}</div>
              {% endif %}
              <div class="text-muted small">Duration: {{ booking.duration_days }} {{ booking.duration_days|pluralize:"day,days" }}</div>
            </td>
            <td>
              {% if booking.booking_status == 'checked_in' %}
              <span class="badge bg-success">{{ booking.get_booking_status_display }}</span>
              {% elif booking.booking_status == 'checked_out' %}
              <span class="badge bg-secondary">{{ booking.get_booking_status_display }}</span>
              {% elif booking.booking_status == 'confirmed' %}
              <span class="badge bg-primary">{{ booking.get_booking_status_display }}</span>
              {% elif booking.booking_status == 'cancelled' %}
              <span class="badge bg-danger">{{ booking.get_booking_status_display }}</span>
              {% else %}
              <span class="badge bg-warning">{{ booking.get_booking_status_display }}</span>
              {% endif %}
            </td>
            <td>
              {% if booking.payment_status == 'paid' %}
              <span class="badge bg-success">{{ booking.get_payment_status_display }}</span>
              {% elif booking.payment_status == 'partial' %}
              <span class="badge bg-warning">{{ booking.get_payment_status_display }}</span>
              {% else %}
              <span class="badge bg-danger">{{ booking.get_payment_status_display }}</span>
              {% endif %}
            </td>
            <td>
              <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="#" onclick="viewLodgeBooking({{ booking.id }})"><i class="fas fa-eye me-2"></i>View Details</a></li>
                  <li><a class="dropdown-item" href="#" onclick="editLodgeBooking({{ booking.id }})"><i class="fas fa-edit me-2"></i>Edit</a></li>
                  {% if booking.booking_status == 'confirmed' %}
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="#" onclick="checkinLodgeBooking({{ booking.id }})"><i class="fas fa-sign-in-alt me-2"></i>Check-in</a></li>
                  {% elif booking.booking_status == 'checked_in' %}
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="#" onclick="checkoutLodgeBooking({{ booking.id }})"><i class="fas fa-sign-out-alt me-2"></i>Check-out</a></li>
                  {% endif %}
                  {% if booking.booking_status != 'cancelled' %}
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item text-danger" href="#" onclick="cancelLodgeBooking({{ booking.id }})"><i class="fas fa-times me-2"></i>Cancel</a></li>
                  {% endif %}
                  {% if booking.booking_status == 'cancelled' or booking.booking_status == 'checked_out' %}
                    {% if not booking.is_deleted %}
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="softDeleteLodgeBooking({{ booking.id }})"><i class="fas fa-trash me-2"></i>Delete</a></li>
                    {% endif %}
                  {% endif %}
                  {% if booking.is_deleted %}
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item text-success" href="#" onclick="restoreLodgeBooking({{ booking.id }})"><i class="fas fa-undo me-2"></i>Restore</a></li>
                  {% endif %}
                </ul>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="10" class="text-center py-4">
              <div class="text-muted">
                <i class="fas fa-calendar-times fa-2x mb-3"></i>
                <p>No lodge bookings found.</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <!-- Pagination -->
    {% if bookings.has_other_pages %}
    <div class="card-footer bg-white border-0 py-3">
      <div class="row align-items-center">
        <div class="col-md-6">
          <div class="text-muted">
            Showing {{ bookings.start_index }} to {{ bookings.end_index }} of {{ bookings.paginator.count }} entries
          </div>
        </div>
        <div class="col-md-6">
          <nav aria-label="Page navigation" class="d-flex justify-content-end">
            <ul class="pagination pagination-sm mb-0">
              {% if bookings.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page=1{% if request.GET.statusFilter %}&status={{ request.GET.statusFilter }}{% endif %}{% if request.GET.paymentFilter %}&payment_status={{ request.GET.paymentFilter }}{% endif %}" title="First Page">
                  <i class="fas fa-angle-double-left"></i>
                </a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ bookings.previous_page_number }}{% if request.GET.statusFilter %}&status={{ request.GET.statusFilter }}{% endif %}{% if request.GET.paymentFilter %}&payment_status={{ request.GET.paymentFilter }}{% endif %}" title="Previous Page">
                  <i class="fas fa-angle-left"></i>
                </a>
              </li>
              {% endif %}
              
              <!-- Page numbers -->
              {% for num in bookings.paginator.page_range %}
                {% if bookings.number == num %}
              <li class="page-item active">
                <span class="page-link">{{ num }}</span>
              </li>
                {% elif num > bookings.number|add:'-3' and num < bookings.number|add:'3' %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ num }}{% if request.GET.statusFilter %}&status={{ request.GET.statusFilter }}{% endif %}{% if request.GET.paymentFilter %}&payment_status={{ request.GET.paymentFilter }}{% endif %}">{{ num }}</a>
                </li>
                {% endif %}
              {% endfor %}
              
              {% if bookings.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ bookings.next_page_number }}{% if request.GET.statusFilter %}&status={{ request.GET.statusFilter }}{% endif %}{% if request.GET.paymentFilter %}&payment_status={{ request.GET.paymentFilter }}{% endif %}" title="Next Page">
                  <i class="fas fa-angle-right"></i>
                </a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ bookings.paginator.num_pages }}{% if request.GET.statusFilter %}&status={{ request.GET.statusFilter }}{% endif %}{% if request.GET.paymentFilter %}&payment_status={{ request.GET.paymentFilter }}{% endif %}" title="Last Page">
                  <i class="fas fa-angle-double-right"></i>
                </a>
              </li>
              {% endif %}
            </ul>
          </nav>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- New Booking Modal -->
<div class="modal fade" id="newBookingModal" tabindex="-1" aria-labelledby="newBookingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newBookingModalLabel">
                    <i class="fas fa-mountain me-2"></i>New Lodge Booking
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if selected_property %}
                    <div class="alert alert-secondary mb-3">
                        <i class="fas fa-mountain me-2"></i>
                        <strong>Lodge:</strong> {{ selected_property.title }}
                    </div>
                    <form id="newBookingForm">
                        {% csrf_token %}
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Customer Name *</label>
                                <input type="text" class="form-control" name="customer_name" id="customerName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Phone Number *</label>
                                <input type="tel" class="form-control" name="phone" id="customerPhone" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email *</label>
                                <input type="email" class="form-control" name="email" id="customerEmail" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Accommodation Type *</label>
                                <select class="form-control" id="modalRoomType" name="room_type" required>
                                    <option value="">Select Accommodation Type</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Accommodation Number *</label>
                                <select class="form-control" id="modalRoomNumber" name="room_number" required>
                                    <option value="">Please select an accommodation</option>
                                </select>
                                <div class="form-text">
                                    <strong>Accommodation Selection:</strong><br>
                                    • Available - Ready for booking<br>
                                    • Occupied - Currently booked (disabled)<br>
                                    • Maintenance - Under repair (disabled)<br>
                                    <small class="text-muted">Select a specific accommodation number for your booking</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Check-in Date *</label>
                                <input type="date" class="form-control" name="check_in_date" id="checkInDate" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Check-out Date *</label>
                                <input type="date" class="form-control" name="check_out_date" id="checkOutDate" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Number of Guests *</label>
                                <input type="number" class="form-control" name="number_of_guests" id="numberOfGuests" min="1" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Total Amount *</label>
                                <input type="text" class="form-control" name="total_amount" id="totalAmount" step="0.01" required readonly style="background-color: #f8f9fa;">
                                <div class="form-text">
                                    <small class="text-muted">Calculated automatically based on accommodation rate and number of days</small>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Special Requests</label>
                                <textarea class="form-control" name="special_requests" id="specialRequests" rows="3" placeholder="Any special requests or preferences..."></textarea>
                            </div>
                        </div>
                    </form>
                {% else %}
                    <div class="alert alert-secondary mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Lodge:</strong> Please select a lodge first
                    </div>
                    <div class="text-center py-4">
                        <i class="fas fa-mountain fa-3x text-muted mb-3"></i>
                        <h5>No Lodge Selected</h5>
                        <p class="text-muted">You need to select a lodge before creating a booking.</p>
                        <a href="{% url 'properties:lodge_select_property' %}" class="btn btn-primary">
                            <i class="fas fa-mountain me-2"></i>Select Lodge
                        </a>
                    </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                {% if selected_property %}
                    <button type="button" class="btn btn-primary" id="createBookingBtn">
                        <i class="fas fa-plus me-2"></i>Create Booking
                    </button>
                {% else %}
                    <button type="button" class="btn btn-primary" onclick="window.location.href='{% url 'properties:lodge_select_property' %}'">
                        <i class="fas fa-mountain me-2"></i>Select Lodge First
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Booking Details Modal -->
<div class="modal fade" id="lodgeBookingDetailsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Booking Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="text-center text-muted py-4">
          <i class="fas fa-spinner fa-spin me-2"></i> Loading...
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Booking Edit Modal -->
<div class="modal fade" id="lodgeBookingEditModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Booking</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="text-center text-muted py-4">
          <i class="fas fa-spinner fa-spin me-2"></i> Loading form...
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Check-in Modal -->
<div class="modal fade" id="lodgeCheckinModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Check-in Guest</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to check-in this guest?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmCheckinBtn">Confirm Check-in</button>
      </div>
    </div>
  </div>
</div>

<!-- Check-out Modal -->
<div class="modal fade" id="lodgeCheckoutModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Check-out Guest</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to check-out this guest?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmCheckoutBtn">Confirm Check-out</button>
      </div>
    </div>
  </div>
</div>

<!-- Cancel Booking Modal -->
<div class="modal fade" id="lodgeCancelBookingModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cancel Booking</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">Are you sure you want to cancel this booking? This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
        <button type="button" class="btn btn-danger" id="confirmCancelLodgeBtn">Yes, Cancel</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentLodgeBookingId = null;

// Lodge booking management functions
function viewLodgeBooking(bookingId) {
  $.get(`/properties/api/booking/${bookingId}/details/`, function(data) {
    $('#lodgeBookingDetailsModal .modal-body').html(data);
    $('#lodgeBookingDetailsModal').modal('show');
  }).fail(function() {
    showNotification('Error loading booking details', 'error');
  });
}

function editLodgeBooking(bookingId) {
  $.get(`/properties/api/booking/${bookingId}/edit/`, function(data) {
    $('#lodgeBookingEditModal .modal-body').html(data);
    $('#lodgeBookingEditModal').modal('show');
  }).fail(function() {
    showNotification('Error loading booking edit form', 'error');
  });
}

function checkinLodgeBooking(bookingId) {
  currentLodgeBookingId = bookingId;
  $('#lodgeCheckinModal').modal('show');
}

function checkoutLodgeBooking(bookingId) {
  currentLodgeBookingId = bookingId;
  $('#lodgeCheckoutModal').modal('show');
}

function softDeleteLodgeBooking(bookingId) {
    if (!confirm('Are you sure you want to delete this booking? It will be hidden from the main list but can be restored later.')) {
        return;
    }
    
    // Show loading indicator
    const loadingMsg = showNotification('Deleting booking...', 'info');
    
    $.ajax({
        url: `/properties/api/booking/${bookingId}/soft-delete/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(response) {
            if (response.success) {
                showNotification(response.message || 'Booking deleted successfully. It will be hidden from the list. Check "Show Deleted" to view it.', 'success');
                // Reload page after a short delay
                setTimeout(function() {
                    window.location.reload();
                }, 1500);
            } else {
                showNotification(response.error || 'Failed to delete booking', 'error');
            }
        },
        error: function(xhr) {
            console.error('Error soft deleting booking:', xhr);
            let errorMsg = 'Failed to delete booking';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMsg = xhr.responseJSON.error;
            } else if (xhr.status === 403) {
                errorMsg = 'Permission denied. Only admins can delete bookings.';
            } else if (xhr.status === 400) {
                errorMsg = xhr.responseJSON?.error || 'Invalid request. Booking may not be eligible for deletion.';
            }
            showNotification(errorMsg, 'error');
        }
    });
}

function restoreLodgeBooking(bookingId) {
    $.ajax({
        url: `/properties/api/booking/${bookingId}/restore/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(response) {
            if (response.success) {
                alert('Booking restored successfully');
                location.reload();
            } else {
                alert(response.error || 'Failed to restore booking');
            }
        },
        error: function(xhr) {
            const errorMsg = xhr.responseJSON?.error || 'Failed to restore booking';
            alert(errorMsg);
        }
    });
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function cancelLodgeBooking(bookingId) {
  currentLodgeBookingId = bookingId;
  $('#lodgeCancelBookingModal').modal('show');
}

function showNotification(message, type = 'info') {
  const notification = $(
    `<div class="alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed" 
       style="top: 20px; right: 20px; z-index: 9999;">
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`
  );
  $('body').append(notification);
  setTimeout(function() {
    notification.alert('close');
  }, 5000);
}

// Define jQuery alias
var $ = jQuery.noConflict();

$(document).ready(function() {
    console.log('Lodge Bookings page initialized');
    
    // Helper functions for notifications
    function showSuccessMessage(message) {
        showNotification(message, 'success');
    }
    
    function showErrorMessage(message) {
        showNotification(message, 'error');
    }
    
    // Load rooms when modal opens (only if lodge is selected)
    $('#newBookingModal').on('show.bs.modal', function(e) {
        {% if not selected_property %}
            // If no lodge selected, prevent modal from opening and redirect
            e.preventDefault();
            e.stopPropagation();
            $(this).modal('hide');
            window.location.href = '{% url "properties:lodge_select_property" %}';
            return false;
        {% else %}
            console.log('Modal opened - loading rooms...');
            loadAvailableRooms();
        {% endif %}
    });
    
    // Filter rooms by room type
    $('#modalRoomType').on('change', function() {
        filterRoomsByType();
    });
    
    // Calculate total amount when room, check-in, or check-out changes
    $('#modalRoomNumber').on('change', function() {
        console.log('Room selection changed');
        calculateTotalAmount();
    });
    
    $('#checkInDate, #checkOutDate').on('change input', function() {
        console.log('Date changed:', $(this).attr('id'), $(this).val());
        calculateTotalAmount();
    });
    
    // Also trigger calculation when modal is shown if values are already filled
    $('#newBookingModal').on('shown.bs.modal', function() {
        setTimeout(function() {
            calculateTotalAmount();
        }, 500);
    });
    
    // Handle create booking button click
    $('#createBookingBtn').on('click', function() {
        createBooking();
    });
    
    // Function to calculate total amount automatically
    function calculateTotalAmount() {
        console.log('calculateTotalAmount called');
        const roomSelect = $('#modalRoomNumber');
        const selectedRoomOption = roomSelect.find('option:selected');
        const checkInDate = $('#checkInDate').val();
        const checkOutDate = $('#checkOutDate').val();
        const totalAmountInput = $('#totalAmount');
        
        console.log('Input values:', {
            roomSelected: selectedRoomOption.val(),
            checkInDate: checkInDate,
            checkOutDate: checkOutDate
        });
        
        // Check if all required fields are filled
        if (!selectedRoomOption.val() || !checkInDate || !checkOutDate) {
            console.log('Missing required fields, clearing total amount');
            totalAmountInput.val('').removeClass('is-invalid');
            return;
        }
        
        // Get base_rate from data attribute (preferred method)
        let baseRate = parseFloat(selectedRoomOption.attr('data-base-rate'));
        console.log('Base rate from data attribute:', baseRate);
        
        // If not in data attribute, try to extract from option text
        if (isNaN(baseRate) || baseRate <= 0) {
            const optionText = selectedRoomOption.text();
            console.log('Trying to extract from option text:', optionText);
            const baseRateMatch = optionText.match(/Tsh([\d,]+\.?\d*)\/night/);
            
            if (baseRateMatch) {
                baseRate = parseFloat(baseRateMatch[1].replace(/,/g, ''));
                console.log('Extracted base rate from text:', baseRate);
            }
        }
        
        if (isNaN(baseRate) || baseRate <= 0) {
            console.warn('Invalid base rate for selected room:', baseRate);
            totalAmountInput.val('').addClass('is-invalid');
            return;
        }
        
        // Calculate number of days
        const checkIn = new Date(checkInDate + 'T00:00:00'); // Add time to avoid timezone issues
        const checkOut = new Date(checkOutDate + 'T00:00:00');
        
        console.log('Dates parsed:', {
            checkIn: checkIn,
            checkOut: checkOut
        });
        
        if (checkOut <= checkIn) {
            console.warn('Check-out date must be after check-in date');
            totalAmountInput.val('').addClass('is-invalid');
            return;
        }
        
        // Calculate difference in days
        const timeDiff = checkOut.getTime() - checkIn.getTime();
        const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
        
        console.log('Days calculated:', daysDiff);
        
        if (daysDiff <= 0) {
            console.warn('Invalid number of days:', daysDiff);
            totalAmountInput.val('').addClass('is-invalid');
            return;
        }
        
        // Calculate total amount
        const totalAmount = baseRate * daysDiff;
        
        console.log('Calculation result:', {
            baseRate: baseRate,
            days: daysDiff,
            totalAmount: totalAmount
        });
        
        // Format the amount with thousand separators
        const formattedAmount = totalAmount.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        
        // Update the total amount field - remove readonly temporarily to set value
        totalAmountInput.prop('readonly', false);
        totalAmountInput.val(formattedAmount);
        totalAmountInput.prop('readonly', true);
        totalAmountInput.removeClass('is-invalid');
        
        // Visual feedback - highlight the field
        totalAmountInput.css({
            'background-color': '#d1ecf1',
            'border-color': '#0d6efd',
            'font-weight': '600',
            'color': '#0d6efd'
        });
        
        // Reset styling after a moment
        setTimeout(function() {
            totalAmountInput.css({
                'background-color': '#f8f9fa',
                'border-color': '#ced4da'
            });
        }, 1000);
        
        console.log('Total amount set to:', formattedAmount, '(Raw value: ' + totalAmount.toFixed(2) + ')');
        
        // Also trigger input event to ensure form validation recognizes the value
        totalAmountInput.trigger('input');
    }
    
    // Function to load available rooms
    function loadAvailableRooms() {
        console.log('Loading available rooms...');
        console.log('Making AJAX call to:', '/properties/api/available-rooms/');
        
        $.ajax({
            url: '/properties/api/available-rooms/',
            method: 'GET',
            success: function(data) {
                console.log('Rooms API response:', data);
                console.log('Response success:', data.success);
                console.log('Number of rooms:', data.rooms ? data.rooms.length : 'undefined');
                
                if (data.success && data.rooms && data.rooms.length > 0) {
                    console.log('Calling populateRoomDropdown with', data.rooms.length, 'rooms');
                    populateRoomDropdown(data.rooms);
                    console.log('Calling populateRoomTypeDropdown with', data.rooms.length, 'rooms');
                    populateRoomTypeDropdown(data.rooms);
                } else {
                    console.error('API returned error or no rooms:', data.error || 'No rooms found');
                    $('#modalRoomNumber').empty().append('<option value="" disabled>Error loading rooms</option>');
                    $('#modalRoomType').empty().append('<option value="" disabled>Error loading room types</option>');
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX Error loading rooms:', status, error);
                console.error('Response status:', xhr.status);
                console.error('Response text:', xhr.responseText);
                $('#modalRoomNumber').empty().append('<option value="" disabled>Error loading rooms</option>');
                $('#modalRoomType').empty().append('<option value="" disabled>Error loading room types</option>');
            }
        });
    }
    
    // Function to populate room dropdown
    function populateRoomDropdown(rooms) {
        console.log('Populating room dropdown with rooms:', rooms);
        const roomSelect = $('#modalRoomNumber');
        roomSelect.empty();
        roomSelect.append('<option value="">Please select an accommodation</option>');
        
        if (!rooms || rooms.length === 0) {
            console.log('No rooms found');
            roomSelect.append('<option value="" disabled>No accommodations available</option>');
            return;
        }
        
        // Add all rooms directly (simpler approach)
        rooms.forEach(function(room) {
            console.log('Adding room:', room.room_number, room.room_type, room.status);
            
            // Format base_rate to ensure it's a number
            // Use ONLY room.base_rate - no fallback to property rate
            const baseRate = parseFloat(room.base_rate) || 0;
            
            // Skip rooms without a valid base_rate (shouldn't happen due to API filter, but double-check)
            if (!baseRate || baseRate <= 0) {
                console.warn('Skipping room', room.room_number, '- no valid base_rate set');
                return; // Skip this room
            }
            
            const option = $('<option></option>')
                .attr('value', room.room_number)
                .attr('data-room-type', room.room_type)
                .attr('data-status', room.status)
                .attr('data-base-rate', baseRate)  // Store room's base_rate (ONLY source of pricing)
                .text(room.room_type + ' - ' + room.room_number + ' (' + room.capacity + ' guests, Tsh' + baseRate.toLocaleString() + '/night)');
            
            if (room.status !== 'available') {
                option.prop('disabled', true);
                option.text(room.room_type + ' - ' + room.room_number + ' (' + room.capacity + ' guests, Tsh' + baseRate.toLocaleString() + '/night) - ' + room.status.toUpperCase());
            }
            
            roomSelect.append(option);
        });
        
        console.log('Room dropdown populated. Total options:', roomSelect.find('option').length);
    }
    
    // Function to populate room type dropdown dynamically
    function populateRoomTypeDropdown(rooms) {
        console.log('Populating room type dropdown with rooms:', rooms);
        const roomTypeSelect = $('#modalRoomType');
        
        console.log('Room type select element found:', roomTypeSelect.length);
        
        // Get unique room types from rooms
        const roomTypes = [...new Set(rooms.map(room => room.room_type))].sort();
        console.log('Unique room types found:', roomTypes);
        
        // Clear existing options except the first one
        roomTypeSelect.find('option:not(:first)').remove();
        console.log('Cleared existing room type options');
        
        // Add room types from database
        roomTypes.forEach(function(roomType) {
            console.log('Adding room type option:', roomType);
            const option = $('<option></option>')
                .attr('value', roomType)
                .text(roomType);
            roomTypeSelect.append(option);
        });
        
        console.log('Room type dropdown populated with', roomTypes.length, 'types');
        console.log('Total options in room type dropdown:', roomTypeSelect.find('option').length);
    }
    
    // Function to filter rooms by type
    function filterRoomsByType() {
        const selectedType = $('#modalRoomType').val();
        const roomSelect = $('#modalRoomNumber');
        
        console.log('Filtering rooms by type:', selectedType);
        console.log('Available options:', roomSelect.find('option').length);
        
        if (selectedType) {
            roomSelect.find('option').each(function() {
                const option = $(this);
                const roomType = option.attr('data-room-type');
                
                if (option.val() === '') {
                    // Keep the "Please select an accommodation" option
                    option.show();
                } else if (roomType === selectedType) {
                    console.log('Showing room:', option.text());
                    option.show();
                } else {
                    console.log('Hiding room:', option.text());
                    option.hide();
                }
            });
            
            // Reset room selection when type changes
            roomSelect.val('');
        } else {
            // Show all rooms when no type is selected
            console.log('Showing all rooms');
            roomSelect.find('option').show();
            roomSelect.val('');
        }
    }
    
    // Function to create booking
    function createBooking() {
        {% if not selected_property %}
            // If no lodge selected, redirect to selection page
            window.location.href = '{% url "properties:lodge_select_property" %}';
            return;
        {% endif %}
        
        const form = $('#newBookingForm');
        const submitBtn = $('#createBookingBtn');
        
        // Safety check: ensure form exists (lodge is selected)
        if (!form.length || !form[0]) {
            showErrorMessage('Please select a lodge first.');
            window.location.href = '{% url "properties:lodge_select_property" %}';
            return;
        }
        
        // Disable button and show loading
        submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Creating...');
        
        // Get form data
        const formData = new FormData(form[0]);
        
        // Ensure total_amount is numeric (remove formatting)
        const totalAmountValue = $('#totalAmount').val();
        if (totalAmountValue) {
            // Remove thousand separators and set numeric value
            const numericValue = totalAmountValue.replace(/,/g, '');
            formData.set('total_amount', numericValue);
        }
        
        // Validate required fields
        const requiredFields = ['customer_name', 'phone', 'email', 'room_type', 'room_number', 'check_in_date', 'check_out_date', 'number_of_guests', 'total_amount'];
        let isValid = true;
        
        requiredFields.forEach(function(field) {
            const value = formData.get(field);
            if (!value || value.trim() === '') {
                $('[name="' + field + '"]').addClass('is-invalid');
                isValid = false;
            } else {
                $('[name="' + field + '"]').removeClass('is-invalid');
            }
        });
        
        if (!isValid) {
            showErrorMessage('Please fill in all required fields.');
            submitBtn.prop('disabled', false).html('<i class="fas fa-plus me-2"></i>Create Booking');
            return;
        }
        
        // Submit booking
        $.ajax({
            url: '/properties/api/create-booking/',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
            },
            success: function(response) {
                if (response.success) {
                    // Show success message with room details
                    let message = response.message;
                    if (response.room_message) {
                        message += '\n\nRoom Assignment: ' + response.room_message;
                    }
                    
                    showSuccessMessage(message);
                    
                    // Close modal and reset form
                    $('#newBookingModal').modal('hide');
                    form[0].reset();
                    $('#modalRoomNumber').empty().append('<option value="">Please select an accommodation</option>');
                    
                    // Reload page to show new booking
                    setTimeout(function() {
                        location.reload();
                    }, 2000);
                } else {
                    showErrorMessage(response.error || 'Failed to create booking');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error creating booking:', error);
                const errorMessage = xhr.responseJSON?.error || 'Failed to create booking. Please try again.';
                showErrorMessage(errorMessage);
            },
            complete: function() {
                submitBtn.prop('disabled', false).html('<i class="fas fa-plus me-2"></i>Create Booking');
            }
        });
    }
    
    // Filter functionality
    $('#bookingSearch, #statusFilter, #checkinFilter, #paymentFilter').on('change keyup', function() {
        filterBookings();
    });
    
    // Handle show deleted filter checkbox
    $('#showDeletedFilter').on('change', function() {
        const url = new URL(window.location.href);
        // Remove hash if present
        url.hash = '';
        if ($(this).is(':checked')) {
            url.searchParams.set('show_deleted', 'true');
        } else {
            url.searchParams.delete('show_deleted');
        }
        window.location.href = url.toString();
    });
    
    function filterBookings() {
        const searchTerm = $('#bookingSearch').val().toLowerCase();
        const statusFilter = $('#statusFilter').val();
        const paymentFilter = $('#paymentFilter').val();
        const checkinFilter = $('#checkinFilter').val();
        
        $('table tbody tr').each(function() {
            const row = $(this);
            let showRow = true;
            
            // Search filter - check all text content
            if (searchTerm) {
                const rowText = row.text().toLowerCase();
                if (!rowText.includes(searchTerm)) {
                    showRow = false;
                }
            }
            
            // Status filter - check the status badge
            if (statusFilter) {
                const statusText = row.find('td:nth-child(8)').text().toLowerCase();
                if (!statusText.includes(statusFilter.toLowerCase())) {
                    showRow = false;
                }
            }
            
            // Payment filter - check the payment badge
            if (paymentFilter) {
                const paymentText = row.find('td:nth-child(9)').text().toLowerCase();
                if (!paymentText.includes(paymentFilter.toLowerCase())) {
                    showRow = false;
                }
            }
            
            // Check-in date filter
            if (checkinFilter) {
                const checkinDate = row.find('td:nth-child(4)').text().trim();
                // Simple date comparison (format: MMM DD, YYYY)
                if (!checkinDate.includes(checkinFilter)) {
                    showRow = false;
                }
            }
            
            row.toggle(showRow);
        });
    }
});

// Bind confirm buttons
$(function() {
  $('#confirmCheckinBtn').on('click', function() {
    if (!currentLodgeBookingId) return;
    $.post(`/properties/api/booking/${currentLodgeBookingId}/checkin/`, {
      csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
    }, function(response) {
      if (response.success) {
        showNotification('Guest checked in successfully', 'success');
        $('#lodgeCheckinModal').modal('hide');
        location.reload();
      } else {
        showNotification(response.message || 'Failed to check-in guest', 'error');
      }
    }).fail(function() {
      showNotification('Error checking in guest', 'error');
    });
  });

  $('#confirmCheckoutBtn').on('click', function() {
    if (!currentLodgeBookingId) return;
    $.post(`/properties/api/booking/${currentLodgeBookingId}/checkout/`, {
      csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
    }, function(response) {
      if (response.success) {
        showNotification('Guest checked out successfully', 'success');
        $('#lodgeCheckoutModal').modal('hide');
        location.reload();
      } else {
        showNotification(response.message || 'Failed to check-out guest', 'error');
      }
    }).fail(function() {
      showNotification('Error checking out guest', 'error');
    });
  });

  $('#confirmCancelLodgeBtn').on('click', function() {
    if (!currentLodgeBookingId) return;
    $.post(`/properties/api/booking/${currentLodgeBookingId}/cancel/`, {
      csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
    }, function(response) {
      if (response.success) {
        showNotification('Booking cancelled successfully', 'success');
        $('#lodgeCancelBookingModal').modal('hide');
        location.reload();
      } else {
        showNotification(response.message || 'Failed to cancel booking', 'error');
      }
    }).fail(function() {
      showNotification('Error cancelling booking', 'error');
    });
  });
});
</script>
{% endblock %}