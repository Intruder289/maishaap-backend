{% load humanize %}
<div class="table-responsive">
  <table class="table table-hover mb-0" id="properties-table">
    <thead class="table-light">
      <tr>
        <th>Property</th>
        <th>Type</th>
        <th>Location</th>
        <th>Rent</th>
        <th>Status</th>
        <th>Active</th>
        <th>Created</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for property in properties %}
      <tr data-property-id="{{ property.id }}">
        <td>
          <div class="d-flex align-items-center">
            {% with primary_image=property.get_primary_image %}
              {% if primary_image %}
                <img src="{{ primary_image.image.url }}"
                     alt="{{ property.title }}"
                     class="property-image me-3"
                     title="{{ primary_image.caption|default:property.title }}"
                     onclick="window.location.href='{% url 'properties:property_detail' property.pk %}'">
              {% else %}
              <div class="property-placeholder me-3">
                <i class="fas fa-building"></i>
              </div>
              {% endif %}
            {% endwith %}
            <div>
              <strong>{{ property.title }}</strong><br>
              <small class="text-muted">{{ property.address|truncatechars:30 }}</small>
            </div>
          </div>
        </td>
        <td>
          <span class="badge bg-primary">{{ property.property_type.name }}</span>
        </td>
        <td>
          <span class="text-muted">{{ property.address|truncatechars:25 }}</span>
        </td>
        <td>
          <strong>Tsh{{ property.rent_amount|floatformat:2 }}</strong>
          {% if property.deposit_amount %}
          <br>
          <small class="text-muted">Deposit: Tsh{{ property.deposit_amount|floatformat:2 }}</small>
          {% endif %}
        </td>
        <td>
          <span class="badge {% if property.status == 'available' %}bg-success{% elif property.status == 'rented' %}bg-warning{% elif property.status == 'under_maintenance' %}bg-info{% else %}bg-secondary{% endif %}">
            {% if property.status == 'available' %}
              <i class="fas fa-check-circle me-1"></i>
            {% elif property.status == 'rented' %}
              <i class="fas fa-user me-1"></i>
            {% elif property.status == 'under_maintenance' %}
              <i class="fas fa-tools me-1"></i>
            {% else %}
              <i class="fas fa-times-circle me-1"></i>
            {% endif %}
            {{ property.get_status_display }}
          </span>
        </td>
        <td>
          <span class="badge {% if property.is_active %}bg-success{% else %}bg-danger{% endif %}">
            {% if property.is_active %}
              <i class="fas fa-check-circle me-1"></i>
              Active
            {% else %}
              <i class="fas fa-times-circle me-1"></i>
              Inactive
            {% endif %}
          </span>
        </td>
        <td>
          <div>
            <strong>{{ property.created_at|date:"M j, Y" }}</strong><br>
            <small class="text-muted">{{ property.created_at|date:"g:i A" }}</small>
          </div>
        </td>
        <td>
          {% if user.is_staff or user.is_superuser or property.owner == user %}
          <div class="dropdown">
            <button class="btn btn-link btn-sm dropdown-toggle dropdown-caret-none" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              <span class="fas fa-ellipsis-h"></span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="/properties/{{ property.id }}/"><i class="fas fa-eye me-2 text-primary"></i>View Details</a></li>
              <li><a class="dropdown-item" href="/properties/{{ property.id }}/edit/"><i class="fas fa-edit me-2 text-warning"></i>Edit</a></li>
              {% if user.is_staff or user.is_superuser %}
              <li><hr class="dropdown-divider"></li>
              <li>
                <button type="button" class="dropdown-item assign-owner-action"
                   data-property-id="{{ property.id }}"
                   data-property-title="{{ property.title|escapejs }}"
                   data-current-owner-id="{{ property.owner.id|default:'' }}"
                   data-current-owner="{{ property.owner.get_full_name|default:property.owner.username|escapejs }}">
                  <i class="fas fa-user-tag me-2 text-info"></i>Assign Property Owner
                </button>
              </li>
              {% endif %}
              <li><hr class="dropdown-divider"></li>
              <li>
                <a class="dropdown-item toggle-status-action"
                   href="#"
                   data-url="/api/properties/{{ property.id }}/toggle-status/"
                   data-item-id="{{ property.id }}">
                  <i class="fas fa-toggle-{% if property.is_active %}on{% else %}off{% endif %} me-2 text-{% if property.is_active %}warning{% else %}success{% endif %}"></i>
                  {% if property.is_active %}Deactivate{% else %}Activate{% endif %}
                </a>
              </li>
              <li>
                <a class="dropdown-item text-danger delete-action"
                   href="#"
                   data-url="/api/properties/{{ property.id }}/delete/"
                   data-item-id="{{ property.id }}"
                   data-item-name="property">
                  <i class="fas fa-trash me-2"></i>Delete
                </a>
              </li>
            </ul>
          </div>
          {% else %}
          <div class="dropdown">
            <button class="btn btn-link btn-sm dropdown-toggle dropdown-caret-none" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              <span class="fas fa-ellipsis-h"></span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="/properties/{{ property.id }}/"><i class="fas fa-eye me-2 text-primary"></i>View Details</a></li>
            </ul>
          </div>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="8" class="text-center py-4">
          <div class="text-muted">
            <i class="fas fa-building fa-3x mb-3"></i>
            <p>No properties found. Adjust your filters or add a new property.</p>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% if page_obj.has_other_pages %}
<div class="card-footer bg-white border-0 py-3">
  <div class="row align-items-center">
    <div class="col-md-6">
      <small class="text-muted">
        Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ paginator.count }} properties
      </small>
    </div>
    <div class="col-md-6">
      <nav aria-label="Properties pagination">
        <ul class="pagination pagination-sm justify-content-end mb-0">
          {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="#" onclick="loadPropertyPage(1); return false;" title="First page">
              <i class="fas fa-angle-double-left"></i>
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="#" onclick="loadPropertyPage({{ page_obj.previous_page_number }}); return false;" title="Previous page">
              <i class="fas fa-angle-left"></i>
            </a>
          </li>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <li class="page-item active">
              <span class="page-link">{{ num }}</span>
            </li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <li class="page-item">
              <a class="page-link" href="#" onclick="loadPropertyPage({{ num }}); return false;">{{ num }}</a>
            </li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="#" onclick="loadPropertyPage({{ page_obj.next_page_number }}); return false;" title="Next page">
              <i class="fas fa-angle-right"></i>
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="#" onclick="loadPropertyPage({{ page_obj.paginator.num_pages }}); return false;" title="Last page">
              <i class="fas fa-angle-double-right"></i>
            </a>
          </li>
          {% endif %}
        </ul>
      </nav>
    </div>
  </div>
</div>
{% else %}
<div class="card-footer bg-white border-0 py-3">
  <small class="text-muted">Showing {{ paginator.count }} properties</small>
</div>
{% endif %}

