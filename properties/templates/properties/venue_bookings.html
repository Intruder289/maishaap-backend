{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}Venue Bookings Management{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-calendar-alt text-primary me-2"></i>Venue Bookings Management
                    </h2>
                    <p class="text-muted mb-0">Manage venue bookings, events, and reservations</p>
                </div>
                <div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newBookingModal">
                        <i class="fas fa-plus me-2"></i>New Booking
                    </button>
                </div>
            </div>
            
            <!-- Filter Section -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Search</label>
                            <input type="text" class="form-control" id="bookingSearch" placeholder="Search bookings...">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="statusFilter">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Event Date</label>
                            <input type="date" class="form-control" id="eventDateFilter">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Venue</label>
                            <select class="form-select" id="venueFilter">
                                <option value="">All Venues</option>
                                <option value="conference_a">Conference Hall A</option>
                                <option value="conference_b">Conference Hall B</option>
                                <option value="ballroom">Grand Ballroom</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="showDeletedFilter" {% if show_deleted %}checked{% endif %}>
                                <label class="form-check-label" for="showDeletedFilter" title="Check this to view soft-deleted bookings">
                                    Show Deleted Bookings
                                </label>
                            </div>
                            {% if show_deleted %}
                            <small class="text-muted d-block mt-1">
                                <i class="fas fa-info-circle"></i> Showing deleted bookings
                            </small>
                            {% endif %}
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                    <i class="fas fa-times me-1"></i>Clear
                                </button>
                                <button class="btn btn-outline-primary" onclick="exportBookings()">
                                    <i class="fas fa-download me-1"></i>Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bookings Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Venue Bookings</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="bookingsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Booking Ref</th>
                                    <th>Event</th>
                                    <th>Customer</th>
                                    <th>Venue</th>
                                    <th>Date & Time</th>
                                    <th>Guests</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if bookings %}
                                    {% for booking in bookings %}
                                <tr {% if booking.is_deleted %}class="table-secondary opacity-75"{% endif %}>
                                        <td>
                                            <span class="badge bg-primary">VB{{ booking.id|stringformat:"03d" }}</span>
                                            {% if booking.is_deleted %}
                                            <span class="badge bg-danger ms-1" title="This booking has been soft deleted">
                                                <i class="fas fa-trash"></i> Deleted
                                            </span>
                                            {% endif %}
                                        </td>
                                    <td>
                                        <div>
                                                <strong>{{ booking.booking_reference }}</strong><br>
                                                <small class="text-muted">{{ booking.special_requests|truncatechars:30|default:"No description" }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                                <strong>{{ booking.customer.full_name }}</strong><br>
                                                <small class="text-muted">{{ booking.customer.email }}</small>
                                        </div>
                                    </td>
                                    <td>
                                            <span class="badge bg-info">{{ booking.property_obj.title }}</span><br>
                                            <small class="text-muted">{{ booking.property_obj.capacity|default:"N/A" }} capacity</small>
                                    </td>
                                    <td>
                                        <div>
                                                <strong>{{ booking.check_in_date|date:"Y-m-d" }}</strong><br>
                                                <small class="text-muted">
                                                    {% if booking.check_in_date == booking.check_out_date %}
                                                        All day
                                                    {% else %}
                                                        {{ booking.check_in_date|date:"M d" }} - {{ booking.check_out_date|date:"M d" }}
                                                    {% endif %}
                                                </small>
                                        </div>
                                    </td>
                                        <td>{{ booking.number_of_guests|default:"N/A" }}</td>
                                        <td>
                                            {% if booking.special_requests %}
                                                <span class="badge bg-info">{{ booking.special_requests|truncatechars:15 }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">General</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if booking.calculated_total_amount and booking.calculated_total_amount > 0 %}
                                                Tsh {{ booking.calculated_total_amount|floatformat:2 }}
                                            {% else %}
                                                Tsh {{ booking.total_amount|floatformat:2 }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if booking.booking_status == 'confirmed' %}
                                                <span class="badge bg-success">Confirmed</span>
                                            {% elif booking.booking_status == 'checked_in' %}
                                                <span class="badge bg-info">Active</span>
                                            {% elif booking.booking_status == 'pending' %}
                                                <span class="badge bg-warning">Pending</span>
                                            {% elif booking.booking_status == 'checked_out' %}
                                                <span class="badge bg-secondary">Completed</span>
                                            {% elif booking.booking_status == 'cancelled' %}
                                                <span class="badge bg-danger">Cancelled</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ booking.booking_status|title }}</span>
                                            {% endif %}
                                        </td>
                                    <td>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" href="#" onclick="viewBooking({{ booking.id }})"><i class="fas fa-eye me-2"></i>View Details</a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="editBooking({{ booking.id }})"><i class="fas fa-edit me-2"></i>Edit</a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                    {% if booking.booking_status == 'pending' %}
                                                        <li><a class="dropdown-item" href="#" onclick="confirmBooking({{ booking.id }})"><i class="fas fa-check me-2"></i>Confirm</a></li>
                                                    {% elif booking.booking_status == 'confirmed' %}
                                                        <li><a class="dropdown-item" href="#" onclick="startEvent({{ booking.id }})"><i class="fas fa-play me-2"></i>Start Event</a></li>
                                                    {% elif booking.booking_status == 'checked_in' %}
                                                        <li><a class="dropdown-item" href="#" onclick="endEvent({{ booking.id }})"><i class="fas fa-stop me-2"></i>End Event</a></li>
                                                    {% endif %}
                                                    {% if booking.booking_status == 'completed' %}
                                                        <li><a class="dropdown-item" href="#" onclick="generateInvoice({{ booking.id }})"><i class="fas fa-receipt me-2"></i>Invoice</a></li>
                                                        <li><a class="dropdown-item" href="#" onclick="rebookEvent({{ booking.id }})"><i class="fas fa-redo me-2"></i>Re-book</a></li>
                                                    {% endif %}
                                                <li><hr class="dropdown-divider"></li>
                                                    {% if booking.booking_status not in 'completed,cancelled' %}
                                                        <li><a class="dropdown-item text-danger" href="#" onclick="cancelBooking({{ booking.id }})"><i class="fas fa-times me-2"></i>Cancel</a></li>
                                                    {% endif %}
                                                    {% if booking.booking_status == 'cancelled' or booking.booking_status == 'checked_out' %}
                                                        {% if not booking.is_deleted %}
                                                        <li><hr class="dropdown-divider"></li>
                                                        <li><a class="dropdown-item text-danger soft-delete-booking-btn" href="javascript:void(0);" data-booking-id="{{ booking.pk }}"><i class="fas fa-trash me-2"></i>Delete</a></li>
                                                        {% endif %}
                                                    {% endif %}
                                                    {% if booking.is_deleted %}
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li><a class="dropdown-item text-success restore-booking-btn" href="javascript:void(0);" data-booking-id="{{ booking.pk }}"><i class="fas fa-undo me-2"></i>Restore</a></li>
                                                    {% endif %}
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="10" class="text-center py-4">
                                            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                                            <h5 class="text-muted">No venue bookings found</h5>
                                            <p class="text-muted">Create your first venue booking to get started.</p>
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Booking Modal -->
<div class="modal fade" id="newBookingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New Venue Booking</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newBookingForm">
                    {% csrf_token %}
                    <div id="venueBookingError" class="alert alert-danger" style="display: none;"></div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Event Name *</label>
                            <input type="text" class="form-control" name="event_name" id="eventName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Customer Name *</label>
                            <input type="text" class="form-control" name="customer_name" id="customerName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-control" name="email" id="customerEmail" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phone Number *</label>
                            <input type="tel" class="form-control" name="phone" id="customerPhone" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Venue *</label>
                            <select class="form-control" name="venue" id="venueSelect" required>
                                <option value="">Select Venue</option>
                                {% for venue in venue_properties %}
                                <option value="{{ venue.id }}" data-capacity="{{ venue.capacity|default:0 }}" data-price="{{ venue.rent_amount|default:0 }}">
                                    {{ venue.title }} ({{ venue.capacity|default:"N/A" }} capacity) - Tsh{{ venue.rent_amount|floatformat:0 }}/day
                                </option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted" id="venueInfo"></small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Event Type *</label>
                            <select class="form-control" name="event_type" id="eventType" required>
                                <option value="">Select Type</option>
                                <option value="conference">Conference</option>
                                <option value="wedding">Wedding</option>
                                <option value="meeting">Meeting</option>
                                <option value="party">Party</option>
                                <option value="seminar">Seminar</option>
                                <option value="team_building">Team Building</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Event Date *</label>
                            <input type="date" class="form-control" name="event_date" id="eventDate" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Start Time *</label>
                            <input type="time" class="form-control" name="start_time" id="startTime" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">End Time *</label>
                            <input type="time" class="form-control" name="end_time" id="endTime" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Expected Guests *</label>
                            <input type="number" class="form-control" name="expected_guests" id="expectedGuests" min="1" required>
                            <small class="form-text text-danger" id="capacityError" style="display: none;"></small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Total Amount *</label>
                            <input type="number" class="form-control" name="total_amount" id="totalAmount" step="0.01" readonly required>
                            <small class="form-text text-muted" id="amountInfo">Amount will be calculated automatically</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Setup Required</label>
                            <select class="form-control" name="setup_required" id="setupRequired">
                                <option value="basic">Basic Setup</option>
                                <option value="full">Full Setup</option>
                                <option value="custom">Custom Setup</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Special Requirements</label>
                            <textarea class="form-control" name="special_requirements" id="specialRequirements" rows="3" placeholder="Audio/visual equipment, catering, decorations, etc."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="createVenueBookingBtn">Create Booking</button>
            </div>
        </div>
    </div>
</div>
<!-- Booking Details Modal -->
<div class="modal fade" id="bookingDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Booking Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center text-muted py-4">
                    <i class="fas fa-spinner fa-spin me-2"></i> Loading...
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
    </div>

<!-- Booking Edit Modal -->
<div class="modal fade" id="bookingEditModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Booking</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center text-muted py-4">
                    <i class="fas fa-spinner fa-spin me-2"></i> Loading form...
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Start Event Confirmation Modal -->
<div class="modal fade" id="startEventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Start Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to start this event?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                <button type="button" class="btn btn-primary" id="confirmStartEventBtn">Yes, Start</button>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Booking Confirmation Modal -->
<div class="modal fade" id="cancelBookingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cancel Booking</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Are you sure you want to cancel this booking? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                <button type="button" class="btn btn-danger" id="confirmCancelBookingBtn">Yes, Cancel</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Venue booking form variables
let selectedVenue = null;
let venuePricePerDay = 0;
let venueCapacity = 0;

$(document).ready(function() {
    console.log('Venue Bookings page initialized');
    
    // Initialize venue booking form handlers
    initializeVenueBookingForm();
    
    // Filter functionality
    $('#bookingSearch, #statusFilter, #eventDateFilter, #venueFilter').on('change keyup', function() {
        filterBookings();
    });
    
    // Handle show deleted filter checkbox
    $('#showDeletedFilter').on('change', function() {
        const url = new URL(window.location.href);
        // Remove hash if present
        url.hash = '';
        if ($(this).is(':checked')) {
            url.searchParams.set('show_deleted', 'true');
        } else {
            url.searchParams.delete('show_deleted');
        }
        window.location.href = url.toString();
    });
    
    function filterBookings() {
        const searchTerm = $('#bookingSearch').val().toLowerCase();
        const statusFilter = $('#statusFilter').val();
        const eventDateFilter = $('#eventDateFilter').val();
        const venueFilter = $('#venueFilter').val();
        
        $('#bookingsTable tbody tr').each(function() {
            let showRow = true;
            const row = $(this);
            
            // Search filter
            if (searchTerm && !row.text().toLowerCase().includes(searchTerm)) {
                showRow = false;
            }
            
            // Status filter
            if (statusFilter && !row.find('.badge').text().toLowerCase().includes(statusFilter)) {
                showRow = false;
            }
            
            // Venue filter
            if (venueFilter && !row.find('td:nth-child(4)').text().toLowerCase().includes(venueFilter)) {
                showRow = false;
            }
            
            row.toggle(showRow);
        });
    }
    
    // Clear filters
    window.clearFilters = function() {
        $('#bookingSearch, #statusFilter, #eventDateFilter, #venueFilter').val('');
        $('#bookingsTable tbody tr').show();
    };
    
    // Export bookings
    window.exportBookings = function() {
        alert('Export functionality will be implemented');
    };
    
    // Auto-refresh every 30 seconds
    setInterval(function() {
        console.log('Refreshing venue bookings data...');
    }, 30000);
});

// Venue booking management functions
function viewBooking(bookingId) {
    $.get(`/properties/api/booking/${bookingId}/details/`, function(data) {
        $('#bookingDetailsModal .modal-body').html(data);
        $('#bookingDetailsModal').modal('show');
    }).fail(function() {
        showNotification('Error loading booking details', 'error');
    });
}

function editBooking(bookingId) {
    $.get(`/properties/api/booking/${bookingId}/edit/`, function(data) {
        $('#bookingEditModal .modal-body').html(data);
        $('#bookingEditModal').modal('show');
    }).fail(function() {
        showNotification('Error loading booking edit form', 'error');
    });
}

function confirmBooking(bookingId) {
    if (confirm('Are you sure you want to confirm this booking?')) {
        $.post(`/properties/api/venue/booking/${bookingId}/status/`, {
            action: 'confirm',
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        }, function(response) {
            if (response.success) {
                showNotification('Booking confirmed successfully', 'success');
                location.reload();
            } else {
                showNotification(response.message, 'error');
            }
        }).fail(function() {
            showNotification('Error confirming booking', 'error');
        });
    }
}

let currentVenueBookingId = null;

function startEvent(bookingId) {
    currentVenueBookingId = bookingId;
    $('#startEventModal').modal('show');
}

function endEvent(bookingId) {
    if (confirm('Are you sure you want to end this event?')) {
        $.post(`/properties/api/venue/booking/${bookingId}/status/`, {
            action: 'end',
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        }, function(response) {
            if (response.success) {
                showNotification('Event ended successfully', 'success');
                location.reload();
            } else {
                showNotification(response.message, 'error');
            }
        }).fail(function() {
            showNotification('Error ending event', 'error');
        });
    }
}

function cancelBooking(bookingId) {
    currentVenueBookingId = bookingId;
    $('#cancelBookingModal').modal('show');
}

function generateInvoice(bookingId) {
    $.get(`/properties/api/booking/${bookingId}/invoice/`, function(data) {
        $('#invoiceModal .modal-body').html(data);
        $('#invoiceModal').modal('show');
    }).fail(function() {
        showNotification('Error generating invoice', 'error');
    });
}

function rebookEvent(bookingId) {
    // Load the booking details and create a new booking with similar details
    $.get(`/properties/api/booking/${bookingId}/details/`, function(data) {
        // Pre-fill the new booking form with previous booking details
        $('#newBookingModal').modal('show');
        // Implementation would pre-fill form fields
    }).fail(function() {
        showNotification('Error loading booking details for rebooking', 'error');
    });
}

function showNotification(message, type = 'info') {
    const notification = $(`
        <div class="alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `);
    
    $('body').append(notification);
    
    setTimeout(function() {
        notification.alert('close');
    }, 5000);
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Soft delete booking
$(document).on('click', '.soft-delete-booking-btn', function(e) {
    e.preventDefault();
    const bookingId = $(this).data('booking-id');
    
    if (!confirm('Are you sure you want to delete this booking? It will be hidden from the main list but can be restored later.')) {
        return;
    }
    
    $.ajax({
        url: `/properties/api/booking/${bookingId}/soft-delete/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(response) {
            if (response.success) {
                showNotification(response.message || 'Booking deleted successfully. It will be hidden from the list. Check "Show Deleted" to view it.', 'success');
                setTimeout(function() {
                    window.location.reload();
                }, 1500);
            } else {
                showNotification(response.error || 'Failed to delete booking', 'error');
            }
        },
        error: function(xhr) {
            console.error('Error soft deleting booking:', xhr);
            let errorMsg = 'Failed to delete booking';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMsg = xhr.responseJSON.error;
            } else if (xhr.status === 403) {
                errorMsg = 'Permission denied. Only admins can delete bookings.';
            } else if (xhr.status === 400) {
                errorMsg = xhr.responseJSON?.error || 'Invalid request. Booking may not be eligible for deletion.';
            }
            showNotification(errorMsg, 'error');
        }
    });
});

// Restore booking
$(document).on('click', '.restore-booking-btn', function(e) {
    e.preventDefault();
    const bookingId = $(this).data('booking-id');
    
    $.ajax({
        url: `/properties/api/booking/${bookingId}/restore/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(response) {
            if (response.success) {
                showNotification(response.message || 'Booking restored successfully', 'success');
                setTimeout(function() {
                    window.location.reload();
                }, 1500);
            } else {
                showNotification(response.error || 'Failed to restore booking', 'error');
            }
        },
        error: function(xhr) {
            const errorMsg = xhr.responseJSON?.error || 'Failed to restore booking';
            showNotification(errorMsg, 'error');
        }
    });
});

// Update booking total from details modal
function updateBookingTotal(bookingId) {
    $.ajax({
        url: `/properties/api/booking/${bookingId}/update-total/`,
        method: 'POST',
        data: {
            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.success) {
                showNotification(response.message || 'Booking total updated successfully', 'success');
                // Reload details content inside the modal
                $.get(`/properties/api/booking/${bookingId}/details/`, function(data) {
                    $('#bookingDetailsModal .modal-body').html(data);
                });
            } else {
                showNotification(response.message || 'Error updating booking total', 'error');
            }
        },
        error: function(xhr) {
            showNotification('Error updating booking total', 'error');
        }
    });
}
</script>
<script>
// Bind confirm buttons once DOM is ready
$(function() {
    $('#confirmStartEventBtn').on('click', function() {
        if (!currentVenueBookingId) return;
        $.post(`/properties/api/venue/booking/${currentVenueBookingId}/status/`, {
            action: 'start',
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        }, function(response) {
            if (response.success) {
                showNotification('Event started successfully', 'success');
                $('#startEventModal').modal('hide');
                location.reload();
            } else {
                showNotification(response.message || 'Failed to start event', 'error');
            }
        }).fail(function(xhr) {
            showNotification('Error starting event', 'error');
        });
    });

    $('#confirmCancelBookingBtn').on('click', function() {
        if (!currentVenueBookingId) return;
        $.post(`/properties/api/venue/booking/${currentVenueBookingId}/status/`, {
            action: 'cancel',
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        }, function(response) {
            if (response.success) {
                showNotification('Booking cancelled successfully', 'success');
                $('#cancelBookingModal').modal('hide');
                location.reload();
            } else {
                showNotification(response.message || 'Failed to cancel booking', 'error');
            }
        }).fail(function(xhr) {
            showNotification('Error cancelling booking', 'error');
        });
    });
});

// Initialize venue booking form handlers
function initializeVenueBookingForm() {
    // Venue selection handler
    $('#venueSelect').on('change', function() {
        const venueId = $(this).val();
        if (venueId) {
            fetchVenueDetails(venueId);
        } else {
            selectedVenue = null;
            venuePricePerDay = 0;
            venueCapacity = 0;
            $('#venueInfo').text('');
            $('#totalAmount').val('');
            $('#amountInfo').text('Amount will be calculated automatically');
        }
        calculateTotalAmount();
    });
    
    // Date and time change handlers for calculating days
    $('#eventDate, #startTime, #endTime').on('change', function() {
        calculateTotalAmount();
    });
    
    // Expected guests validation
    $('#expectedGuests').on('input change', function() {
        validateCapacity();
        calculateTotalAmount();
    });
    
    // Form submission handler
    $('#createVenueBookingBtn').on('click', function(e) {
        e.preventDefault();
        createVenueBooking();
    });
}

// Fetch venue details from API
function fetchVenueDetails(venueId) {
    $.ajax({
        url: `/properties/api/venue/${venueId}/details/`,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                selectedVenue = response.venue;
                venuePricePerDay = parseFloat(response.venue.rent_amount) || 0;
                venueCapacity = parseInt(response.venue.capacity) || 0;
                
                // Update venue info display
                $('#venueInfo').html(`
                    <i class="fas fa-info-circle"></i> 
                    Price: Tsh${venuePricePerDay.toLocaleString()}/day | 
                    Capacity: ${venueCapacity} guests
                `);
                
                // Validate capacity if guests already entered
                validateCapacity();
                calculateTotalAmount();
            } else {
                showNotification('Error loading venue details: ' + response.message, 'error');
            }
        },
        error: function(xhr) {
            console.error('Error fetching venue details:', xhr);
            showNotification('Error loading venue details', 'error');
        }
    });
}

// Calculate number of days from event date, start time, and end time
function calculateNumberOfDays() {
    const eventDate = $('#eventDate').val();
    const startTime = $('#startTime').val();
    const endTime = $('#endTime').val();
    
    if (!eventDate || !startTime || !endTime) {
        return 0;
    }
    
    // Parse date and times
    const date = new Date(eventDate);
    const [startHour, startMin] = startTime.split(':').map(Number);
    const [endHour, endMin] = endTime.split(':').map(Number);
    
    const startDateTime = new Date(date);
    startDateTime.setHours(startHour, startMin, 0, 0);
    
    const endDateTime = new Date(date);
    endDateTime.setHours(endHour, endMin, 0, 0);
    
    // If end time is before start time, assume it's the next day
    if (endDateTime <= startDateTime) {
        endDateTime.setDate(endDateTime.getDate() + 1);
    }
    
    // Calculate difference in milliseconds
    const diffMs = endDateTime - startDateTime;
    
    // Convert to days (if more than 24 hours, count as multiple days)
    const diffHours = diffMs / (1000 * 60 * 60);
    const days = Math.ceil(diffHours / 24);
    
    return Math.max(1, days); // Minimum 1 day
}

// Calculate total amount based on venue price and number of days
function calculateTotalAmount() {
    if (!selectedVenue || venuePricePerDay === 0) {
        $('#totalAmount').val('');
        $('#amountInfo').text('Select a venue to calculate amount');
        return;
    }
    
    const numberOfDays = calculateNumberOfDays();
    
    if (numberOfDays === 0) {
        $('#totalAmount').val('');
        $('#amountInfo').text('Please fill in event date, start time, and end time');
        return;
    }
    
    const totalAmount = venuePricePerDay * numberOfDays;
    $('#totalAmount').val(totalAmount.toFixed(2));
    
    if (numberOfDays === 1) {
        $('#amountInfo').text(`Tsh${venuePricePerDay.toLocaleString()} × ${numberOfDays} day = Tsh${totalAmount.toLocaleString()}`);
    } else {
        $('#amountInfo').text(`Tsh${venuePricePerDay.toLocaleString()} × ${numberOfDays} days = Tsh${totalAmount.toLocaleString()}`);
    }
}

// Validate expected guests against venue capacity
function validateCapacity() {
    const expectedGuests = parseInt($('#expectedGuests').val()) || 0;
    const capacityError = $('#capacityError');
    
    if (!selectedVenue || venueCapacity === 0) {
        capacityError.hide();
        return true;
    }
    
    if (expectedGuests > venueCapacity) {
        capacityError.text(`Expected guests (${expectedGuests}) exceeds venue capacity (${venueCapacity})`);
        capacityError.show();
        $('#expectedGuests').addClass('is-invalid');
        return false;
    } else {
        capacityError.hide();
        $('#expectedGuests').removeClass('is-invalid');
        return true;
    }
}

// Create venue booking
function createVenueBooking() {
    // Validate form
    if (!validateVenueBookingForm()) {
        return;
    }
    
    // Validate capacity
    if (!validateCapacity()) {
        showNotification('Please adjust the number of expected guests to match venue capacity', 'error');
        return;
    }
    
    // Collect form data
    const formData = {
        'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val(),
        'event_name': $('#eventName').val(),
        'customer_name': $('#customerName').val(),
        'email': $('#customerEmail').val(),
        'phone': $('#customerPhone').val(),
        'venue': $('#venueSelect').val(),
        'event_type': $('#eventType').val(),
        'event_date': $('#eventDate').val(),
        'start_time': $('#startTime').val(),
        'end_time': $('#endTime').val(),
        'expected_guests': $('#expectedGuests').val(),
        'number_of_guests': $('#expectedGuests').val(), // Also send as number_of_guests for backend
        'total_amount': $('#totalAmount').val(),
        'setup_required': $('#setupRequired').val(),
        'special_requirements': $('#specialRequirements').val(),
    };
    
    // Calculate check-in and check-out dates
    // For venues, check-in is event date, check-out might be same day or next day depending on end time
    const eventDate = $('#eventDate').val();
    const startTime = $('#startTime').val();
    const endTime = $('#endTime').val();
    
    // Parse to determine if event spans multiple days
    const [startHour] = startTime.split(':').map(Number);
    const [endHour] = endTime.split(':').map(Number);
    
    let checkOutDate = eventDate;
    if (endHour < startHour || (endHour === startHour && endTime < startTime)) {
        // Event spans to next day
        const date = new Date(eventDate);
        date.setDate(date.getDate() + 1);
        checkOutDate = date.toISOString().split('T')[0];
    }
    
    formData['check_in_date'] = eventDate;
    formData['check_out_date'] = checkOutDate;
    formData['number_of_guests'] = formData['expected_guests'];
    
    // Submit booking
    $.ajax({
        url: '/properties/api/create-booking/',
        method: 'POST',
        data: formData,
        success: function(response) {
            if (response.success) {
                showNotification('Venue booking created successfully!', 'success');
                $('#newBookingModal').modal('hide');
                // Reset form
                $('#newBookingForm')[0].reset();
                selectedVenue = null;
                venuePricePerDay = 0;
                venueCapacity = 0;
                $('#venueInfo').text('');
                $('#totalAmount').val('');
                $('#amountInfo').text('Amount will be calculated automatically');
                // Reload page to show new booking
                setTimeout(function() {
                    window.location.reload();
                }, 1500);
            } else {
                showNotification(response.error || 'Failed to create booking', 'error');
            }
        },
        error: function(xhr) {
            console.error('Error creating booking:', xhr);
            let errorMsg = 'Failed to create booking';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMsg = xhr.responseJSON.error;
            }
            showNotification(errorMsg, 'error');
        }
    });
}

// Validate venue booking form
function validateVenueBookingForm() {
    const requiredFields = [
        { id: '#eventName', name: 'Event Name' },
        { id: '#customerName', name: 'Customer Name' },
        { id: '#customerEmail', name: 'Email' },
        { id: '#customerPhone', name: 'Phone Number' },
        { id: '#venueSelect', name: 'Venue' },
        { id: '#eventType', name: 'Event Type' },
        { id: '#eventDate', name: 'Event Date' },
        { id: '#startTime', name: 'Start Time' },
        { id: '#endTime', name: 'End Time' },
        { id: '#expectedGuests', name: 'Expected Guests' },
    ];
    
    let isValid = true;
    const missingFields = [];
    
    requiredFields.forEach(function(field) {
        const value = $(field.id).val();
        if (!value || value.trim() === '') {
            isValid = false;
            missingFields.push(field.name);
            $(field.id).addClass('is-invalid');
        } else {
            $(field.id).removeClass('is-invalid');
        }
    });
    
    if (!isValid) {
        showNotification('Please fill in all required fields: ' + missingFields.join(', '), 'error');
    }
    
    return isValid;
}
</script>
{% endblock %}
