{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}House Rent Reminders Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-bell text-primary me-2"></i>Rent Reminders Dashboard
                    </h2>
                    <p class="text-muted mb-0">Automated rent payment reminders for house properties</p>
                    {% if selected_property %}
                        <div class="mt-2">
                            <span class="badge bg-primary">
                                <i class="fas fa-building me-1"></i>Managing: {{ selected_property.title }}
                            </span>
                            <a href="{% url 'properties:house_clear_selection' %}" class="btn btn-sm btn-outline-secondary ms-2">
                                <i class="fas fa-times me-1"></i>Clear Selection
                            </a>
                        </div>
                    {% else %}
                        <div class="mt-2">
                            <span class="badge bg-info">
                                <i class="fas fa-globe me-1"></i>Managing: All Houses
                            </span>
                            <a href="{% url 'properties:house_select_property' %}" class="btn btn-sm btn-outline-primary ms-2">
                                <i class="fas fa-building me-1"></i>Select House
                            </a>
                        </div>
                    {% endif %}
                </div>
                <div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#manualReminderModal">
                        <i class="fas fa-plus me-2"></i>Send Manual Reminder
                    </button>
                    <button class="btn btn-outline-secondary" onclick="runReminderCommand()">
                        <i class="fas fa-play me-2"></i>Run Automation
                    </button>
                </div>
            </div>
            
            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-2">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">{{ total_reminders }}</h4>
                                    <p class="mb-0">Total Reminders</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-bell fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">{{ sent_reminders }}</h4>
                                    <p class="mb-0">Sent</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-check fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">{{ pending_reminders }}</h4>
                                    <p class="mb-0">Pending</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-clock fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">{{ failed_reminders }}</h4>
                                    <p class="mb-0">Failed</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">{{ overdue_reminders }}</h4>
                                    <p class="mb-0">Overdue</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-exclamation-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-secondary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">{{ recent_reminders }}</h4>
                                    <p class="mb-0">This Week</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-calendar-week fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Quick Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-2">
                                    <a href="{% url 'properties:house_rent_reminders_list' %}" class="btn btn-outline-primary w-100 mb-2">
                                        <i class="fas fa-list d-block mb-2"></i>
                                        View All Reminders
                                    </a>
                                </div>
                                <div class="col-md-2">
                                    <a href="{% url 'properties:house_rent_reminder_settings' %}" class="btn btn-outline-success w-100 mb-2">
                                        <i class="fas fa-cog d-block mb-2"></i>
                                        Settings
                                    </a>
                                </div>
                                <div class="col-md-2">
                                    <a href="{% url 'properties:house_rent_reminder_templates' %}" class="btn btn-outline-warning w-100 mb-2">
                                        <i class="fas fa-file-alt d-block mb-2"></i>
                                        Templates
                                    </a>
                                </div>
                                <div class="col-md-2">
                                    <a href="{% url 'properties:house_rent_reminder_analytics' %}" class="btn btn-outline-info w-100 mb-2">
                                        <i class="fas fa-chart-bar d-block mb-2"></i>
                                        Analytics
                                    </a>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-outline-secondary w-100 mb-2" onclick="createDefaultTemplates()">
                                        <i class="fas fa-plus-circle d-block mb-2"></i>
                                        Setup Templates
                                    </button>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-outline-danger w-100 mb-2" onclick="testReminderSystem()">
                                        <i class="fas fa-vial d-block mb-2"></i>
                                        Test System
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="row">
                <!-- Upcoming Reminders -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Upcoming Reminders (Next 7 Days)</h5>
                        </div>
                        <div class="card-body">
                            {% if upcoming_reminders %}
                                <div class="list-group">
                                    {% for reminder in upcoming_reminders %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{ reminder.customer.first_name|default:reminder.customer.email }}</strong><br>
                                            <small class="text-muted">{{ reminder.property_obj.title }}</small><br>
                                            <small class="text-muted">{{ reminder.scheduled_date|date:"M d, Y H:i" }}</small>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-{{ reminder.reminder_type|default:'primary' }}">
                                                {{ reminder.get_reminder_type_display }}
                                            </span><br>
                                            <small class="text-muted">#{{ reminder.reminder_sequence }}</small>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted text-center">No upcoming reminders scheduled</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Recent Activity</h5>
                        </div>
                        <div class="card-body">
                            {% if recent_logs %}
                                <div class="list-group">
                                    {% for log in recent_logs %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{ log.get_action_display }}</strong><br>
                                            <small class="text-muted">{{ log.description }}</small><br>
                                            <small class="text-muted">{{ log.created_at|date:"M d, Y H:i" }}</small>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-{{ log.action|default:'secondary' }}">
                                                {{ log.reminder.property_obj.title|truncatechars:15 }}
                                            </span>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted text-center">No recent activity</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Overview -->
            {% if settings_obj %}
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Current Settings</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>Days Before Due:</strong><br>
                                    <span class="badge bg-primary">{{ settings_obj.days_before_due }} days</span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Overdue Interval:</strong><br>
                                    <span class="badge bg-warning">{{ settings_obj.overdue_reminder_interval }} days</span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Max Reminders:</strong><br>
                                    <span class="badge bg-info">{{ settings_obj.max_overdue_reminders }}</span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Grace Period:</strong><br>
                                    <span class="badge bg-success">{{ settings_obj.grace_period_days }} days</span>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <strong>Enabled Channels:</strong>
                                    {% if settings_obj.email_enabled %}
                                        <span class="badge bg-primary me-1">Email</span>
                                    {% endif %}
                                    {% if settings_obj.sms_enabled %}
                                        <span class="badge bg-success me-1">SMS</span>
                                    {% endif %}
                                    {% if settings_obj.push_enabled %}
                                        <span class="badge bg-info me-1">Push</span>
                                    {% endif %}
                                    {% if not settings_obj.email_enabled and not settings_obj.sms_enabled and not settings_obj.push_enabled %}
                                        <span class="text-muted">No channels enabled</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Manual Reminder Modal -->
<div class="modal fade" id="manualReminderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Send Manual Reminder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="manualReminderForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Property *</label>
                            <select class="form-control" required>
                                <option value="">Select Property</option>
                                {% for property in house_properties %}
                                <option value="{{ property.id }}">{{ property.title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Reminder Type *</label>
                            <select class="form-control" required>
                                <option value="">Select Type</option>
                                <option value="email">Email</option>
                                <option value="sms">SMS</option>
                                <option value="push">Push Notification</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Booking Reference *</label>
                            <input type="text" class="form-control" required placeholder="e.g., HSE-000001">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Due Date *</label>
                            <input type="date" class="form-control" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Custom Message</label>
                            <textarea class="form-control" rows="4" placeholder="Custom message (optional)"></textarea>
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sendImmediately">
                                <label class="form-check-label" for="sendImmediately">
                                    Send immediately instead of scheduling
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendManualReminder()">Send Reminder</button>
            </div>
        </div>
    </div>
</div>

<!-- System Status Modal -->
<div class="modal fade" id="systemStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">System Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="systemStatusContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Checking system status...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    console.log('Rent Reminders Dashboard initialized');
    
    // Auto-refresh every 30 seconds
    setInterval(function() {
        console.log('Refreshing reminders dashboard...');
        // You could implement AJAX refresh here
    }, 30000);
});

function runReminderCommand() {
    if (confirm('This will run the automated reminder system. Continue?')) {
        // Show loading state
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Running...';
        btn.disabled = true;
        
        // Simulate command execution
        setTimeout(function() {
            btn.innerHTML = originalText;
            btn.disabled = false;
            alert('Reminder automation completed successfully!');
        }, 3000);
    }
}

function sendManualReminder() {
    const form = document.getElementById('manualReminderForm');
    const formData = new FormData(form);
    
    // Validate form
    if (!formData.get('property') || !formData.get('reminder_type') || !formData.get('booking_reference') || !formData.get('due_date')) {
        alert('Please fill in all required fields');
        return;
    }
    
    // Show loading state
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';
    btn.disabled = true;
    
    // Simulate sending
    setTimeout(function() {
        btn.innerHTML = originalText;
        btn.disabled = false;
        $('#manualReminderModal').modal('hide');
        alert('Manual reminder sent successfully!');
        form.reset();
    }, 2000);
}

function createDefaultTemplates() {
    if (confirm('This will create default reminder templates. Continue?')) {
        // Show loading state
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating...';
        btn.disabled = true;
        
        // Simulate template creation
        setTimeout(function() {
            btn.innerHTML = originalText;
            btn.disabled = false;
            alert('Default templates created successfully!');
        }, 2000);
    }
}

function testReminderSystem() {
    $('#systemStatusModal').modal('show');
    
    // Simulate system test
    setTimeout(function() {
        document.getElementById('systemStatusContent').innerHTML = `
            <div class="alert alert-success">
                <h6><i class="fas fa-check-circle me-2"></i>System Status: Healthy</h6>
                <ul class="mb-0">
                    <li>Email service: Connected</li>
                    <li>SMS service: Not configured</li>
                    <li>Push notifications: Not configured</li>
                    <li>Database: Connected</li>
                    <li>Templates: 4 available</li>
                </ul>
            </div>
        `;
    }, 1500);
}
</script>
{% endblock %}
