{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}Venue Availability Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Page Header -->
            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-4 gap-3">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-calendar-check text-primary me-2"></i>Venue Availability Management
                    </h2>
                    <p class="text-muted mb-0">Monitor venue availability and manage scheduling</p>
                </div>
                <div class="d-flex flex-column flex-sm-row align-items-sm-center gap-2">
                    <div class="d-flex align-items-center gap-2">
                        <label class="form-label mb-0 text-muted small">Jump to Month</label>
                        <input type="month" class="form-control form-control-sm" id="monthPicker" style="min-width: 160px;">
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary btn-sm" id="prevRangeBtn">
                            <i class="fas fa-chevron-left me-1"></i>Prev
                        </button>
                        <button class="btn btn-outline-primary btn-sm" id="nextRangeBtn">
                            Next<i class="fas fa-chevron-right ms-1"></i>
                        </button>
                    </div>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#blockVenueModal">
                        <i class="fas fa-ban me-2"></i>Block Venue
                    </button>
                </div>
            </div>
            
            <!-- Availability Overview -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0" id="availableTodayCount">--</h4>
                                    <p class="mb-0">Available Today</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0" id="bookedTodayCount">--</h4>
                                    <p class="mb-0">Booked Today</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-calendar-check fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0" id="blockedTodayCount">--</h4>
                                    <p class="mb-0">Blocked</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-ban fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0" id="totalCapacityCount">--</h4>
                                    <p class="mb-0">Total Capacity</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-users fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filter Section -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Date Range</label>
                            <select class="form-select" id="dateRangeFilter">
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startDate" value="{{ initial_start_date }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control" id="endDate" value="{{ initial_end_date }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-outline-primary w-100" onclick="applyFilters()">
                                <i class="fas fa-filter me-1"></i>Apply Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Venue Calendar View -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Venue Availability Calendar</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" id="availabilityTable">
                                    <thead class="table-light">
                                        <tr id="calendarHeaderRow">
                                            <th>Venue</th>
                                        </tr>
                                    </thead>
                                    <tbody id="availabilityTableBody">
                                        <tr>
                                            <td id="availabilityEmptyState" class="text-center py-4 text-muted" colspan="8">
                                                <i class="fas fa-spinner fa-spin me-2"></i> Loading availability...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Detailed Availability -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Today's Schedule</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Venue</th>
                                            <th>Event</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="todayScheduleBody">
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">
                                                <i class="fas fa-info-circle me-2"></i>No events scheduled for today.
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Venue Status</h5>
                        </div>
                        <div class="card-body" id="venueStatusList">
                            <p class="text-muted mb-0">
                                <i class="fas fa-info-circle me-2"></i>Status updates will appear here once availability data loads.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Block Venue Modal -->
<div class="modal fade" id="blockVenueModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Block Venue</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="blockVenueForm">
                    <div class="mb-3">
                        <label class="form-label">Venue *</label>
                        <select class="form-control" required>
                            <option value="">Select Venue</option>
                            <option value="conference_a">Conference Hall A</option>
                            <option value="conference_b">Conference Hall B</option>
                            <option value="ballroom">Grand Ballroom</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Start Date *</label>
                        <input type="date" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">End Date *</label>
                        <input type="date" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Start Time</label>
                        <input type="time" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">End Time</label>
                        <input type="time" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reason *</label>
                        <select class="form-control" required>
                            <option value="">Select Reason</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="cleaning">Deep Cleaning</option>
                            <option value="renovation">Renovation</option>
                            <option value="private_event">Private Event</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" rows="3" placeholder="Additional notes about the venue block..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger">Block Venue</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const AVAILABILITY_ENDPOINT = '/properties/api/venue/availability/';
const STATUS_BADGES = {
    pending: 'bg-warning text-dark',
    confirmed: 'bg-success',
    checked_in: 'bg-info',
    completed: 'bg-secondary',
    cancelled: 'bg-danger',
};
let availabilityTimer = null;

$(document).ready(function() {
    console.log('Venue Availability page initialized');
    bindFilters();
    loadAvailability();
    availabilityTimer = setInterval(function() {
        loadAvailability(true);
    }, 30000);

    if ($('#startDate').val()) {
        const monthValue = $('#startDate').val().slice(0, 7);
        $('#monthPicker').val(monthValue);
    }
});

function bindFilters() {
    $('#dateRangeFilter').on('change', function() {
        const range = $(this).val();
        const today = new Date();
        
        switch(range) {
            case 'today':
                setDateRange(today, today);
                break;
            case 'week':
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay());
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                setDateRange(weekStart, weekEnd);
                break;
            case 'month':
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                setDateRange(monthStart, monthEnd);
                break;
            default:
                return;
        }
        loadAvailability();
    });
    
    $('#startDate, #endDate').on('change', function() {
        loadAvailability();
    });

    $('#monthPicker').on('change', function() {
        const value = $(this).val();
        if (!value) return;
        const [year, month] = value.split('-').map(Number);
        const monthStart = new Date(year, month - 1, 1);
        const monthEnd = new Date(year, month, 0);
        setDateRange(monthStart, monthEnd);
        loadAvailability();
    });

    $('#prevRangeBtn').on('click', function() {
        shiftRange(-7);
    });
    $('#nextRangeBtn').on('click', function() {
        shiftRange(7);
    });
}

function setDateRange(start, end) {
    $('#startDate').val(start.toISOString().split('T')[0]);
    $('#endDate').val(end.toISOString().split('T')[0]);
    $('#monthPicker').val(start.toISOString().slice(0, 7));
}

function applyFilters() {
    loadAvailability();
}

function shiftRange(days) {
    const startVal = $('#startDate').val();
    const endVal = $('#endDate').val();
    if (!startVal || !endVal) return;

    const start = new Date(startVal);
    const end = new Date(endVal);
    start.setDate(start.getDate() + days);
    end.setDate(end.getDate() + days);
    setDateRange(start, end);
    loadAvailability();
}

function loadAvailability(isAutoRefresh = false) {
    const startDate = $('#startDate').val();
    const endDate = $('#endDate').val();
    
    $('#availabilityEmptyState').html('<i class="fas fa-spinner fa-spin me-2"></i> Loading availability...');
    
    $.getJSON(AVAILABILITY_ENDPOINT, {
        start_date: startDate,
        end_date: endDate
    }).done(function(response) {
        if (!response.success) {
            showAvailabilityAlert(response.message || 'Unable to load availability data.', 'danger');
            return;
        }
        
        renderSummary(response.summary);
        renderCalendar(response);
        renderTodaySchedule(response.today_schedule);
        renderVenueStatus(response);
        
        if (!isAutoRefresh) {
            showAvailabilityAlert('Availability updated.', 'success');
        }
    }).fail(function() {
        showAvailabilityAlert('Network error loading availability data.', 'danger');
    });
}

function renderSummary(summary) {
    $('#availableTodayCount').text(summary.available_today ?? '--');
    $('#bookedTodayCount').text(summary.booked_today ?? '--');
    $('#blockedTodayCount').text(summary.blocked_today ?? '--');
    $('#totalCapacityCount').text(summary.total_capacity ?? '--');
}

function renderCalendar(data) {
    const headerRow = $('#calendarHeaderRow');
    const body = $('#availabilityTableBody');
    headerRow.empty().append('<th>Venue</th>');
    body.empty();
    
    if (!data.dates.length || !data.venues.length) {
        body.append(`
            <tr>
                <td colspan="8" class="text-center text-muted py-4">
                    <i class="fas fa-info-circle me-2"></i>No availability data for the selected range.
                </td>
            </tr>
        `);
        return;
    }
    
    data.dates.forEach(dateObj => {
        headerRow.append(`<th>${dateObj.label}</th>`);
    });
    
    data.venues.forEach(venue => {
        let rowHtml = `
            <tr>
                <td>
                    <div>
                        <strong>${venue.name}</strong><br>
                        <small class="text-muted">${venue.capacity || 0} capacity</small>
                    </div>
                </td>
        `;
        
        venue.days.forEach(day => {
            rowHtml += `<td class="text-center">${renderDayCell(day.events)}</td>`;
        });
        
        rowHtml += '</tr>';
        body.append(rowHtml);
    });
}

function renderDayCell(events) {
    if (!events || !events.length) {
        return '<span class="badge bg-success">Available</span>';
    }
    
    let cellContent = '';
    events.slice(0, 2).forEach(event => {
        const badgeClass = STATUS_BADGES[event.status] || 'bg-secondary';
        const eventLabel = escapeHtml(event.event_name || event.reference || 'Event');
        cellContent += `
            <div class="mb-1">
                <span class="badge ${badgeClass}">${event.status.replace('_', ' ').toUpperCase()}</span><br>
                <small>${eventLabel}</small>
            </div>
        `;
    });
    
    if (events.length > 2) {
        cellContent += `<small class="text-muted">+${events.length - 2} more</small>`;
    }
    
    return cellContent;
}

function renderTodaySchedule(schedule) {
    const tbody = $('#todayScheduleBody');
    tbody.empty();
    
    if (!schedule.length) {
        tbody.append(`
            <tr>
                <td colspan="4" class="text-center text-muted">
                    <i class="fas fa-info-circle me-2"></i>No events scheduled for today.
                </td>
            </tr>
        `);
        return;
    }
    
    schedule.forEach(item => {
        const badgeClass = STATUS_BADGES[item.status] || 'bg-secondary';
        tbody.append(`
            <tr>
                <td>${item.time}</td>
                <td>${escapeHtml(item.venue)}</td>
                <td>${escapeHtml(item.event)}</td>
                <td><span class="badge ${badgeClass}">${item.status.replace('_', ' ').toUpperCase()}</span></td>
            </tr>
        `);
    });
}

function renderVenueStatus(data) {
    const container = $('#venueStatusList');
    container.empty();
    
    const todayDate = data.today;
    if (!data.venues.length) {
        container.append('<p class="text-muted mb-0">No venues found.</p>');
        return;
    }
    
    data.venues.forEach(venue => {
        const todayInfo = (venue.days || []).find(day => day.date === todayDate);
        const events = todayInfo ? todayInfo.events : [];
        const badgeClass = events.length ? (STATUS_BADGES[events[0].status] || 'bg-warning') : 'bg-success';
        const statusLabel = events.length ? events[0].status.replace('_', ' ') : 'Available';
        const detailLabel = events.length ? escapeHtml(events[0].event_name || events[0].reference) : 'All day';
        const progressClass = events.length ? badgeClass : 'bg-success';
        const progressWidth = events.length ? '100%' : '0%';
        
        container.append(`
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${escapeHtml(venue.name)}</strong><br>
                        <small class="text-muted">${venue.capacity || 0} capacity</small>
                    </div>
                    <div class="text-end">
                        <span class="badge ${badgeClass}">${statusLabel.toUpperCase()}</span><br>
                        <small>${detailLabel}</small>
                    </div>
                </div>
                <div class="progress mt-2" style="height: 8px;">
                    <div class="progress-bar ${progressClass}" style="width: ${progressWidth}"></div>
                </div>
            </div>
        `);
    });
}

function showAvailabilityAlert(message, type = 'info') {
    const alert = $(`
        <div class="alert alert-${type} alert-dismissible fade show position-fixed"
             style="top: 20px; right: 20px; z-index: 9999;">
            ${escapeHtml(message)}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `);
    $('body').append(alert);
    setTimeout(() => alert.alert('close'), 3000);
}

function escapeHtml(text) {
    return $('<div>').text(text || '').html();
}
</script>
{% endblock %}
