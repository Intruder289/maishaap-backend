{% extends 'accounts/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Lodge Reports{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="row g-3 mb-4 align-items-center justify-content-between">
    <div class="col-auto">
        <div class="d-flex align-items-center">
            <h2 class="mb-0">Lodge Reports</h2>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row g-3 mb-4">
    <div class="col-6 col-lg-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-primary-subtle rounded-3 p-3">
                            <span class="fas fa-mountain text-primary fs-7"></span>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="mb-1">Total Rooms</h6>
                        <h4 class="mb-0">{{ total_rooms|default:0 }}</h4>
                        <p class="fs--1 mb-0 text-500">All accommodation units</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-6 col-lg-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-success-subtle rounded-3 p-3">
                            <span class="fas fa-chart-line text-success fs-7"></span>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="mb-1">Monthly Revenue</h6>
                        <h4 class="mb-0">{{ monthly_revenue|floatformat:0 }} Tsh</h4>
                        <p class="fs--1 mb-0 text-500">Current month income</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-6 col-lg-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-info-subtle rounded-3 p-3">
                            <span class="fas fa-users text-info fs-7"></span>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="mb-1">Total Customers</h6>
                        <h4 class="mb-0">{{ total_customers|default:0 }}</h4>
                        <p class="fs--1 mb-0 text-500">All registered guests</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-6 col-lg-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-warning-subtle rounded-3 p-3">
                            <span class="fas fa-calendar-check text-warning fs-7"></span>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="mb-1">Active Bookings</h6>
                        <h4 class="mb-0">{{ active_bookings|default:0 }}</h4>
                        <p class="fs--1 mb-0 text-500">Currently checked in</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="row g-3">
    <!-- Report Generation Form -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex align-items-center">
                    <span class="fas fa-chart-pie text-primary me-2"></span>
                    <h5 class="mb-0">Generate Lodge Reports</h5>
                </div>
            </div>
            <div class="card-body">
                <form id="reportForm" onsubmit="generateReport(event)">
                    <div class="row g-3">
                        <!-- Report Type -->
                        <div class="col-md-6">
                            <label for="reportType" class="form-label">Report Type *</label>
                            <select class="form-select" id="reportType" required>
                                <option value="">Select Report Type</option>
                                <option value="monthly">Monthly Financial Report</option>
                                <option value="quarterly">Quarterly Performance Report</option>
                                <option value="yearly">Yearly Summary Report</option>
                                <option value="occupancy">Occupancy Analysis Report</option>
                                <option value="revenue">Revenue Analysis Report</option>
                                <option value="activities">Activities Report</option>
                                <option value="customers">Customer Analytics Report</option>
                                <option value="financial">Comprehensive Financial Report</option>
                            </select>
                        </div>

                        <!-- Date Range Type -->
                        <div class="col-md-6">
                            <label for="dateRangeType" class="form-label">Date Range Type *</label>
                            <select class="form-select" id="dateRangeType" onchange="toggleCustomDateRange()" required>
                                <option value="">Select Date Range</option>
                                <option value="this_month">This Month</option>
                                <option value="last_month">Last Month</option>
                                <option value="this_quarter">This Quarter</option>
                                <option value="last_quarter">Last Quarter</option>
                                <option value="this_year">This Year</option>
                                <option value="last_year">Last Year</option>
                                <option value="custom">Custom Date Range</option>
                            </select>
                        </div>

                        <!-- Custom Date Range (Hidden by default) -->
                        <div class="col-md-6" id="customDateRange" style="display: none;">
                            <label for="startDate" class="form-label">Start Date *</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="col-md-6" id="customDateRangeEnd" style="display: none;">
                            <label for="endDate" class="form-label">End Date *</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>

                        <!-- Property Selection -->
                        <div class="col-md-6">
                            <label for="propertySelection" class="form-label">Property Selection *</label>
                            <select class="form-select" id="propertySelection" onchange="togglePropertyFilter()" required>
                                <option value="all">All Lodge Properties</option>
                                <option value="selected">Selected Properties Only</option>
                                <option value="available">Available Rooms Only</option>
                                <option value="occupied">Occupied Rooms Only</option>
                            </select>
                        </div>

                        <!-- Export Format -->
                        <div class="col-md-6">
                            <label for="format" class="form-label">Export Format *</label>
                            <select class="form-select" id="format" required>
                                <option value="excel">Excel Workbook</option>
                                <option value="pdf">PDF Document</option>
                                <option value="csv">CSV File</option>
                            </select>
                        </div>

                        <!-- Property Filter (if needed) -->
                        <div class="col-12" id="propertyFilterSection" style="display: none;">
                            <label class="form-label">Select Specific Properties</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="selectAllProperties" onchange="toggleAllProperties()">
                                        <label class="form-check-label" for="selectAllProperties">
                                            Select All Properties
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-2" id="propertyCheckboxes">
                                <!-- Properties will be loaded dynamically -->
                            </div>
                        </div>

                        <!-- Generate Button -->
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                    <i class="fas fa-undo me-2"></i>Reset Form
                                </button>
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-download me-2"></i>Generate Report
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Property data for dynamic loading
const lodgeProperties = [
    {% for property in lodge_properties %}
    {
        id: {{ property.id }},
        title: "{{ property.title }}",
        address: "{{ property.address }}",
        rent_amount: {{ property.rent_amount|default:0 }},
        status: "{% with property.bookings.all|first as first_booking %}{{ first_booking.booking_status|default:'available' }}{% endwith %}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// Toggle custom date range fields
function toggleCustomDateRange() {
    const dateRangeType = document.getElementById('dateRangeType').value;
    const customDateRange = document.getElementById('customDateRange');
    const customDateRangeEnd = document.getElementById('customDateRangeEnd');

    if (dateRangeType === 'custom') {
        customDateRange.style.display = 'block';
        customDateRangeEnd.style.display = 'block';
        document.getElementById('startDate').required = true;
        document.getElementById('endDate').required = true;
    } else {
        customDateRange.style.display = 'none';
        customDateRangeEnd.style.display = 'none';
        document.getElementById('startDate').required = false;
        document.getElementById('endDate').required = false;
    }
}

// Toggle property filter section
function togglePropertyFilter() {
    const propertySelection = document.getElementById('propertySelection').value;
    const propertyFilterSection = document.getElementById('propertyFilterSection');

    if (propertySelection === 'selected') {
        propertyFilterSection.style.display = 'block';
        loadPropertyCheckboxes();
    } else {
        propertyFilterSection.style.display = 'none';
    }
}

// Load property checkboxes dynamically
function loadPropertyCheckboxes() {
    const container = document.getElementById('propertyCheckboxes');
    container.innerHTML = '';

    lodgeProperties.forEach(property => {
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-4';
        col.innerHTML = `
            <div class="form-check">
                <input class="form-check-input property-checkbox" type="checkbox" value="${property.id}" id="property_${property.id}">
                <label class="form-check-label" for="property_${property.id}">
                    <strong>${property.title}</strong><br>
                    <small class="text-muted">${property.address}</small>
                </label>
            </div>
        `;
        container.appendChild(col);
    });
}

// Toggle all properties checkbox
function toggleAllProperties() {
    const selectAll = document.getElementById('selectAllProperties');
    const checkboxes = document.querySelectorAll('.property-checkbox');

    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

// Reset form
function resetForm() {
    document.getElementById('reportForm').reset();
    document.getElementById('customDateRange').style.display = 'none';
    document.getElementById('customDateRangeEnd').style.display = 'none';
    document.getElementById('propertyFilterSection').style.display = 'none';
    document.getElementById('startDate').required = false;
    document.getElementById('endDate').required = false;
}

// Generate report function
function generateReport(event) {
    event.preventDefault();

    const reportType = document.getElementById('reportType').value;
    const dateRangeType = document.getElementById('dateRangeType').value;
    const propertySelection = document.getElementById('propertySelection').value;
    const format = document.getElementById('format').value || 'excel';

    // Validation
    if (!reportType || !dateRangeType) {
        alert('Please select report type and date range');
        return;
    }

    // Handle custom date range
    let dateRange = dateRangeType;
    if (dateRangeType === 'custom') {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        if (!startDate || !endDate) {
            alert('Please select start and end dates for custom range');
            return;
        }

        if (new Date(startDate) > new Date(endDate)) {
            alert('Start date cannot be after end date');
            return;
        }

        dateRange = `custom_${startDate}_${endDate}`;
    }

    // Handle property selection
    let properties = 'all';
    if (propertySelection === 'selected') {
        const selectedProperties = Array.from(document.querySelectorAll('.property-checkbox:checked'))
            .map(checkbox => checkbox.value);

        if (selectedProperties.length === 0) {
            alert('Please select at least one property');
            return;
        }

        properties = selectedProperties.join(',');
    } else if (propertySelection === 'available') {
        properties = 'available';
    } else if (propertySelection === 'occupied') {
        properties = 'occupied';
    }

    // Show loading indicator
    const button = event.target.querySelector('button[type="submit"]') || event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
    button.disabled = true;

    // Create download URL with parameters
    const params = new URLSearchParams({
        type: reportType,
        range: dateRange,
        properties: properties,
        format: format
    });

    // Create download link
    const downloadUrl = `/properties/lodge/reports/export/?${params}`;

    // Create temporary link element for download
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = `lodge_${reportType}_report_${dateRangeType}.xlsx`;
    link.style.display = 'none';

    // Add to DOM, click, and remove
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    // Reset button after a short delay
    setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;

        // Show success message
        alert(`Report exported successfully! Type: ${reportType}, Range: ${dateRangeType}, Format: ${format}`);
    }, 1000);
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Lodge Reports page loaded');
    console.log('Available properties:', lodgeProperties.length);
});
</script>
{% endblock %}